
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Digital India Management School Dashboard</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2980b9;
            --primary-light: #3498db;
            --primary-gradient: linear-gradient(45deg, #2980b9, #3498db);
            --secondary-color: #34495e;
            --background-color: #2c3e50;
            --sidebar-bg: #34495e;
            --text-color: #ecf0f1;
            --text-muted: #bdc3c7;
            --border-color: #46627f;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --font-family: 'Roboto', 'Segoe UI', sans-serif;
            --sidebar-width: 260px;
            --glow-color: rgba(52, 152, 219, 0.4); 
            --glow-color-hover: rgba(52, 152, 219, 0.6);
        }

        body.light-theme {
            --secondary-color: #f0f2f5;
            --background-color: #ffffff;
            --sidebar-bg: #ffffff;
            --text-color: #2c3e50;
            --text-muted: #5a6a7a;
            --border-color: #e0e0e0;
        }

        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
            transition: background-color 0.3s, color 0.3s;
        }

        body.font-weight-light { font-weight: 300; }
        body.font-weight-normal { font-weight: 400; }
        body.font-weight-bold { font-weight: 500; }
        body.font-weight-bold h1, body.font-weight-bold h2, body.font-weight-bold h3 { font-weight: 700; }

        .app-container { display: flex; width: 100%; height: 100vh; }
        #sidebar {
            width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100%;
            display: flex; flex-direction: column; transition: margin-left 0.3s ease, background-color 0.3s;
            z-index: 200; border-right: 1px solid var(--border-color); flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px; text-align: center; border-bottom: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .sidebar-header .admin-photo {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 3px solid var(--primary-light); box-shadow: 0 0 15px var(--glow-color);
        }
        
        .new-dims-logo {
            width: 100px;
            height: 100px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .new-dims-logo .ring {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px dashed var(--primary-color);
            border-top-color: var(--primary-light);
            animation: spin 8s linear infinite, glow 2s ease-in-out infinite alternate;
            position: absolute;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 10px -5px var(--glow-color), 0 0 20px -10px var(--glow-color); }
            to { box-shadow: 0 0 20px 0px var(--glow-color), 0 0 40px -5px var(--glow-color); }
        }

        .new-dims-logo .logo-text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-light);
            text-shadow: 0 0 8px var(--glow-color);
        }


        .sidebar-header h2 { font-size: 22px; font-weight: 700; color: var(--text-color); }
        .sidebar-nav { flex-grow: 1; list-style: none; padding: 20px 0; overflow-y: auto; }

        .sidebar-nav-item a {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 25px; color: var(--text-muted); text-decoration: none;
            font-weight: 500; border-left: 4px solid transparent; transition: all 0.2s ease; cursor: pointer;
        }
        .sidebar-nav-item>a:hover { background-color: var(--background-color); color: var(--primary-light); }
        .sidebar-nav-item>a.active {
            background-color: var(--background-color); color: var(--primary-light);
            border-left-color: var(--primary-light); font-weight: 700;
            box-shadow: inset 5px 0 15px -10px var(--glow-color);
        }
        .sidebar-nav-item .nav-link-content { display: flex; align-items: center; }
        .sidebar-nav-item i { margin-right: 18px; width: 22px; text-align: center; font-size: 1.1rem; }
        .sidebar-nav-item .arrow { transition: transform 0.3s; }
        .sidebar-nav-item.open>a .arrow { transform: rotate(90deg); }
        .sidebar-submenu { list-style: none; padding-left: 0; background-color: rgba(0, 0, 0, 0.1); max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .sidebar-nav-item.open .sidebar-submenu { max-height: 500px; }
        .sidebar-submenu a { padding-left: 55px !important; font-size: 0.95rem; }

        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border-color); }
        .logout-button {
            width: 100%; background: var(--error-color); color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: 500; cursor: pointer; transition: opacity 0.2s, box-shadow 0.3s;
        }
        .logout-button:hover { opacity: 0.9; box-shadow: 0 0 15px var(--error-color); }
        .social-media-links { text-align: center; padding-top: 15px; display: flex; justify-content: center; gap: 20px; }
        .social-media-links a { color: var(--text-muted); font-size: 1.2rem; text-decoration: none; transition: color 0.3s, transform 0.3s; }
        .social-media-links a:hover { color: var(--primary-light); transform: translateY(-3px) scale(1.1); }
        .app-container.sidebar-collapsed #sidebar { margin-left: calc(-1 * var(--sidebar-width)); }

        .main-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }
        #main-content { flex-grow: 1; padding: 25px; transition: margin-left 0.3s ease; }
        #main-footer { flex-shrink: 0; background-color: var(--sidebar-bg); padding: 20px; border-top: 1px solid var(--border-color); transition: background-color 0.3s, color 0.3s; }
        .footer-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .footer-contact p { margin: 0 0 5px 0; }
        .footer-contact i { margin-right: 10px; color: var(--primary-light); }
        .footer-map iframe { border-radius: 8px; border: 1px solid var(--border-color); }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center;
            z-index: 10001; backdrop-filter: blur(5px);
        }
        .loader {
            border: 8px solid var(--secondary-color); border-top: 8px solid var(--primary-light);
            border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-left { display: flex; align-items: center; gap: 15px; overflow: hidden; flex-grow: 1;}
        .header-actions { display: flex; align-items: center; gap: 15px; flex-shrink: 0;}
        .header-left .menu-toggle { background: none; border: none; color: var(--text-color); font-size: 24px; cursor: pointer; flex-shrink: 0; }
        .header-title-container { overflow: hidden; white-space: nowrap; flex-grow: 1;}
        .moving-title { font-size: 24px; font-weight: 700; display: inline-block; animation: marquee 20s linear infinite; padding-left: 100%; color: var(--primary-light); text-shadow: 0 0 10px var(--glow-color); }
        #real-time-clock { font-size: 1rem; font-weight: 500; color: var(--primary-light); background: transparent; border: 1px solid var(--border-color); padding: 8px 15px; border-radius: 6px; text-shadow: 0 0 5px var(--glow-color); }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .card {
            background-color: var(--sidebar-bg); padding: 25px; border-radius: 12px;
            margin-bottom: 25px; transition: all 0.3s ease; border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 0 15px -5px var(--glow-color);
        }
        .card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 0 25px var(--glow-color-hover); transform: translateY(-2px); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .card-header h3 { font-size: 20px; font-weight: 600; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background-color: var(--sidebar-bg); padding: 20px; border-radius: 12px; text-align: center;
            border: 1px solid var(--border-color); transition: all 0.3s; box-shadow: 0 0 10px -4px var(--glow-color);
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 0 15px var(--glow-color-hover); }
        .stat-card h3 { font-size: 2.5rem; color: var(--primary-light); margin: 10px 0; }
        .stat-card p { font-size: 1rem; color: var(--text-muted); }
        .stat-card i { font-size: 2rem; color: var(--text-muted); }
        
        .quick-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .quick-action-btn {
            background: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .quick-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px var(--glow-color);
        }
        .quick-action-btn i { font-size: 1.8rem; display: block; margin-bottom: 10px; }


        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px); z-index: 1000; display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--sidebar-bg); padding: 30px; border-radius: 12px; width: 90%; max-width: 600px;
            border: 1px solid var(--primary-light); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), 0 0 25px var(--glow-color);
        }
        .modal-content .modal-body { max-height: 80vh; overflow-y: auto; padding-right: 15px; margin-right: -15px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .close-btn { background: none; border: none; color: var(--text-muted); font-size: 28px; cursor: pointer; }

        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-muted); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; background: var(--background-color); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 12px; border-radius: 6px; font-size: 1rem;
            transition: box-shadow 0.3s, border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary-light); box-shadow: 0 0 8px var(--glow-color);
        }
        
        .form-feedback { margin-bottom: 15px; padding: 10px; border-radius: 6px; font-weight: 500; display: none; text-align: center;}
        .form-feedback.success { background-color: var(--success-color); color: white; display: block; }
        .form-feedback.error { background-color: var(--error-color); color: white; display: block; }

        .action-button {
            background-image: var(--primary-gradient); color: white; border: none; padding: 12px 25px;
            border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 500;
            text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3), 0 0 15px var(--glow-color-hover); }
        .action-button.inline { width: auto; }
        .action-button.secondary {
            background-image: none;
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            box-shadow: none;
        }
        .action-button.secondary:hover {
            background-color: var(--primary-light);
            color: white;
            box-shadow: 0 0 15px var(--glow-color-hover);
        }

        .auth-link { color: var(--primary-light); text-decoration: none; font-size: 0.9rem; margin-top: 15px; display: inline-block; }
        .auth-link:hover { text-decoration: underline; }
        
        .search-box-container { position: relative; width: 100%; margin-bottom: 20px; }
        .search-box-container .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 1rem; transition: color 0.3s; }
        .search-box-container .search-input { width: 100%; padding: 14px 20px 14px 50px; border-radius: 30px; background-color: var(--secondary-color); border: 1px solid var(--border-color); color: var(--text-color); font-size: 1rem; transition: all 0.3s ease; }
        .search-box-container .search-input:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 10px var(--glow-color); background-color: var(--background-color); }
        .search-box-container:focus-within .search-icon { color: var(--primary-light); }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle;}
        thead { background-color: var(--secondary-color); }
        .table-photo { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); }

        .action-buttons button, .action-buttons a { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; margin: 0 8px; transition: color 0.2s, text-shadow 0.3s; text-decoration: none; }
        .action-buttons .view-btn:hover { color: var(--info-color); text-shadow: 0 0 10px var(--info-color);}
        .action-buttons .edit-btn:hover { color: var(--warning-color); text-shadow: 0 0 10px var(--warning-color); }
        .action-buttons .delete-btn:hover { color: var(--error-color); text-shadow: 0 0 10px var(--error-color); }
        .action-buttons .download-btn:hover, .action-buttons .link-btn:hover, .action-buttons .certificate-btn:hover { color: var(--success-color); text-shadow: 0 0 10px var(--success-color); }
        .action-buttons .schedule-btn:hover { color: var(--purple-light, #9b59b6); text-shadow: 0 0 10px var(--purple-light, #9b59b6); }

        .profile-grid { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        .profile-card .profile-photo { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin: 0 auto 20px; display: block; border: 4px solid var(--primary-light); box-shadow: 0 0 20px var(--glow-color); }
        .profile-details li { display: flex; align-items: center; margin-bottom: 15px; font-size: 0.95rem; list-style: none; }
        .profile-details i { color: var(--primary-light); margin-right: 15px; width: 20px; text-align: center; }

        .detail-list { list-style: none; padding: 0; }
        .detail-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .detail-list li.clickable:hover { background-color: var(--background-color); cursor: pointer;}


        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10002; }
        .toast {
            padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); margin-top: 10px; width: 350px;
            opacity: 0; transform: translateX(100%); animation: slideInToast 0.5s forwards, fadeOutToast 0.5s 4.5s forwards;
            border-left: 5px solid rgba(0,0,0,0.2);
        }
        @keyframes slideInToast { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOutToast { to { opacity: 0; transform: translateX(100%); } }
        .toast.success { background-color: var(--success-color); box-shadow: 0 0 12px var(--success-color); }
        .toast.error { background-color: var(--error-color); box-shadow: 0 0 12px var(--error-color); }
        .toast.info { background-color: var(--info-color); box-shadow: 0 0 12px var(--info-color); }
        
        .gallery-grid, .videos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .gallery-item, .video-item { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; text-align: center; background: var(--secondary-color); }
        .gallery-item img, .video-item iframe { width: 100%; height: 200px; object-fit: cover; display: block; border: none; }
        .gallery-item-footer, .video-item-footer { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .view-switcher .action-button { background: var(--secondary-color); box-shadow: none; }
        .view-switcher .action-button.active { background-image: var(--primary-gradient); box-shadow: 0 4px 15px rgba(0,0,0,0.2), 0 0 15px var(--glow-color-hover); }

        .attendance-report-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .attendance-card { padding: 20px; text-align: center; }
        .attendance-card .profile-photo-small { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-light); box-shadow: 0 0 15px var(--glow-color); margin-bottom: 10px; }
        .attendance-card h4 { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
        .attendance-card .admission-no { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px; }
        .attendance-stats { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .home-attendance-summary .attendance-stats { justify-content: center; gap: 30px; }
        .attendance-stats .stat-item { display: flex; flex-direction: column; align-items: center; }
        .attendance-stats .stat-item .count { font-size: 2rem; font-weight: 700; }
        .attendance-stats .stat-item.present .count { color: var(--success-color); }
        .attendance-stats .stat-item.absent .count { color: var(--error-color); }
        .attendance-bar-container { width: 100%; height: 10px; background-color: var(--secondary-color); border-radius: 5px; overflow: hidden; margin-bottom: 8px; }
        .attendance-bar { height: 100%; background-color: var(--success-color); border-radius: 5px; transition: width 0.5s ease-in-out; }
        
        .notice-board { max-height: 300px; overflow-y: auto; }
        .notice-item { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .notice-item:last-child { border-bottom: none; }
        .notice-item h4 { font-size: 1.1rem; margin-bottom: 5px; color: var(--primary-light); }
        .notice-item p { font-size: 0.95rem; color: var(--text-muted); margin-bottom: 8px; }
        .notice-item .notice-date { font-size: 0.8rem; color: var(--text-muted); opacity: 0.7; }

        .attendance-card .percentage { font-weight: 500; color: var(--primary-light); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .receipt-container { background-color: var(--background-color); color: var(--text-color); padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; }
        .receipt-header { text-align: center; border-bottom: 2px solid var(--primary-light); padding-bottom: 15px; margin-bottom: 20px; }
        .receipt-header h2 { margin-bottom: 5px; color: var(--primary-light); }
        .receipt-student-photo { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 3px solid var(--primary-light); }
        .receipt-details-grid { display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; }
        .receipt-details-grid dt { font-weight: bold; color: var(--text-muted); }
        .receipt-footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; font-size: 0.9rem; color: var(--text-muted); }
        .receipt-signature { margin-top: 50px; text-align: right; padding-right: 20px; }
        .receipt-signature-line { width: 200px; border-bottom: 1px solid var(--text-color); display: inline-block; margin-bottom: 5px; }

        #qr-scanner-container { width: 100%; max-width: 500px; margin: 20px auto; border: 1px solid var(--border-color); border-radius: 8px; }
        #qr-scan-result { text-align: center; margin-top: 20px; padding: 15px; border-radius: 8px; }
        #qr-scan-result.success { background-color: var(--success-color); color: white; }
        #qr-scan-result.error { background-color: var(--error-color); color: white; }
        #student-qr-code { padding: 20px; background: white; display: inline-block; border-radius: 8px; margin-top: 15px; }
        
        .id-card {
            width: 320px; border: 1px solid var(--border-color); border-radius: 15px;
            padding: 20px; font-family: sans-serif; margin: auto;
            background: var(--sidebar-bg);
        }
        .id-card-header { text-align: center; border-bottom: 2px solid var(--primary-light); padding-bottom: 10px; margin-bottom: 15px; }
        .id-card-header h3 { color: var(--primary-light); margin: 0; }
        .id-card-photo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 0 auto; display: block; border: 3px solid var(--primary-light); }
        .id-card-body { text-align: center; }
        .id-card-body h4 { margin-top: 15px; margin-bottom: 5px; font-size: 1.2rem; color: var(--text-color); }
        .id-card-body p { margin: 4px 0; color: var(--text-muted); font-size: 0.9rem; }
        .id-card-qr { margin-top: 15px; }
        .id-card-qr canvas, .id-card-qr img { margin: auto; }
        
        #fingerprint-status, #fingerprint-scan-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
            text-align: center;
        }
        
        .certificate-container {
            width: 800px;
            padding: 40px;
            border: 10px solid var(--primary-color);
            background: var(--background-color);
            position: relative;
            font-family: 'Times New Roman', serif;
        }
        .certificate-container::before {
            content: ''; position: absolute;
            top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 2px solid var(--primary-light);
            box-shadow: 0 0 15px var(--glow-color) inset;
        }
        .certificate-header { text-align: center; margin-bottom: 20px; }
        .certificate-header h1 { font-size: 2.8rem; color: var(--primary-light); font-weight: bold; }
        .certificate-header h2 { font-size: 1.5rem; color: var(--text-color); font-weight: normal; margin-top: -10px;}
        .certificate-student-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 4px solid var(--primary-light);
            margin: 0 auto 25px auto;
            display: block;
            box-shadow: 0 0 15px var(--glow-color);
        }
        .certificate-body { text-align: center; }
        .certificate-body p { font-size: 1.2rem; margin: 20px 0; color: var(--text-muted); }
        .certificate-body .student-name { font-size: 2.2rem; font-weight: bold; color: var(--text-color); border-bottom: 2px solid var(--border-color); display: inline-block; padding-bottom: 5px; margin-bottom: 15px; }
        .certificate-body .class-name { font-weight: bold; color: var(--primary-light); }
        .certificate-footer { display: flex; justify-content: space-between; margin-top: 60px; }
        .signature-block { text-align: center; }
        .signature-block .signature-line { border-top: 1px solid var(--text-color); width: 200px; margin-top: 40px; margin-bottom: 5px;}
        
        #student-lookup-results, #topper-lookup-results { max-height: 250px; overflow-y: auto; margin-top: 15px; }
        .lookup-result-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 10px; background: var(--secondary-color); border: 1px solid var(--border-color); }
        .lookup-result-item:hover { background: var(--background-color); }
        .lookup-result-item img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
        
        .recent-students-scroller {
            height: 300px;
            overflow: hidden;
            position: relative;
        }
        .recent-students-scroller .scroller-inner {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            width: 100%;
            animation: scroll-up 20s linear infinite;
        }
        .recent-students-scroller:hover .scroller-inner {
            animation-play-state: paused;
        }
        @keyframes scroll-up {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-50%);
            }
        }
        .recent-students-scroller .lookup-result-item {
            cursor: pointer;
        }


        .monthly-attendance-table th, .monthly-attendance-table td {
            min-width: 40px;
            text-align: center;
            padding: 8px;
        }
        .monthly-attendance-table .sticky-col {
            position: sticky;
            left: 0;
            background-color: var(--sidebar-bg);
            z-index: 10;
            text-align: left;
            min-width: 150px;
        }
        .monthly-attendance-table .present-cell { color: var(--success-color); font-weight: bold; }
        .monthly-attendance-table .absent-cell { color: var(--error-color); font-weight: bold; }
        .monthly-attendance-table .weekend-cell { background-color: rgba(0,0,0,0.2); }
        
        .marksheet-container {
            width: 100%;
            max-width: 850px;
            border: 2px solid var(--primary-color);
            padding: 25px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            margin: auto;
        }
        .marksheet-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .marksheet-header h2 { font-size: 2rem; color: var(--primary-light); }
        .marksheet-header h3 { font-size: 1.2rem; font-weight: 500; }
        .marksheet-header h4 { font-size: 1.4rem; font-weight: 600; margin-top: 10px; }
        
        .marksheet-student-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .marksheet-student-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 20px;
        }
        .marksheet-student-details p { margin: 0; }
        .marksheet-student-details strong { color: var(--text-muted); }
        .marksheet-student-photo {
            width: 120px;
            height: 140px;
            object-fit: cover;
            border: 3px solid var(--border-color);
            border-radius: 8px;
        }

        .marksheet-table {
            font-size: 0.95rem;
        }
        .marksheet-table th, .marksheet-table td {
            text-align: center;
            padding: 10px 8px;
        }
        .marksheet-table th:first-child, .marksheet-table td:first-child {
            text-align: left;
        }
        
        .marksheet-summary-grid {
            margin-top: 25px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            text-align: center;
        }
        .marksheet-summary-item strong {
            display: block;
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        .marksheet-summary-item span {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
        }
        .marksheet-summary-item span.fail {
            color: var(--error-color);
        }
        .marksheet-summary-item span.pass {
            color: var(--success-color);
        }
        .marksheet-footer {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .marksheet-footer p { font-size: 0.9rem; }
        
        .payment-gateway-card {
            text-align: center;
        }
        .payment-gateway-card .upi-info {
            background: var(--background-color);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin: 20px 0;
        }
         .payment-gateway-card .upi-info p {
            margin: 5px 0;
         }
        .payment-gateway-card .upi-id {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-light);
            user-select: all;
        }
        .payment-gateway-card .upi-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
         .payment-gateway-card .upi-button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
         }
         .payment-gateway-card .upi-button img {
            width: 24px;
            height: 24px;
         }

        .school-photos-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .school-photo-item {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .school-photo-item img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }
        .school-photo-item .photo-title {
            padding: 15px;
            font-weight: 500;
        }
        
        #result-upload-marks-table input {
            width: 80px;
            text-align: center;
            padding: 8px;
        }
        #result-upload-summary {
            margin-top: 20px;
            padding: 15px;
            background: var(--secondary-color);
            border-radius: 8px;
            text-align: center;
        }

         @media (max-width: 992px) {
            .profile-grid { grid-template-columns: 1fr; }
            #main-content { padding: 15px; }
            .footer-content { flex-direction: column; text-align: center; }
         }
        @media (max-width: 768px) {
             #sidebar { position: fixed; height: 100%; left: calc(-1 * var(--sidebar-width)); transition: left 0.3s ease; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
             .app-container.sidebar-collapsed #sidebar { margin-left: 0; }
             body:not(.sidebar-open) .app-container.sidebar-collapsed #sidebar { left: calc(-1 * var(--sidebar-width)); }
             body.sidebar-open #sidebar { left: 0; }
             .header-title-container { display: none; }
             .form-grid { grid-template-columns: 1fr; }
             .marksheet-student-info { flex-direction: column; align-items: center; text-align: center; gap: 20px; }
        }
        
        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                background-color: #ffffff !important;
                color: #000000 !important;
            }

            body > *:not(.printable-content) {
                display: none !important;
            }

            .printable-content {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }

            .card, .profile-grid, .marksheet-container, .id-card, .certificate-container, .admit-card-container {
                page-break-inside: avoid !important;
            }
            
            .printable-content .receipt-container,
            .printable-content .id-card,
            .printable-content .certificate-container,
            .printable-content .marksheet-container,
            .printable-content .admit-card-container,
            .printable-content .profile-grid,
            .printable-area.attendance-report .monthly-attendance-table {
                background: #ffffff !important;
                color: #000000 !important;
                box-shadow: none !important;
                border: 2px solid black !important;
            }
            .printable-content * {
                color: #000000 !important;
                background-color: transparent !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            .printable-content .action-button,
            .printable-content .no-print {
                display: none !important;
            }
            
            .printable-area.attendance-report .table-container {
                overflow: visible !important;
            }
            .printable-area.attendance-report .monthly-attendance-table {
                font-size: 10px;
                width: 100%;
                table-layout: fixed;
            }
            .printable-area.attendance-report .monthly-attendance-table th,
            .printable-area.attendance-report .monthly-attendance-table td {
                padding: 4px !important;
                overflow-wrap: break-word;
                border: 1px solid #ccc !important;
            }
            .printable-area.attendance-report .monthly-attendance-table .sticky-col {
                position: static !important;
                background-color: #f2f2f2 !important;
                font-weight: bold;
            }
            .printable-area.attendance-report .weekend-cell {
                 background-color: #e0e0e0 !important;
            }
             .printable-area.attendance-report .present-cell {
                background-color: #c8e6c9 !important; /* Light Green */
            }
            .printable-area.attendance-report .absent-cell {
                background-color: #ffcdd2 !important; /* Light Red */
            }

            @page {
                size: A4; 
                margin: 0.7cm;
            }
            .printable-content .admit-card-container, .printable-content .marksheet-container {
                 page-break-before: always;
            }
            .multi-page-print-container > div {
                page-break-after: always;
            }
            .multi-page-print-container > div:last-child {
                page-break-after: auto;
            }
        }

    </style>
</head>
<body>
    <div class="original-content">
        <div id="loading-overlay" style="display: none;"><div class="loader"></div></div>

        <div class="app-container" id="app-container">
            <aside id="sidebar"></aside>
            <div class="main-wrapper" id="main-wrapper">
                <main id="main-content"></main>
                <footer id="main-footer" class="no-print"></footer>
            </div>
        </div>

        <div id="modal-container"></div>
        <div id="toast-container"></div>
    </div>
    <div class="printable-content" style="display: none;"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const getEl = (id) => document.getElementById(id);
            let html5QrCode = null;

            let state = {
                loggedInUser: null,
                data: {},
                currentPage: 'home',
                currentView: 'list',
                currentItemId: null,
                studentListFilter: null,
                pendingAdmissionData: null,
            };
            
            const config = {
                pages: {
                    home: { title: 'Admin Dashboard', icon: 'fa-home', renderer: renderHomePage, roles: ['admin', 'guest'] },
                    
                    publicProfile: { title: 'Find Profile', icon: 'fa-search', renderer: renderPublicProfileSearchPage, roles: ['guest'] },

                    studentDashboard: { title: 'Dashboard', icon: 'fa-home', renderer: renderStudentDashboardPage, roles: ['student', 'parent'] },
                    studentProfile: { title: 'My Profile', icon: 'fa-user-circle', renderer: renderStudentProfileView, roles: ['student', 'parent'] },
                    studentAttendance: { title: 'My Attendance', icon: 'fa-calendar-check', renderer: renderStudentAttendanceView, roles: ['student', 'parent'] },
                    studentHomework: { title: 'Homework', icon: 'fa-book-open', renderer: renderStudentHomeworkView, roles: ['student', 'parent'] },

                    teacherDashboard: { title: 'Dashboard', icon: 'fa-home', renderer: renderTeacherDashboardPage, roles: ['teacher'] },

                    admission: { title: 'Admission', icon: 'fa-user-plus', renderer: renderAdmissionPage, roles: ['admin', 'guest'] },
                    students: { title: 'Students', icon: 'fa-user-graduate', roles: ['admin'], subPages: {
                        studentList: { title: 'Student List', icon: 'fa-users', renderer: renderStudentPage, roles: ['admin'] },
                        promoteStudents: { title: 'Promote Students', icon: 'fa-arrow-up', renderer: renderPromoteStudentsPage, roles: ['admin'] },
                    }},
                    teachers: { title: 'Teachers', icon: 'fa-chalkboard-teacher', roles: ['admin'], subPages: {
                        teacherList: { title: 'Teacher List', icon: 'fa-users-cog', renderer: renderTeacherPage, roles: ['admin'] },
                        teacherAttendance: { title: 'Teacher Attendance', icon: 'fa-user-check', renderer: renderTeacherAttendancePage, roles: ['admin'] },
                    }},
                    staff: { title: 'Staff', icon: 'fa-user-friends', roles: ['admin'], subPages: {
                        staffList: { title: 'Staff List', icon: 'fa-users', renderer: renderStaffPage, roles: ['admin'] },
                        staffAttendance: { title: 'Staff Attendance', icon: 'fa-user-check', renderer: renderStaffAttendancePage, roles: ['admin'] },
                    }},
                    academics: { title: 'Academics', icon: 'fa-university', roles: ['admin'], subPages: {
                        homework: { title: 'Homework', icon: 'fa-book-open', renderer: renderHomeworkPage, roles: ['admin'] },
                        timetable: { title: 'Timetable', icon: 'fa-calendar-alt', renderer: renderTimetablePage, roles: ['admin'] },
                        exams: { title: 'Exams', icon: 'fa-file-signature', renderer: renderExamsPage, roles: ['admin'] },
                        marksheetManager: { title: 'Marksheet Manager', icon: 'fa-marker', renderer: renderMarksheetManagerPage, roles: ['admin'] },
                    }},
                    adminStudentAttendance: { title: 'Student Attendance', icon: 'fa-calendar-check', renderer: setupAttendancePage, roles: ['admin', 'teacher'] },
                    financials: { title: 'Financials', icon: 'fa-wallet', roles: ['admin'], subPages: {
                        income: { title: 'Income', icon: 'fa-dollar-sign', renderer: renderFinancialsPage, roles: ['admin']},
                        expenses: { title: 'Expenses', icon: 'fa-file-invoice-dollar', renderer: renderExpensesPage, roles: ['admin']},
                    }},
                    events: { title: 'Events', icon: 'fa-calendar-star', renderer: renderEventsPage, roles: ['admin'] },
                    library: { title: 'Library', icon: 'fa-book', roles: ['admin'], subPages: {
                        bookList: { title: 'Book List', icon: 'fa-book-bookmark', renderer: renderBookListPage, roles: ['admin'] },
                        issueReturn: { title: 'Issue / Return', icon: 'fa-right-left', renderer: renderIssueReturnPage, roles: ['admin'] }
                    }},
                    noticeBoard: { title: 'Notice Board', icon: 'fa-bullhorn', renderer: renderNoticeBoardPage, roles: ['admin', 'guest', 'student', 'parent', 'teacher'] },
                    admitCardPortal: { title: 'Admit Card', icon: 'fa-id-card', renderer: renderAdmitCardPortalPage, roles: ['admin', 'guest', 'student', 'parent', 'teacher'] },
                    resultPortal: { title: 'Result Portal', icon: 'fa-award', renderer: renderResultPortalPage, roles: ['admin', 'guest', 'student', 'parent', 'teacher'] },
                    certificates: { title: 'Certificates', icon: 'fa-certificate', renderer: renderCertificatePage, roles: ['admin'] },
                    media: { title: 'Media', icon: 'fa-photo-video', roles: ['admin', 'guest'], subPages: {
                        gallery: { title: 'Photo Gallery', icon: 'fa-images', renderer: renderGalleryPage, roles: ['admin', 'guest'] },
                        videos: { title: 'Video Gallery', icon: 'fa-video', renderer: renderVideosPage, roles: ['admin', 'guest'] },
                    }},
                    inquiries: { title: 'Inquiries', icon: 'fa-question-circle', renderer: renderInquiriesPage, roles: ['admin', 'guest'] },
                    adminNotes: { title: 'Admin Notes', icon: 'fa-sticky-note', renderer: renderNotesPage, roles: ['admin'] },
                    settings: {
                        title: 'Settings',
                        icon: 'fa-cog',
                        roles: ['admin'],
                        subPages: {
                            account: { title: 'User Account', icon: 'fa-user-circle', renderer: renderAccountSettingsPage, roles: ['admin'] },
                            appearance: { title: 'Appearance', icon: 'fa-paint-brush', renderer: renderAppearanceSettingsPage, roles: ['admin'] },
                            schoolInfo: { title: 'School Info', icon: 'fa-school', renderer: renderSchoolInfoSettingsPage, roles: ['admin'] },
                            content: { title: 'Site Content', icon: 'fa-file-alt', renderer: renderContentSettingsPage, roles: ['admin'] },
                            schoolPhotos: { title: 'School Photos', icon: 'fa-image', renderer: renderSchoolPhotosSettingsPage, roles: ['admin'] },
                            uploadResult: { title: 'Upload Result', icon: 'fa-file-upload', renderer: renderUploadResultPage, roles: ['admin'] }, 
                            setTopper: { title: 'Set Toppers', icon: 'fa-crown', renderer: renderSetTopperPage, roles: ['admin'] }, 
                            manageLinks: { title: 'Manage Links', icon: 'fa-link', renderer: renderManageLinksPage, roles: ['admin'] },
                            data: { title: 'Data Management', icon: 'fa-database', renderer: renderDataSettingsPage, roles: ['admin'] },
                        }
                    },
                },
                 accentColors: {
                    blue: { primary: '#2980b9', light: '#3498db' },
                    teal: { primary: '#16a085', light: '#1abc9c' },
                    purple: { primary: '#8e44ad', light: '#9b59b6' },
                    green: { primary: '#27ae60', light: '#2ecc71' },
                    orange: { primary: '#d35400', light: '#e67e22' },
                    red: { primary: '#c0392b', light: '#e74c3c' },
                }
            };
            
            const indianStatesData = { "Andaman and Nicobar Islands": ["Nicobar", "North and Middle Andaman", "South Andaman"], "Andhra Pradesh": ["Anantapur", "Chittoor", "East Godavari", "Guntur", "Krishna", "Kurnool", "Prakasam", "Srikakulam", "Sri Potti Sriramulu Nellore", "Visakhapatnam", "Vizianagaram", "West Godavari", "Y.S.R. Kadapa"], "Arunachal Pradesh": ["Anjaw", "Changlang", "Dibang Valley", "East Kameng", "East Siang", "Kamle", "Kra Daadi", "Kurung Kumey", "Lepa Rada", "Lohit", "Longding", "Lower Dibang Valley", "Lower Siang", "Lower Subansiri", "Namsai", "Pakke Kessang", "Papum Pare", "Shi Yomi", "Siang", "Tawang", "Tirap", "Upper Siang", "Upper Subansiri", "West Kameng", "West Siang"], "Assam": ["Baksa", "Barpeta", "Biswanath", "Bongaigaon", "Cachar", "Charaideo", "Chirang", "Darrang", "Dhemaji", "Dhubri", "Dibrugarh", "Dima Hasao", "Goalpara", "Golaghat", "Hailakandi", "Hojai", "Jorhat", "Kamrup", "Kamrup Metropolitan", "Karbi Anglong", "Karimganj", "Kokrajhar", "Lakhimpur", "Majuli", "Morigaon", "Nagaon", "Nalbari", "Sivasagar", "Sonitpur", "South Salmara-Mankachar", "Tinsukia", "Udalguri", "West Karbi Anglong"], "Bihar": ["Araria", "Arwal", "Aurangabad", "Banka", "Begusarai", "Bhagalpur", "Bhojpur", "Buxar", "Darbhanga", "East Champaran", "Gaya", "Gopalganj", "Jamui", "Jehanabad", "Kaimur", "Katihar", "Khagaria", "Kishanganj", "Lakhisarai", "Madhepura", "Madhubani", "Munger", "Muzaffarpur", "Nalanda", "Nawada", "Patna", "Purnia", "Rohtas", "Saharsa", "Samastipur", "Saran", "Sheikhpura", "Sheohar", "Sitamarhi", "Siwan", "Supaul", "Vaishali", "West Champaran"], "Chandigarh": ["Chandigarh"], "Chhattisgarh": ["Balod", "Baloda Bazar", "Balrampur", "Bastar", "Bemetara", "Bijapur", "Bilaspur", "Dantewada", "Dhamtari", "Durg", "Gariaband", "Gaurela Pendra Marwahi", "Janjgir-Champa", "Jashpur", "Kabirdham", "Kanker", "Kondagaon", "Korba", "Koriya", "Mahasamund", "Mungeli", "Narayanpur", "Raigarh", "Raipur", "Rajnandgaon", "Sukma", "Surajpur", "Surguja"], "Dadra and Nagar Haveli and Daman and Diu": ["Daman", "Diu", "Dadra and Nagar Haveli"], "Delhi": ["Central Delhi", "East Delhi", "New Delhi", "North Delhi", "North East Delhi", "North West Delhi", "Shahdara", "South Delhi", "South East Delhi", "South West Delhi", "West Delhi"], "Goa": ["North Goa", "South Goa"], "Gujarat": ["Ahmedabad", "Amreli", "Anand", "Aravalli", "Banaskantha", "Bharuch", "Bhavnagar", "Botad", "Chhota Udaipur", "Dahod", "Dang", "Devbhoomi Dwarka", "Gandhinagar", "Gir Somnath", "Jamnagar", "Junagadh", "Kheda", "Kutch", "Mahisagar", "Mehsana", "Morbi", "Narmada", "Navsari", "Panchmahal", "Patan", "Porbandar", "Rajkot", "Sabarkantha", "Surat", "Surendranagar", "Tapi", "Vadodara", "Valsad"], "Haryana": ["Ambala", "Bhiwani", "Charkhi Dadri", "Faridabad", "Fatehabad", "Gurugram", "Hisar", "Jhajjar", "Jind", "Kaithal", "Karnal", "Kurukshetra", "Mahendragarh", "Nuh", "Palwal", "Panchkula", "Panipat", "Rewari", "Rohtak", "Sirsa", "Sonipat", "Yamunanagar"], "Himachal Pradesh": ["Bilaspur", "Chamba", "Hamirpur", "Kangra", "Kinnaur", "Kullu", "Lahaul and Spiti", "Mandi", "Shimla", "Sirmaur", "Solan", "Una"], "Jammu and Kashmir": ["Anantnag", "Bandipora", "Baramulla", "Budgam", "Doda", "Ganderbal", "Jammu", "Kathua", "Kishtwar", "Kulgam", "Kupwara", "Poonch", "Pulwama", "Rajouri", "Ramban", "Reasi", "Samba", "Shopian", "Srinagar", "Udhampur"], "Jharkhand": ["Bokaro", "Chatra", "Deoghar", "Dhanbad", "Dumka", "East Singhbhum", "Garhwa", "Giridih", "Godda", "Gumla", "Hazaribagh", "Jamtara", "Khunti", "Koderma", "Latehar", "Lohardaga", "Pakur", "Palamu", "Ramgarh", "Ranchi", "Sahebganj", "Seraikela Kharsawan", "Simdega", "West Singhbhum"], "Karnataka": ["Bagalkot", "Ballari", "Belagavi", "Bengaluru Rural", "Bengaluru Urban", "Bidar", "Chamarajanagar", "Chikkaballapur", "Chikkamagaluru", "Chitradurga", "Dakshina Kannada", "Davanagere", "Dharwad", "Gadag", "Hassan", "Haveri", "Kalaburagi", "Kodagu", "Kolar", "Koppal", "Mandya", "Mysuru", "Raichur", "Ramanagara", "Shivamogga", "Tumakuru", "Udupi", "Uttara Kannada", "Vijayapura", "Yadgir"], "Kerala": ["Alappuzha", "Ernakulam", "Idukki", "Kannur", "Kasaragod", "Kollam", "Kottayam", "Kozhikode", "Malappur", "Palakkad", "Pathanamthitta", "Thiruvananthapuram", "Thrissur", "Wayanad"], "Ladakh": ["Kargil", "Leh"], "Lakshadweep": ["Lakshadweep"], "Madhya Pradesh": ["Agar Malwa", "Alirajpur", "Anuppur", "Ashoknagar", "Balaghat", "Barwani", "Betul", "Bhind", "Bhopal", "Burhanpur", "Chhatarpur", "Chhindwara", "Damoh", "Datia", "Dewas", "Dhar", "Dindori", "Guna", "Gwalior", "Harda", "Hoshangabad", "Indore", "Jabalpur", "Jhabua", "Katni", "Khandwa", "Khargone", "Mandla", "Mandsaur", "Morena", "Narsinghpur", "Neemuch", "Panna", "Raisen", "Rajgarh", "Ratlam", "Rewa", "Sagar", "Satna", "Sehore", "Seoni", "Shahdol", "Shajapur", "Sheopur", "Shivpuri", "Sidhi", "Singrauli", "Tikamgarh", "Ujjain", "Umaria", "Vidisha"], "Maharashtra": ["Ahmednagar", "Akola", "Amravati", "Aurangabad", "Beed", "Bhandara", "Buldhana", "Chandrapur", "Dhule", "Gadchiroli", "Gondia", "Hingoli", "Jalgaon", "Jalna", "Kolhapur", "Latur", "Mumbai City", "Mumbai Suburban", "Nagpur", "Nanded", "Nandurbar", "Nashik", "Osmanabad", "Palghar", "Parbhani", "Pune", "Raigad", "Ratnagiri", "Sangli", "Satara", "Sindhudurg", "Solapur", "Thane", "Wardha", "Washim", "Yavatmal"], "Manipur": ["Bishnupur", "Chandel", "Churachandpur", "Imphal East", "Imphal West", "Jiribam", "Kakching", "Kamjong", "Kangpokpi", "Noney", "Pherzawl", "Senapati", "Tamenglong", "Tengnoupal", "Thoubal", "Ukhrul"], "Meghalaya": ["East Garo Hills", "East Jaintia Hills", "East Khasi Hills", "North Garo Hills", "Ri Bhoi", "South Garo Hills", "South West Garo Hills", "South West Khasi Hills", "West Garo Hills", "West Jaintia Hills", "West Khasi Hills"], "Mizoram": ["Aizawl", "Champhai", "Hnahthial", "Khawzawl", "Kolasib", "Lawngtlai", "Lunglei", "Mamit", "Saiha", "Saitual", "Serchhip"], "Nagaland": ["Dimapur", "Kiphire", "Kohima", "Longleng", "Mokokchung", "Mon", "Peren", "Phek", "Tuensang", "Wokha", "Zunheboto"], "Odisha": ["Angul", "Balangir", "Balasore", "Bargarh", "Bhadrak", "Boudh", "Cuttack", "Deogarh", "Dhenkanal", "Gajapati", "Ganjam", "Jagatsinghpur", "Jajpur", "Jharsuguda", "Kalahandi", "Kandhamal", "Kendrapara", "Kendujhar", "Khordha", "Koraput", "Malkangiri", "Mayurbhanj", "Nabarangpur", "Nayagarh", "Nuapada", "Puri", "Rayagada", "Sambalpur", "Subarnapur", "Sundargarh"], "Puducherry": ["Karaikal", "Mahe", "Puducherry", "Yanam"], "Punjab": ["Amritsar", "Barnala", "Bathinda", "Faridkot", "Fatehgarh Sahib", "Fazilka", "Ferozepur", "Gurdaspur", "Hoshiarpur", "Jalandhar", "Kapurthala", "Ludhiana", "Mansa", "Moga", "Pathankot", "Patiala", "Rupnagar", "Sahibzada Ajit Singh Nagar", "Sangrur", "Shahid Bhagat Singh Nagar", "Sri Muktsar Sahib", "Tarn Taran"], "Rajasthan": ["Ajmer", "Alwar", "Banswara", "Baran", "Barmer", "Bharatpur", "Bhilwara", "Bikaner", "Bundi", "Chittorgarh", "Churu", "Dausa", "Dholpur", "Dungarpur", "Hanumangarh", "Jaipur", "Jaisalmer", "Jalore", "Jhalawar", "Jhunjhunu", "Jodhpur", "Karauli", "Kota", "Nagaur", "Pali", "Pratapgarh", "Rajsamand", "Sawai Madhopur", "Sikar", "Sirohi", "Sri Ganganagar", "Tonk", "Udaipur"], "Sikkim": ["East Sikkim", "North Sikkim", "South Sikkim", "West Sikkim"], "Tamil Nadu": ["Ariyalur", "Chengalpattu", "Chennai", "Coimbatore", "Cuddalore", "Dharmapuri", "Dindigul", "Erode", "Kallakurichi", "Kanchipuram", "Kanyakumari", "Karur", "Krishnagiri", "Madurai", "Mayiladuthurai", "Nagapattinam", "Namakkal", "Nilgiris", "Perambalur", "Pudukkottai", "Ramanathapuram", "Ranipet", "Salem", "Sivaganga", "Tenkasi", "Thanjavur", "Theni", "Thoothukudi", "Tiruchirappalli", "Tirunelveli", "Tirupathur", "Tiruppur", "Tiruvallur", "Tiruvannamalai", "Tiruvarur", "Vellore", "Viluppuram", "Virudhunagar"], "Telangana": ["Adilabad", "Bhadradri Kothagudem", "Hyderabad", "Jagtial", "Jangaon", "Jayashankar Bhupalpally", "Jogulamba Gadwal", "Kamareddy", "Karimnagar", "Khammam", "Komaram Bheem", "Mahabubabad", "Mahabubnagar", "Mancherial", "Medak", "Medchal-Malkajgiri", "Mulugu", "Nagarkurnool", "Nalgonda", "Narayanpet", "Nirmal", "Nizamabad", "Peddapalli", "Rajanna Sircilla", "Ranga Reddy", "Sangareddy", "Siddipet", "Suryapet", "Vikarabad", "Wanaparthy", "Warangal Rural", "Warangal Urban", "Yadadri Bhuvanagiri"], "Tripura": ["Dhalai", "Gomati", "Khowai", "North Tripura", "Sepahijala", "South Tripura", "Unakoti", "West Tripura"], "Uttar Pradesh": ["Agra", "Aligarh", "Ambedkar Nagar", "Amethi", "Amroha", "Auraiya", "Ayodhya", "Azamgarh", "Baghpat", "Bahraich", "Ballia", "Balrampur", "Banda", "Barabanki", "Bareilly", "Basti", "Bhadohi", "Bijnor", "Budaun", "Bulandshahr", "Chandauli", "Chitrakoot", "Deoria", "Etah", "Etawah", "Farrukhabad", "Fatehpur", "Firozabad", "Gautam Buddha Nagar", "Ghaziabad", "Ghazipur", "Gonda", "Gorakhpur", "Hamirpur", "Hapur", "Hardoi", "Hathras", "Jalaun", "Jaunpur", "Jhansi", "Kannauj", "Kanpur Dehat", "Kanpur Nagar", "Kasganj", "Kaushambi", "Kheri", "Kushinagar", "Lalitpur", "Lucknow", "Maharajganj", "Mahoba", "Mainpuri", "Mathura", "Mau", "Meerut", "Mirzapur", "Moradabad", "Muzaffarnagar", "Pilibhit", "Pratapgarh", "Prayagraj", "Raebareli", "Rampur", "Saharanpur", "Sambhal", "Sant Kabir Nagar", "Shahjahanpur", "Shamli", "Shravasti", "Siddharthnagar", "Sitapur", "Sonbhadra", "Sultanpur", "Unnao", "Varanasi"], "Uttarakhand": ["Almora", "Bageshwar", "Chamoli", "Champawat", "Dehradun", "Haridwar", "Nainital", "Pauri Garhwal", "Pithoragarh", "Rudraprayag", "Tehri Garhwal", "Udham Singh Nagar", "Uttarkashi"], "West Bengal": ["Alipurduar", "Bankura", "Birbhum", "Cooch Behar", "Dakshin Dinajpur", "Darjeeling", "Hooghly", "Howrah", "Jalpaiguri", "Jhargram", "Kalimpong", "Kolkata", "Malda", "Murshidabad", "Nadia", "North 24 Parganas", "Paschim Bardhaman", "Paschim Medinipur", "Purba Bardhaman", "Purba Medinipur", "Purulia", "South 24 Parganas", "Uttar Dinajpur"] };

            function findPageConfig(pageKey) {
                if (config.pages[pageKey]) return config.pages[pageKey];
                for (const key in config.pages) {
                    if (config.pages[key].subPages && config.pages[key].subPages[pageKey]) {
                        return config.pages[key].subPages[pageKey];
                    }
                }
                return null;
            }

            const saveData = () => {
                try {
                    localStorage.setItem('schoolData', JSON.stringify(state.data));
                } catch (e) {
                    console.error("Error saving data:", e);
                    showToast("Error saving data. Storage might be full.", "error");
                }
            };

            const loadData = () => {
                const savedData = localStorage.getItem('schoolData');
                state.data = savedData ? JSON.parse(savedData) : {};
                
                ['students', 'transactions', 'adminNotes', 'gallery', 'videos', 'inquiries', 'expenses', 'notices', 'teachers', 'timetables', 'staff', 'examMasters', 'examSchedules', 'homework', 'events', 'books', 'issuedBooks', 'schoolPhotos', 'externalLinks'].forEach(key => {
                    if (!state.data[key]) state.data[key] = [];
                });
                
                if(!state.data.studentAttendance) state.data.studentAttendance = {};
                if(!state.data.teacherAttendance) state.data.teacherAttendance = {};
                if(!state.data.staffAttendance) state.data.staffAttendance = {};
                if(!state.data.marks) state.data.marks = {};
                
                if (!state.data.siteContent) {
                    state.data.siteContent = {
                        schoolName: "Digital India Management School",
                        schoolAddress: "Maniyaripur, Lohata, Varanasi - 221107",
                        schoolState: "Uttar Pradesh",
                        schoolDistrict: "Varanasi",
                        schoolCode: "",
                        principalDesk: "Welcome to our school. We are committed to providing a nurturing and challenging environment for our students.",
                        aboutSchool: "Established with a vision to foster excellence in education, our school offers a comprehensive curriculum.",
                        latestNews: [],
                        manualTopperStudentIds: []
                    };
                }
                 if (typeof state.data.siteContent.manualTopperStudentId !== 'undefined') {
                    if(state.data.siteContent.manualTopperStudentId) {
                       state.data.siteContent.manualTopperStudentIds = [state.data.siteContent.manualTopperStudentId];
                    }
                    delete state.data.siteContent.manualTopperStudentId;
                }
                 if (!state.data.siteContent.manualTopperStudentIds) {
                     state.data.siteContent.manualTopperStudentIds = [];
                 }
            };

            const navigate = (page, view = 'list', id = null, filter = null) => {
                closeModal();
                if (window.innerWidth <= 768 && document.body.classList.contains('sidebar-open')) {
                     document.body.classList.remove('sidebar-open');
                }

                const userRole = state.loggedInUser?.role || 'guest';
                const pageConfig = findPageConfig(page);
                
                let fallbackPage = 'home';
                if(userRole === 'student' || userRole === 'parent') fallbackPage = 'studentDashboard';
                if(userRole === 'teacher') fallbackPage = 'teacherDashboard';

                if (!pageConfig || !pageConfig.roles.includes(userRole)) {
                    showToast("Access Denied.", "error");
                    page = fallbackPage;
                }
                
                const historyState = { page, view, id, filter };
                let hash = page;
                if(view !== 'list') hash += `/${view}`;
                if(id) hash += `/${id}`;

                if (window.location.hash !== `#${hash}`) {
                     history.pushState(historyState, '', `#${hash}`);
                }
                
                applyState(historyState);
            };
            
            const applyState = (newState) => {
                state.currentPage = newState.page;
                state.currentView = newState.view || 'list';
                state.currentItemId = newState.id || null;
                state.studentListFilter = newState.filter || null; 
                
                renderUI();
                getEl('main-wrapper').scrollTop = 0;
            }

            const renderUI = () => {
                getEl('app-container').style.display = 'flex';
                
                renderSidebar();
                renderMainFooter();

                const pageConfig = findPageConfig(state.currentPage);

                if (pageConfig && typeof pageConfig.renderer === 'function') {
                    getEl('main-content').innerHTML = '';
                    pageConfig.renderer();
                    
                    const menuToggle = document.querySelector('.menu-toggle');
                    if (menuToggle) menuToggle.onclick = toggleSidebar;
                    
                    const themeCycleBtn = getEl('theme-cycle-btn');
                    if(themeCycleBtn) themeCycleBtn.onclick = cycleAccentColor;
                    
                    const themeModeBtn = getEl('theme-mode-btn');
                    if(themeModeBtn) {
                       themeModeBtn.onclick = toggleThemeMode;
                       themeModeBtn.innerHTML = `<i class="fas ${document.body.classList.contains('light-theme') ? 'fa-moon' : 'fa-sun'}"></i>`;
                    }

                } else {
                    let fallbackPage = 'home';
                    const userRole = state.loggedInUser?.role || 'guest';
                    if(userRole === 'student' || userRole === 'parent') fallbackPage = 'studentDashboard';
                    if(userRole === 'teacher') fallbackPage = 'teacherDashboard';
                    navigate(fallbackPage);
                }
            };
            
            const checkAuth = () => {
                initTheme();
                initAccentColor();
                initFontWeight(); 
                initSidebarState();
                
                const loggedInUserData = localStorage.getItem('loggedInUser');
                state.loggedInUser = loggedInUserData ? JSON.parse(loggedInUserData) : null;
                
                loadData();
                
                handleRouteChange();
                startClock();
            };

            const handleRouteChange = () => {
                let path = window.location.hash.substring(1);
                let page, view, id;
                let newState = {};

                if (path) {
                    const parts = path.split('/');
                    page = parts[0] || 'home';
                    view = parts[1] || 'list';
                    id = parts[2] || null;
                } else {
                    page = 'home';
                    view = 'list';
                    id = null;
                }

                const userRole = state.loggedInUser?.role || 'guest';
                const pageConfig = findPageConfig(page);
                
                let fallbackPage = 'home';
                if(userRole === 'student' || userRole === 'parent') fallbackPage = 'studentDashboard';
                if(userRole === 'teacher') fallbackPage = 'teacherDashboard';
                
                if(!pageConfig || !pageConfig.roles.includes(userRole)){
                    newState = { page: fallbackPage, view: 'list', id: null };
                } else {
                    newState = { page, view, id };
                }
                
                applyState(newState);
            }

            window.onpopstate = (event) => {
                 if (event.state) {
                    applyState(event.state);
                } else {
                    handleRouteChange();
                }
            };

            const showRegisterModal = () => {
                if (localStorage.getItem('adminAccount')) {
                    showToast("An admin account already exists.", "info");
                    showLoginModal('admin');
                    return;
                }
                const formContent = `
                    <form id="register-form">
                        <div class="form-feedback" id="register-feedback"></div>
                        <div class="form-group"><label for="admin-name">Full Name</label><input type="text" id="admin-name" required></div>
                        <div class="form-group"><label for="admin-email">Email</label><input type="email" id="admin-email" required></div>
                        <div class="form-group"><label for="admin-mobile">Mobile Number</label><input type="tel" id="admin-mobile" required></div>
                        <div class="form-group"><label for="admin-photo">Your Photo</label><input type="file" id="admin-photo" accept="image/*" required></div>
                        <div class="form-group"><label for="new-password">Password (min. 4 characters)</label><input type="password" id="new-password" required minlength="4"></div>
                        <div class="form-group"><label for="confirm-password">Confirm Password</label><input type="password" id="confirm-password" required></div>
                        <button type="submit" class="action-button" style="width: 100%;">Register</button>
                         <p style="text-align: center; margin-top: 15px;">Already have an account? <a href="#" class="auth-link" onclick="event.preventDefault(); showLoginModal('admin');">Login here</a></p>
                    </form>
                `;
                showModal('Admin Registration', formContent, '500px');
                getEl('register-form').onsubmit = handleRegistration;
            }

            async function handleRegistration(e) {
                e.preventDefault();
                getEl('loading-overlay').style.display = 'flex';
                const feedbackEl = getEl('register-feedback');

                const newPass = getEl('new-password').value;
                const confirmPass = getEl('confirm-password').value;
                const adminPhotoFile = getEl('admin-photo').files[0];

                if (newPass !== confirmPass) {
                    getEl('loading-overlay').style.display = 'none';
                    feedbackEl.textContent = 'Passwords do not match.';
                    feedbackEl.className = 'form-feedback error';
                    return;
                }
                if (newPass.length < 4 || !getEl('admin-name').value || !getEl('admin-email').value || !getEl('admin-mobile').value || !adminPhotoFile) {
                    getEl('loading-overlay').style.display = 'none';
                    feedbackEl.textContent = 'Please fill all required fields.';
                    feedbackEl.className = 'form-feedback error';
                    return;
                }
                
                try {
                    const photo = await fileToBase64(adminPhotoFile);
                    const adminAccount = {
                        name: getEl('admin-name').value,
                        email: getEl('admin-email').value,
                        mobile: getEl('admin-mobile').value,
                        photo: photo,
                        password: btoa(newPass)
                    };
                    localStorage.setItem('adminAccount', JSON.stringify(adminAccount));
                    
                    getEl('loading-overlay').style.display = 'none';
                    showToast('Registration successful! Please login.', 'success');
                    setTimeout(() => showLoginModal('admin'), 1500);
                } catch(err) {
                     getEl('loading-overlay').style.display = 'none';
                     feedbackEl.textContent = 'Failed to process photo.';
                     feedbackEl.className = 'form-feedback error';
                }
            };

            const showLoginModal = (role) => {
                 let modalTitle = 'Login';
                 let usernameLabel = "ID (Email, Mobile, Admission/Employee No.)";

                 if(role === 'admin') {
                     modalTitle = 'Admin Login';
                     usernameLabel = "Email or Mobile Number";
                 } else if (role === 'teacher') {
                     modalTitle = 'Teacher Login';
                     usernameLabel = "Employee ID, Email, or Mobile";
                 } else if (role === 'student_parent') {
                     modalTitle = 'Student / Parent Login';
                      usernameLabel = "Admission No, Email, or Mobile";
                 }

                const formContent = `
                    <form id="login-form">
                        <div class="form-feedback" id="login-feedback"></div>
                        <div class="form-group">
                            <label for="username">${usernameLabel}</label>
                            <input type="text" id="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Login</button>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                            <a href="#" class="auth-link" onclick="event.preventDefault(); showForgotPasswordModal();">Forgot Password?</a>
                            ${role === 'admin' ? `<a href="#" class="auth-link" onclick="event.preventDefault(); showRegisterModal();">Register Admin</a>` : ''}
                        </div>
                    </form>
                `;
                showModal(modalTitle, formContent, '500px');
                getEl('login-form').onsubmit = (e) => handleLogin(e, role);
            };

            const handleLogin = (e, role) => {
                e.preventDefault();
                const feedbackEl = getEl('login-feedback');
                const enteredUsername = getEl('username').value.trim();
                const enteredPassword = getEl('password').value;
                const selectedRole = role;

                if (selectedRole === 'admin') {
                    const adminAccount = JSON.parse(localStorage.getItem('adminAccount'));
                    if(adminAccount && (enteredUsername === adminAccount.email || enteredUsername === adminAccount.mobile) && btoa(enteredPassword) === adminAccount.password) {
                        loginSuccess({role: 'admin', ...adminAccount});
                        return;
                    }
                }

                if (selectedRole === 'teacher') {
                    const teacher = (state.data.teachers || []).find(t => 
                        (t.email && t.email === enteredUsername) || 
                        (t.contact && t.contact === enteredUsername) ||
                        (t.employeeId && t.employeeId === enteredUsername)
                    );
                     if(teacher && teacher.password && btoa(enteredPassword) === teacher.password){
                        loginSuccess({role: 'teacher', ...teacher});
                        return;
                    }
                }
                
                if (selectedRole === 'student_parent') {
                    const student = (state.data.students || []).find(s => 
                        (s.email && s.email === enteredUsername) || 
                        (s.contact && s.contact === enteredUsername) ||
                        (s.admissionNumber && s.admissionNumber === enteredUsername)
                    );
                    if(student && student.password && btoa(enteredPassword) === student.password){
                        loginSuccess({role: 'student', ...student});
                        return;
                    }

                    const parentStudent = (state.data.students || []).find(s => 
                        (s.guardianContact && s.guardianContact === enteredUsername)
                    );
                    if(parentStudent && parentStudent.password && btoa(enteredPassword) === parentStudent.password){
                        loginSuccess({
                            role: 'parent', 
                            name: `Parent of ${parentStudent.name}`, 
                            photo: parentStudent.photo,
                            studentId: parentStudent.id
                        });
                        return;
                    }
                }

                feedbackEl.textContent = 'Incorrect username or password.';
                feedbackEl.className = 'form-feedback error';
            };

            function showForgotPasswordModal() {
                const formContent = `
                    <form id="forgot-password-form">
                        <p>Please enter your username (Email, Mobile, or Admission No.) to start the recovery process.</p>
                        <div class="form-feedback" id="forgot-password-feedback"></div>
                        <div class="form-group">
                            <label for="recovery-username">Username</label>
                            <input type="text" id="recovery-username" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Find Account</button>
                    </form>
                `;
                showModal('Forgot Password', formContent);
                getEl('forgot-password-form').onsubmit = handleFindAccount;
            }

            function handleFindAccount(e) {
                e.preventDefault();
                const feedbackEl = getEl('forgot-password-feedback');
                const username = getEl('recovery-username').value.trim();

                const adminAccount = JSON.parse(localStorage.getItem('adminAccount'));
                if (adminAccount && (username === adminAccount.email || username === adminAccount.mobile)) {
                    showAdminPasswordResetVerification(adminAccount);
                    return;
                }

                const teacher = (state.data.teachers || []).find(t => 
                    (t.email && t.email === username) || 
                    (t.contact && t.contact === username) ||
                    (t.employeeId && t.employeeId === username)
                );
                 if (teacher) {
                    showTeacherPasswordResetVerification(teacher);
                    return;
                }

                const student = (state.data.students || []).find(s => 
                    (s.email && s.email === username) || 
                    (s.contact && s.contact === username) ||
                    (s.admissionNumber && s.admissionNumber === username) ||
                    (s.guardianContact && s.guardianContact === username)
                );

                if (student) {
                    showStudentPasswordResetVerification(student);
                    return;
                }

                feedbackEl.textContent = 'No account found with that username.';
                feedbackEl.className = 'form-feedback error';
            }

            function showAdminPasswordResetVerification(adminAccount) {
                const formContent = `
                    <form id="admin-verify-form">
                        <p>For security, please verify your identity.</p>
                        <div class="form-feedback" id="admin-verify-feedback"></div>
                        <div class="form-group">
                            <label for="admin-recovery-email">Your Registered Email</label>
                            <input type="email" id="admin-recovery-email" required>
                        </div>
                        <div class="form-group">
                            <label for="admin-recovery-mobile">Your Registered Mobile</label>
                            <input type="tel" id="admin-recovery-mobile" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Verify & Reset</button>
                    </form>
                `;
                showModal('Verify Admin Account', formContent);
                getEl('admin-verify-form').onsubmit = (e) => {
                    e.preventDefault();
                    const email = getEl('admin-recovery-email').value;
                    const mobile = getEl('admin-recovery-mobile').value;
                    if (email === adminAccount.email && mobile === adminAccount.mobile) {
                        showNewPasswordForm('admin', adminAccount);
                    } else {
                        getEl('admin-verify-feedback').textContent = 'Verification failed. Information does not match.';
                        getEl('admin-verify-feedback').className = 'form-feedback error';
                    }
                };
            }
            
            function showTeacherPasswordResetVerification(teacher) {
                const formContent = `
                     <form id="teacher-verify-form">
                        <p>For security, please verify your identity, <strong>${teacher.name}</strong>.</p>
                        <div class="form-feedback" id="teacher-verify-feedback"></div>
                         <div class="form-group">
                            <label for="teacher-recovery-dob">Date of Birth</label>
                            <input type="text" id="teacher-recovery-dob" placeholder="YYYY-MM-DD" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Verify & Reset</button>
                    </form>
                `;
                showModal('Verify Teacher Account', formContent);
                getEl('teacher-verify-form').onsubmit = (e) => {
                    e.preventDefault();
                    const dob = getEl('teacher-recovery-dob').value;
                    if (dob === teacher.dob) {
                        showNewPasswordForm('teacher', teacher);
                    } else {
                        getEl('teacher-verify-feedback').textContent = "Verification failed. Information does not match.";
                        getEl('teacher-verify-feedback').className = 'form-feedback error';
                    }
                };
            }

            function showStudentPasswordResetVerification(student) {
                const formContent = `
                     <form id="student-verify-form">
                        <p>For security, please verify your identity, <strong>${student.name}</strong>.</p>
                        <div class="form-feedback" id="student-verify-feedback"></div>
                        <div class="form-group">
                            <label for="student-recovery-father">Father's Name</label>
                            <input type="text" id="student-recovery-father" required>
                        </div>
                         <div class="form-group">
                            <label for="student-recovery-dob">Date of Birth</label>
                            <input type="text" id="student-recovery-dob" placeholder="YYYY-MM-DD" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Verify & Reset</button>
                    </form>
                `;
                showModal('Verify Student Account', formContent);
                getEl('student-verify-form').onsubmit = (e) => {
                    e.preventDefault();
                    const fatherName = getEl('student-recovery-father').value.trim();
                    const dob = getEl('student-recovery-dob').value;
                    if (fatherName.toLowerCase() === student.fatherName.toLowerCase() && dob === student.dob) {
                        showNewPasswordForm('student', student);
                    } else {
                        getEl('student-verify-feedback').textContent = "Verification failed. Information does not match.";
                        getEl('student-verify-feedback').className = 'form-feedback error';
                    }
                };
            }
            
            function showNewPasswordForm(userType, userData) {
                const formContent = `
                    <form id="new-password-form">
                        <p>Create a new password for ${userData.name}.</p>
                        <div class="form-feedback" id="new-password-feedback"></div>
                        <div class="form-group"><label for="reset-new-password">New Password (min. 4 characters)</label><input type="password" id="reset-new-password" required minlength="4"></div>
                        <div class="form-group"><label for="reset-confirm-password">Confirm New Password</label><input type="password" id="reset-confirm-password" required></div>
                        <button type="submit" class="action-button" style="width: 100%;">Set New Password</button>
                    </form>
                `;
                showModal('Set New Password', formContent);
                getEl('new-password-form').onsubmit = (e) => {
                    e.preventDefault();
                    const newPass = getEl('reset-new-password').value;
                    const confirmPass = getEl('reset-confirm-password').value;
                    const feedbackEl = getEl('new-password-feedback');

                    if (newPass !== confirmPass) {
                        feedbackEl.textContent = 'Passwords do not match.';
                        feedbackEl.className = 'form-feedback error';
                        return;
                    }
                    if (newPass.length < 4) {
                        feedbackEl.textContent = 'Password must be at least 4 characters long.';
                        feedbackEl.className = 'form-feedback error';
                        return;
                    }

                    userData.password = btoa(newPass);

                    if (userType === 'admin') {
                        localStorage.setItem('adminAccount', JSON.stringify(userData));
                    } else if (userType === 'student') {
                        updateOrAddItem('students', userData);
                    } else if (userType === 'teacher') {
                        updateOrAddItem('teachers', userData);
                    }

                    showToast('Password has been reset successfully!', 'success');
                    setTimeout(() => showLoginModal(userType === 'student' ? 'student_parent' : userType), 1500);
                };
            }
            
            const loginSuccess = (userData) => {
                state.loggedInUser = userData;
                localStorage.setItem('loggedInUser', JSON.stringify(userData));
                closeModal();
                getEl('loading-overlay').style.display = 'none';
                let landingPage = 'home';
                if(userData.role === 'student' || userData.role === 'parent') landingPage = 'studentDashboard';
                if(userData.role === 'teacher') landingPage = 'teacherDashboard';
                navigate(landingPage);
                showToast(`Welcome, ${userData.name}!`, "success");
            };

            const logout = () => {
                if(html5QrCode && html5QrCode.isScanning){
                     html5QrCode.stop().catch(err => console.error("QR scanner stop error", err));
                }
                state.loggedInUser = null;
                localStorage.removeItem('loggedInUser');
                navigate('home');
                showToast("You have been logged out.", "info");
            };

            const renderSidebar = () => {
                let headerHtml = '';
                let navHtml = '';
                const userRole = state.loggedInUser?.role || 'guest';

                if (state.loggedInUser) {
                    const userProfile = state.loggedInUser;
                    headerHtml = `
                        <div class="sidebar-header">
                            <img src="${userProfile.photo || 'https://via.placeholder.com/80?text=User'}" alt="User Photo" class="admin-photo">
                            <h2>${userProfile.name || 'User Panel'}</h2>
                            <span style="font-size: 0.9em; color: var(--text-muted); text-transform: capitalize;">(${userProfile.role})</span>
                        </div>`;
                } else {
                    headerHtml = `
                         <div class="sidebar-header">
                            <div class="new-dims-logo">
                                <div class="ring"></div>
                                <div class="logo-text">DIMS</div>
                            </div>
                            <h2 style="margin-top:10px;">Welcome</h2>
                             <button class="action-button" onclick="navigate('admission')" style="width:100%; margin: 15px 0;">
                                <i class="fas fa-rocket"></i> Admission 2025-26
                             </button>
                             <button class="action-button secondary" onclick="showUnifiedScanner()" style="width:100%; margin-bottom: 15px;">
                                <i class="fas fa-qrcode"></i> Scan for Attendance
                             </button>
                            <p style="color: var(--text-muted);">Please login to continue:</p>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px; width:100%;">
                                <button class="action-button secondary" onclick="showLoginModal('admin')"><i class="fas fa-user-shield"></i> Admin Login</button>
                                <button class="action-button secondary" onclick="showLoginModal('teacher')"><i class="fas fa-chalkboard-teacher"></i> Teacher Login</button>
                                <button class="action-button secondary" onclick="showLoginModal('student_parent')"><i class="fas fa-user-graduate"></i> Student/Parent Login</button>
                            </div>
                        </div>`;
                }

                for (const [key, page] of Object.entries(config.pages)) {
                     if (!page.roles.includes(userRole)) continue;

                    if (page.subPages) {
                        const subPageKeys = Object.keys(page.subPages);
                        const hasVisibleSubpages = subPageKeys.some(subKey => page.subPages[subKey].roles.includes(userRole));
                        if (!hasVisibleSubpages) continue;

                        const isOpen = subPageKeys.includes(state.currentPage);
                        const subMenuHtml = subPageKeys.map(subKey => {
                            if (!page.subPages[subKey].roles.includes(userRole)) return '';
                            return `<li><a class="nav-link ${state.currentPage === subKey ? 'active' : ''}" data-page="${subKey}">
                                <span class="nav-link-content"><i class="fas ${page.subPages[subKey].icon}"></i><span>${page.subPages[subKey].title}</span></span>
                            </a></li>`
                        }).join('');

                        navHtml += `<div class="sidebar-nav-item ${isOpen ? 'open' : ''}"><a class="submenu-toggle">
                                    <span class="nav-link-content"><i class="fas ${page.icon}"></i><span>${page.title}</span></span>
                                    <i class="fas fa-chevron-right arrow"></i></a><ul class="sidebar-submenu">${subMenuHtml}</ul></div>`;
                    } else {
                        navHtml += `<div class="sidebar-nav-item"><a class="nav-link ${state.currentPage === key ? 'active' : ''}" data-page="${key}">
                                    <span class="nav-link-content"><i class="fas ${page.icon}"></i><span>${page.title}</span></span></a></div>`;
                    }
                }
                
                const externalLinksHtml = (state.data.externalLinks || []).map(link => `
                     <div class="sidebar-nav-item"><a href="${link.url}" target="_blank" class="nav-link">
                        <span class="nav-link-content"><i class="fas fa-external-link-alt"></i><span>${link.title}</span></span></a></div>
                `).join('');

                const footerHtml = `
                    <div class="sidebar-footer">
                        ${state.loggedInUser ? '<button id="logout-btn" class="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</button>' : ''}
                        <div class="social-media-links">
                            <a href="https://wa.me/917052995691" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                            <a href="https://instagram.com" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                            <a href="https://facebook.com" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                            <a href="https://youtube.com" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>`;

                getEl('sidebar').innerHTML = headerHtml + `<nav class="sidebar-nav">${navHtml}${externalLinksHtml ? `<hr style="border-color: var(--border-color); margin: 15px 20px;"><div style="padding: 0 25px; color: var(--text-muted); font-weight: 500; margin-bottom: 10px;">Important Links</div>` + externalLinksHtml : ''}</nav>` + footerHtml;

                getEl('sidebar').querySelectorAll('.nav-link').forEach(link => { 
                    if(link.hasAttribute('data-page')) {
                        link.onclick = () => navigate(link.dataset.page); 
                    }
                });
                getEl('sidebar').querySelectorAll('.submenu-toggle').forEach(link => { link.onclick = () => link.parentElement.classList.toggle('open'); });
                if (state.loggedInUser) {
                    getEl('sidebar').querySelector('#logout-btn').onclick = logout;
                }
            };
            
            const renderHeader = (title, actionsHtml = '') => {
                const themeCyclerBtn = `<button id="theme-cycle-btn" class="action-button inline no-print" title="Change Theme Color" style="padding: 12px 15px;"><i class="fas fa-palette"></i></button>`;
                const themeModeBtn = `<button id="theme-mode-btn" class="action-button inline no-print" title="Toggle Dark/Light Mode" style="padding: 12px 15px;"><i class="fas fa-moon"></i></button>`;
                return `<div class="header no-print"><div class="header-left"><button class="menu-toggle"><i class="fas fa-bars"></i></button>
                        <div class="header-title-container"><span class="moving-title">DIGITAL INDIA MANAGEMENT SCHOOL (DIMS) - VARANASI</span></div></div>
                        <div class="header-actions"><div id="real-time-clock"></div> ${themeCyclerBtn} ${themeModeBtn} ${actionsHtml}</div></div>`;
            };
            
            const renderMainFooter = () => {
                const schoolInfo = state.data.siteContent;
                getEl('main-footer').innerHTML = `<div class="footer-content"><div class="footer-contact">
                        <p><i class="fas fa-map-marker-alt"></i> ${schoolInfo.schoolAddress || 'Address not set'}</p>
                        <p><i class="fas fa-phone-alt"></i> <a href="tel:7052995691" style="color: var(--text-color); text-decoration: none;">7052995691</a></p>
                         <p><i class="fas fa-envelope"></i> <a href="mailto:school@example.com" style="color: var(--text-color); text-decoration: none;">school@example.com</a></p>
                        </div><div class="footer-map"><iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d57692.19321450258!2d82.8529699486328!3d25.355152200000004!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x398e2db0b1359c25%3A0x1b7f03a6e3650a64!2sLohata%2C%2C%20Uttar%20Pradesh%20221107!5e0!3m2!1sen!2sin!4v1721950485608!5m2!1sen!2sin" 
                        width="300" height="120" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div></div>`;
            };

            const showModal = (title, content, maxWidth = '600px') => {
                const modalHTML = `<div class="modal-overlay no-print"><div class="modal-content" style="max-width: ${maxWidth};"><div class="modal-header no-print"><h2>${title}</h2>
                        <button class="close-btn" onclick="closeModal()"></button></div><div class="modal-body">${content}</div></div></div>`;
                getEl('modal-container').innerHTML = modalHTML;
            };

            function getFeeDefaulters() {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const studentsWithPaymentsThisMonth = new Set();

                (state.data.transactions || []).forEach(t => {
                    const transactionDate = new Date(t.date);
                    if (transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear) {
                        studentsWithPaymentsThisMonth.add(t.studentId);
                    }
                });

                return (state.data.students || []).filter(s => !studentsWithPaymentsThisMonth.has(s.id));
            }

            function getTopStudents() {
                const { marks, examMasters, students, siteContent } = state.data;

                // Handle manual toppers first
                if (siteContent && siteContent.manualTopperStudentIds && siteContent.manualTopperStudentIds.length > 0) {
                    return siteContent.manualTopperStudentIds.map(topperId => {
                        const manualTopper = findById('students', topperId);
                        if (manualTopper) {
                            return {
                                student: manualTopper,
                                percentage: null,
                                examName: "Honorary Topper",
                                isManual: true
                            };
                        }
                        return null;
                    }).filter(t => t !== null);
                }

                // Automatic calculation if no manual toppers
                if (!marks || !examMasters || !students || examMasters.length === 0) return [];

                const latestDeclaredExam = examMasters
                    .filter(em => em.declarationDate && new Date(em.declarationDate) <= new Date())
                    .sort((a, b) => new Date(b.declarationDate) - new Date(a.declarationDate))[0];

                if (!latestDeclaredExam) return [];

                const examMarks = marks[latestDeclaredExam.id];
                if (!examMarks) return [];

                let allStudentScores = [];

                for (const studentId in examMarks) {
                    const studentResult = examMarks[studentId];
                    const studentData = findById('students', studentId);

                    if (studentData) {
                        let totalMarksGot = 0;
                        let totalMaxMarks = 0;

                        studentResult.forEach(m => {
                            totalMarksGot += (m.theoryGot || 0) + (m.practicalGot || 0);
                            totalMaxMarks += (m.theoryMax || 0) + (m.practicalMax || 0);
                        });

                        const percentage = totalMaxMarks > 0 ? (totalMarksGot / totalMaxMarks) * 100 : 0;
                        allStudentScores.push({ student: studentData, percentage, examName: latestDeclaredExam.name, isManual: false });
                    }
                }

                return allStudentScores.sort((a, b) => b.percentage - a.percentage).slice(0, 1);
            }

            function renderHomePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Admin Dashboard');
                const userProfile = state.loggedInUser;
                const { students, notices, teachers, examSchedules, staff, events, siteContent, schoolPhotos, externalLinks } = state.data;
                
                const recentNoticesHtml = (notices || []).sort((a, b) => b.id - a.id).slice(0, 3).map(n => `
                    <div class="notice-item">
                        <h4>${n.title}</h4>
                        <p>${n.content.substring(0, 80)}...</p>
                        <div class="notice-date">${new Date(n.id).toLocaleString()}</div>
                    </div>`).join('') || '<div class="notice-item"><p>No recent notices.</p></div>';
                
                const latestNewsHtml = (siteContent.latestNews || []).sort((a, b) => b.id - a.id).slice(0, 3).map(n => `
                    <div class="notice-item">
                        <h4>${n.title}</h4>
                        <p>${n.content.substring(0, 80)}...</p>
                        <div class="notice-date">${new Date(n.id).toLocaleString()}</div>
                    </div>`).join('') || '<div class="notice-item"><p>No latest news.</p></div>';

                const upcomingEventsHtml = (events || [])
                    .filter(ev => new Date(ev.date) >= new Date())
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .slice(0, 3)
                    .map(ev => `
                    <div class="notice-item">
                        <h4>${ev.title}</h4>
                        <p>${ev.description.substring(0, 80)}...</p>
                        <div class="notice-date">On: ${new Date(ev.date).toLocaleDateString()}</div>
                    </div>`).join('') || '<div class="notice-item"><p>No upcoming events.</p></div>';


                const upcomingExamsHtml = (examSchedules || []).filter(ex => new Date(ex.date) >= new Date()).sort((a, b) => new Date(a.date) - new Date(b.date)).slice(0, 5).map(ex => {
                    const examMaster = findById('examMasters', ex.examMasterId);
                    return `<li class="detail-list-item">
                        <span><i class="fas fa-file-signature" style="color:var(--primary-light); margin-right:10px;"></i><strong>${ex.subject}</strong> (${ex.className})<br><small style="color:var(--text-muted)">${examMaster.name}</small></span>
                        <span>${new Date(ex.date).toLocaleDateString()}</span>
                    </li>`}).join('') || '<li>No upcoming exams scheduled.</li>';
                
                const studentAttendance = getTodaysAttendanceSummary('students');
                
                const studentAttendancePercentage = (students || []).length > 0 ? ((studentAttendance.present / (students || []).length) * 100).toFixed(0) : 0;

                const classOrder = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
                const studentCountsByClass = (students || []).reduce((acc, student) => {
                    const className = student.className;
                    if(className) {
                       acc[className] = (acc[className] || 0) + 1;
                    }
                    return acc;
                }, {});

                const classStrengthHtml = classOrder.map(className => {
                    const count = studentCountsByClass[className] || 0;
                    return `<li class="detail-list-item clickable" onclick="navigate('studentList', 'list', null, { className: '${className}' })">
                        <span><i class="fas fa-school" style="color:var(--primary-light); margin-right:10px;"></i>Class ${className}</strong></span>
                        <span style="font-weight: bold; font-size: 1.2em;">${count}</span>
                    </li>`;
                }).join('') || '<li>No students enrolled in any class yet.</li>';

                const recentlyAddedStudents = (students || []).sort((a, b) => b.id - a.id).slice(0, 10);
                let recentStudentsHtml = recentlyAddedStudents.length > 0 ? recentlyAddedStudents.map(s => `
                    <div class="lookup-result-item" onclick="navigate('students', 'profile', '${s.id}')">
                        <img src="${s.photo || 'https://via.placeholder.com/50?text=S'}" alt="Photo">
                        <div style="flex-grow: 1;">
                            <strong>${s.name}</strong>
                            <p style="font-size: 0.9em; color: var(--text-muted);">Class ${s.className || 'N/A'}</p>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                `).join('') : '<p style="text-align:center; color: var(--text-muted); padding: 20px 0;">No new admissions yet.</p>';

                if(recentlyAddedStudents.length > 0) {
                    recentStudentsHtml += recentStudentsHtml;
                }
                
                const ourFacultyHtml = (teachers || []).length > 0 ? teachers.map(teacher => `
                    <div class="card" style="text-align: center;">
                        <img src="${teacher.photo || 'https://via.placeholder.com/80?text=T'}" alt="Teacher Photo" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-light);">
                        <h4 style="margin-top: 15px; font-size: 1.1rem;">${teacher.name}</h4>
                        <p style="color: var(--text-muted);">${teacher.role}</p>
                    </div>
                `).join('') : '<p style="text-align:center; color: var(--text-muted);">No teachers have been added yet.</p>';
                 
                const topStudents = getTopStudents();
                let topperCardsHtml = '';
                if (topStudents.length > 0) {
                    topperCardsHtml = topStudents.map(topStudentInfo => {
                        let topperDetails = topStudentInfo.isManual
                            ? `<p style="color: var(--text-muted); font-size: 0.9rem;">(${topStudentInfo.examName})</p>`
                            : `<p style="font-size: 1.5rem; font-weight: bold; color: var(--success-color); margin-top: 10px;">
                               ${topStudentInfo.percentage.toFixed(2)}%
                              </p>
                              <p style="color: var(--text-muted); font-size: 0.9rem;">(${topStudentInfo.examName})</p>`;

                        return `
                        <div class="card" style="border-left: 5px solid var(--warning-color); text-align: center;">
                            <h3 style="color: var(--warning-color); font-size: 1.5rem; margin-bottom: 15px;"><i class="fas fa-crown"></i> School Topper</h3>
                            <img src="${topStudentInfo.student.photo || 'https://via.placeholder.com/100?text=Topper'}" alt="Topper Photo" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--warning-color);">
                            <h4 style="margin-top: 15px; font-size: 1.4rem;">${topStudentInfo.student.name}</h4>
                            <p style="color: var(--text-muted); font-size: 1.1rem;">Class ${topStudentInfo.student.className} ${topStudentInfo.student.stream ? '(' + topStudentInfo.student.stream + ')' : ''}</p>
                            ${topperDetails}
                        </div>`;
                    }).join('');
                } else {
                    topperCardsHtml = `
                     <div class="card" style="border-left: 5px solid var(--info-color); text-align: center;">
                         <h3 style="color: var(--info-color); font-size: 1.5rem; margin-bottom: 15px;"><i class="fas fa-crown"></i> School Topper</h3>
                         <p style="color: var(--text-muted); padding: 20px 0;">Topper information is not available.</p>
                     </div>`;
                }

                const schoolPhotosHtml = (schoolPhotos && schoolPhotos.length > 0) ? `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-school"></i> School Gallery</h3>
                            ${ state.loggedInUser?.role === 'admin' ? `<button class="action-button inline" onclick="navigate('settings', 'list', 'schoolPhotos')">Manage</button>` : `<button class="action-button inline" onclick="navigate('media', 'list', 'gallery')">View All</button>`}
                        </div>
                        <div class="school-photos-container">
                            ${schoolPhotos.slice(0, 3).map(photo => `
                                <div class="school-photo-item">
                                    <img src="${photo.image}" alt="${photo.title}">
                                    <div class="photo-title">${photo.title}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                 const externalLinksHtml = (externalLinks && externalLinks.length > 0) ? `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-link"></i> Important Links</h3>
                             ${ state.loggedInUser?.role === 'admin' ? `<button class="action-button inline" onclick="navigate('settings', 'list', 'manageLinks')">Manage</button>` : ''}
                        </div>
                        <ul class="detail-list">
                          ${externalLinks.map(link => `<li><a href="${link.url}" target="_blank" style="color: var(--primary-light); text-decoration: none;"><i class="fas fa-external-link-alt" style="margin-right: 10px;"></i>${link.title}</a></li>`).join('')}
                        </ul>
                    </div>
                ` : '';


                mainContent.innerHTML += `<div class="page active">
                    <div class="card" style="background: var(--primary-gradient); color: white;">
                        <h2 style="font-size: 1.8rem;">${state.loggedInUser ? `Welcome back, ${userProfile.name}!` : `Welcome to DIMS!`}</h2>
                        <p>Here's a quick overview of your school.</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="card" onclick="navigate('admission')" style="cursor:pointer; text-align:center; background: var(--success-color); color: white;">
                             <h3 style="font-size: 1.5rem;"><i class="fas fa-rocket"></i> ADMISSION OPEN</h3>
                             <p>Session 2025-26</p>
                        </div>
                        <div class="card" style="text-align:center;">
                            <h3 style="font-size: 1.5rem;"><i class="fas fa-school"></i> School Name</h3>
                             <p>${siteContent.schoolName || 'Not Set'}</p>
                        </div>
                    </div>

                    ${ state.loggedInUser?.role === 'admin' ? `
                    <div class="card">
                        <div class="card-header" style="border:none; padding-bottom: 0;"><h3><i class="fas fa-bolt"></i> Quick Actions</h3></div>
                        <div class="quick-actions-grid" style="margin-top: 15px;">
                            <button class="quick-action-btn" onclick="navigate('admission')"><i class="fas fa-user-plus"></i> Add Student</button>
                            <button class="quick-action-btn" onclick="navigate('adminStudentAttendance')"><i class="fas fa-calendar-check"></i> Student Attendance</button>
                            <button class="quick-action-btn" onclick="showUnifiedScanner()"><i class="fas fa-qrcode"></i> Scan QR</button>
                            <button class="quick-action-btn" onclick="navigate('financials', 'list', 'expenses')"><i class="fas fa-file-invoice-dollar"></i> Add Expense</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-search"></i> Quick Student Lookup</h3></div>
                        <div class="search-box-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="student-lookup-input" oninput="lookupStudent(this.value)" placeholder="Search by Name, Roll No, Admission No..." class="search-input">
                        </div>
                        <div id="student-lookup-results"></div>
                    </div>
                    ` : ''}

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
                        ${topperCardsHtml}
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="stat-card"><i class="fas fa-user-graduate"></i><h3>${(students || []).length}</h3><p>Total Students</p></div>
                        <div class="stat-card"><i class="fas fa-chalkboard-teacher"></i><h3>${(teachers || []).length}</h3><p>Total Teachers</p></div>
                        <div class="stat-card"><i class="fas fa-user-friends"></i><h3>${(staff || []).length}</h3><p>Total Staff</p></div>
                        <div class="stat-card"><i class="fas fa-dollar-sign"></i><h3>${getMonthlyFinancialData().currentMonthIncome}</h3><p>This Month's Income</p></div>
                    </div>
                    
                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
                         <div class="card home-attendance-summary">
                             <div class="card-header" style="border:none; padding-bottom: 0;"><h3><i class="fas fa-user-check"></i> Today's Student Attendance</h3></div>
                             <div class="attendance-stats">
                                <div class="stat-item present"><span class="count">${studentAttendance.present}</span><span>Present</span></div>
                                <div class="stat-item absent"><span class="count">${studentAttendance.absent}</span><span>Absent</span></div>
                            </div>
                            <div class="attendance-bar-container"><div class="attendance-bar" style="width: ${studentAttendancePercentage}%;"></div></div>
                            <p class="percentage">${studentAttendancePercentage}% of total students are present</p>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-bullhorn"></i> Notice Board</h3>
                                <button class="action-button inline" onclick="navigate('noticeBoard')">View All</button>
                            </div>
                            <div class="notice-board">${recentNoticesHtml}</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-newspaper"></i> Latest News</h3>
                                ${ state.loggedInUser?.role === 'admin' ? `<button class="action-button inline" onclick="navigate('settings', 'list', 'content')">Manage</button>` : ''}
                            </div>
                            <div class="notice-board">${latestNewsHtml}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-top: 30px;">
                         <div style="display: flex; flex-direction: column; gap: 30px;">
                            <div class="card"><div class="card-header"><h3><i class="fas fa-calendar-day"></i> Upcoming Exams</h3></div><ul class="detail-list">${upcomingExamsHtml}</ul></div>
                            ${ state.loggedInUser?.role === 'admin' ? `
                            <div class="card">
                                <div class="card-header"><h3><i class="fas fa-user-clock"></i> Recently Added Students</h3></div>
                                <div class="recent-students-scroller">
                                    <div class="scroller-inner">${recentStudentsHtml}</div>
                                </div>
                            </div>
                            ` : '' }
                        </div>
                        <div class="card"><div class="card-header"><h3><i class="fas fa-chart-line"></i> Monthly Financials</h3></div><canvas id="financials-chart"></canvas></div>
                    </div>

                    ${externalLinksHtml}
                    ${schoolPhotosHtml}
                    
                    ${ state.loggedInUser?.role === 'admin' ? `
                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-top: 30px;">
                        <div class="card">
                           <div class="card-header"><h3><i class="fas fa-users"></i> Class Strength</h3></div>
                           <ul class="detail-list" style="max-height: 300px; overflow-y: auto;">${classStrengthHtml}</ul>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-top: 30px;">
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-user-tie"></i> From the Principal's Desk</h3></div>
                            <p style="white-space: pre-wrap;">${siteContent.principalDesk || ''}</p>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-school"></i> About Our School</h3></div>
                            <p style="white-space: pre-wrap;">${siteContent.aboutSchool || ''}</p>
                        </div>
                    </div>
                    ` : ''}

                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-chalkboard-teacher"></i> Our Faculty</h3></div>
                        <div class="dashboard-grid" style="margin-top: 20px;">
                            ${ourFacultyHtml}
                        </div>
                    </div>
                </div>`;
                
                if (getEl('financials-chart')) {
                    const { income, expense, labels } = getMonthlyFinancialData();
                    new Chart(getEl('financials-chart').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Income', data: income, backgroundColor: 'var(--success-color)' },
                                { label: 'Expense', data: expense, backgroundColor: 'var(--error-color)' }
                            ]
                        },
                        options: { scales: { y: { beginAtZero: true, ticks: { color: 'var(--text-color)' } }, x: { ticks: { color: 'var(--text-color)' } } } }
                    });
                }
            }
            
            function lookupStudent(query) {
                const resultsContainer = getEl('student-lookup-results');
                if (!resultsContainer) return;
                query = query.trim().toLowerCase();
                
                if (!query) {
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                const results = (state.data.students || []).filter(s => 
                    (s.name && s.name.toLowerCase().includes(query)) ||
                    (s.rollNumber && s.rollNumber.toLowerCase().includes(query)) ||
                    (s.admissionNumber && s.admissionNumber.toLowerCase().includes(query)) ||
                    (s.contact && s.contact.includes(query))
                ).slice(0, 5);
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No students found.</p>';
                    return;
                }
                
                resultsContainer.innerHTML = results.map(s => `
                    <div class="lookup-result-item">
                        <img src="${s.photo || 'https://via.placeholder.com/50?text=S'}" alt="Photo">
                        <div style="flex-grow: 1;">
                            <strong>${s.name}</strong>
                            <p style="font-size: 0.9em; color: var(--text-muted);">Class ${s.className || 'N/A'} | Roll: ${s.rollNumber || 'N/A'}</p>
                        </div>
                        <button class="action-button inline" onclick="navigate('studentList', 'profile', '${s.id}')">View Profile</button>
                    </div>
                `).join('');
            }

            function renderStudentDashboardPage() {
                const mainContent = getEl('main-content');
                const user = state.loggedInUser;
                const schoolInfo = state.data.siteContent;

                const student = user.role === 'parent' ? findById('students', user.studentId) : user;
                if (!student) {
                    mainContent.innerHTML = renderHeader(`Error`);
                    mainContent.innerHTML += `<div class="page active"><p class="form-feedback error">Could not find linked student data.</p></div>`;
                    return;
                }
                
                mainContent.innerHTML = renderHeader(`Welcome, ${user.name}`);
                
                const { present, absent } = calculateAttendance('students', student.id);
                const totalDays = present + absent;
                const attendancePercentage = totalDays > 0 ? ((present / totalDays) * 100).toFixed(1) : '0';

                const upcomingExamsHtml = (state.data.examSchedules || [])
                    .filter(ex => new Date(ex.date) >= new Date() && ex.className === `Class ${student.className}`)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .slice(0, 5)
                    .map(ex => {
                        const examMaster = findById('examMasters', ex.examMasterId);
                        return `
                        <li class="detail-list-item">
                            <span><i class="fas fa-file-signature" style="color:var(--primary-light); margin-right:10px;"></i><strong>${ex.subject}</strong><br><small style="color:var(--text-muted)">${examMaster.name}</small></span>
                            <span>${new Date(ex.date).toLocaleDateString()} at ${ex.startTime}</span>
                        </li>
                        `
                    }).join('') || '<li>No upcoming exams scheduled for your class.</li>';
                
                const schoolPhotosHtml = (state.data.schoolPhotos && state.data.schoolPhotos.length > 0) ? `
                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-school"></i> School Gallery</h3></div>
                        <div class="school-photos-container">
                            ${state.data.schoolPhotos.slice(0, 3).map(photo => `
                                <div class="school-photo-item">
                                    <img src="${photo.image}" alt="${photo.title}">
                                    <div class="photo-title">${photo.title}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';

                mainContent.innerHTML += `<div class="page active">
                     <div class="card" style="text-align: center;">
                        <h2 style="font-size: 1.8rem; color: var(--primary-light);">${schoolInfo.schoolName || 'DIMS'}</h2>
                    </div>
                    <div class="dashboard-grid">
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('studentProfile')">
                            <i class="fas fa-user-circle"></i><h3>Profile</h3><p>View Profile</p>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('studentAttendance')">
                            <i class="fas fa-calendar-check"></i><h3>Attendance</h3><p>View Attendance</p>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('studentHomework')">
                            <i class="fas fa-book-open"></i><h3>Homework</h3><p>View Homework</p>
                        </div>
                         <div class="stat-card" style="cursor: pointer;" onclick="navigate('admitCardPortal')">
                            <i class="fas fa-id-card"></i><h3>Admit Card</h3><p>Get Admit Card</p>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('resultPortal')">
                            <i class="fas fa-award"></i><h3>Result</h3><p>Check Result</p>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="showUnifiedScanner()">
                            <i class="fas fa-qrcode"></i><h3>Scan QR</h3><p>Mark Attendance</p>
                        </div>
                    </div>
                     <div class="card">
                        <div class="card-header"><h3>Attendance Summary</h3></div>
                        <div class="attendance-stats">
                            <div class="stat-item present"><span class="count">${present}</span><span>Present</span></div>
                            <div class="stat-item absent"><span class="count">${absent}</span><span>Absent</span></div>
                        </div>
                        <div class="attendance-bar-container"><div class="attendance-bar" style="width: ${attendancePercentage}%;"></div></div>
                        <p class="percentage">${attendancePercentage}% Overall Attendance</p>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Upcoming Exams</h3></div>
                        <ul class="detail-list">${upcomingExamsHtml}</ul>
                    </div>
                     ${schoolPhotosHtml}
                </div>`;
            }

            function renderTeacherDashboardPage() {
                const mainContent = getEl('main-content');
                const user = state.loggedInUser;
                const schoolInfo = state.data.siteContent;

                mainContent.innerHTML = renderHeader(`Welcome, ${user.name}`);
                
                 const schoolPhotosHtml = (state.data.schoolPhotos && state.data.schoolPhotos.length > 0) ? `
                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-school"></i> School Gallery</h3></div>
                        <div class="school-photos-container">
                            ${state.data.schoolPhotos.slice(0, 3).map(photo => `
                                <div class="school-photo-item">
                                    <img src="${photo.image}" alt="${photo.title}">
                                    <div class="photo-title">${photo.title}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';

                mainContent.innerHTML += `<div class="page active">
                    <div class="card" style="background: var(--primary-gradient); color: white;">
                        <h2 style="font-size: 1.8rem;">Teacher Dashboard</h2>
                        <p>Manage your classes and academic activities from here.</p>
                    </div>
                     <div class="dashboard-grid">
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('academics', 'list', 'homework')">
                            <i class="fas fa-book-open"></i><h3>Homework</h3><p>Manage Homework</p>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('adminStudentAttendance')">
                           <i class="fas fa-calendar-check"></i><h3>Attendance</h3><p>Take Attendance</p>
                        </div>
                         <div class="stat-card" style="cursor: pointer;" onclick="showUnifiedScanner()">
                           <i class="fas fa-qrcode"></i><h3>Scan Student QR</h3><p>For Attendance</p>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('resultPortal')">
                            <i class="fas fa-award"></i><h3>Results</h3><p>View Results</p>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('noticeBoard')">
                            <i class="fas fa-bullhorn"></i><h3>Notice Board</h3><p>View Notices</p>
                        </div>
                    </div>
                    ${schoolPhotosHtml}
                </div>`;
            }

            function getTodaysAttendanceSummary(type = 'students') {
                const today = new Date().toISOString().slice(0, 10);
                let attendanceSource;
                if(type === 'students') attendanceSource = state.data.studentAttendance;
                else if (type === 'teachers') attendanceSource = state.data.teacherAttendance;
                else if (type === 'staff') attendanceSource = state.data.staffAttendance;
                else return { present: 0, absent: 0, totalMarked: 0, absentMembers: [] };

                const todaysRecords = attendanceSource[today] || {};
                const memberList = state.data[type] || [];

                let present = 0;
                let absent = 0;
                
                if (!memberList || memberList.length === 0) {
                    return { present: 0, absent: 0, totalMarked: 0, absentMembers: [] };
                }

                memberList.forEach(member => {
                    if (todaysRecords.hasOwnProperty(member.id)) {
                       if (todaysRecords[member.id] === 'present') {
                           present++;
                       } else if (todaysRecords[member.id] === 'absent') {
                           absent++;
                       }
                    }
                });
                
                const totalMarked = present + absent;
                return { present, absent, totalMarked };
            }

            function renderAdmissionPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('New Admission');
                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header">
                            <h3>Start a New Admission (2025-26)</h3>
                        </div>
                        <p>Click the button below to open the new student admission form.</p>
                        <button class="action-button" style="margin-top:20px; font-size: 1.1rem; padding: 15px 30px;" onclick="showAdmissionForm()"><i class="fas fa-user-plus"></i> Open Admission Form</button>
                    </div>
                </div>`;
            }

            function showAdmissionForm() {
                const classOptions = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
                    .map(c => `<option value="${c}">Class ${c}</option>`).join('');
                
                const formContent = `
                    <form id="admission-form">
                        <h3 style="color: var(--primary-light); margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Personal Details</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="admission-name">Full Name</label><input type="text" id="admission-name" required></div>
                            <div class="form-group"><label for="admission-father-name">Father's Name</label><input type="text" id="admission-father-name" required></div>
                             <div class="form-group"><label for="admission-mother-name">Mother's Name</label><input type="text" id="admission-mother-name" required></div>
                            <div class="form-group"><label for="admission-guardian-name">Guardian's Name</label><input type="text" id="admission-guardian-name" required></div>
                            <div class="form-group"><label for="admission-dob">Date of Birth</label><input type="text" id="admission-dob" placeholder="YYYY-MM-DD" required></div>
                            <div class="form-group"><label for="admission-gender">Gender</label><select id="admission-gender" required><option value="">Select Gender</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div>
                            <div class="form-group"><label for="admission-category">Category</label><select id="admission-category" required><option value="">Select Category</option><option value="General">General</option><option value="OBC">OBC</option><option value="SC">SC</option><option value="ST">ST</option></select></div>
                        </div>
                        
                        <h3 style="color: var(--primary-light); margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Contact & Login</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="admission-guardian-contact">Guardian's Contact Number (For Parent Login)</label><input type="tel" id="admission-guardian-contact" pattern="[0-9]{10}" title="Please enter a 10-digit phone number" required></div>
                            <div class="form-group"><label for="admission-contact">Student's Contact (Optional)</label><input type="tel" id="admission-contact" pattern="[0-9]{10}" title="Please enter a 10-digit phone number"></div>
                            <div class="form-group"><label for="admission-email">Email</label><input type="email" id="admission-email" ></div>
                            <div class="form-group"><label for="admission-password">Password</label><input type="password" id="admission-password" required placeholder="Create a password for student & parent"></div>
                        </div>
                        <div class="form-group"><label for="admission-address">Address</label><textarea id="admission-address" rows="3" required></textarea></div>
                        <div class="form-group"><label for="admission-pincode">Pin Code</label><input type="text" id="admission-pincode" value="221107" required></div>

                        <h3 style="color: var(--primary-light); margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Academic Details</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="admission-board">Board</label><select id="admission-board" required><option value="UP Board">UP Board</option><option value="CBSE Board">CBSE Board</option></select></div>
                             <div class="form-group">
                                <label for="admission-class">Select Class</label>
                                <select id="admission-class" required onchange="toggleStreamSelection(this.value)">
                                    <option value="">Select a Class</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div class="form-group" id="stream-group" style="display: none;">
                                <label for="admission-stream">Select Stream</label>
                                <select id="admission-stream">
                                    <option value="Science-Math">Science (Math)</option>
                                    <option value="Science-Bio">Science (Bio)</option>
                                    <option value="Commerce">Commerce</option>
                                    <option value="Arts">Arts</option>
                                </select>
                            </div>
                        </div>

                        <h3 style="color: var(--primary-light); margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Documents & Photo</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="admission-photo">Student's Photo</label><input type="file" id="admission-photo" accept="image/*" required></div>
                            <div class="form-group"><label for="admission-doc-aadhar">Aadhar Card (PDF/Image)</label><input type="file" id="admission-doc-aadhar" accept="image/*,application/pdf"></div>
                            <div class="form-group"><label for="admission-doc-signature">Signature</label><input type="file" id="admission-doc-signature" accept="image/*"></div>
                        </div>
                        
                        <button type="submit" class="action-button" style="width: 100%; margin-top: 20px;">Proceed to Payment</button>
                    </form>
                `;

                showModal('New Student Admission Form', formContent, '900px');
                getEl('admission-form').onsubmit = handleAdmissionSubmit;
            }

            window.toggleStreamSelection = (className) => {
                const streamGroup = getEl('stream-group');
                if (className === '11' || className === '12') {
                    streamGroup.style.display = 'block';
                } else {
                    streamGroup.style.display = 'none';
                }
            };
            
            async function handleAdmissionSubmit(e) {
                e.preventDefault();
                getEl('loading-overlay').style.display = 'flex';
                
                try {
                    const studentId = Date.now().toString();
                    const admissionNumber = `ADM-${Date.now().toString().slice(-6)}`;
                    
                    const nextRollNumber = (state.data.students || []).length + 1;
                    const newRollNumber = `RN${new Date().getFullYear()}${(nextRollNumber).toString().padStart(4, '0')}`;
                    
                    const photoFile = getEl('admission-photo').files[0];
                    if (!photoFile) {
                        showToast("Student photo is required.", "error");
                        getEl('loading-overlay').style.display = 'none';
                        return;
                    }
                    
                    const aadharFile = getEl('admission-doc-aadhar').files[0];
                    const signatureFile = getEl('admission-doc-signature').files[0];

                    const studentPhoto = await fileToBase64(photoFile);
                    let studentDocs = [];
                    if(aadharFile) studentDocs.push({ name: "Aadhar Card", data: await fileToBase64(aadharFile), filename: aadharFile.name });
                    if(signatureFile) studentDocs.push({ name: "Signature", data: await fileToBase64(signatureFile), filename: signatureFile.name });

                    // Store data temporarily, don't save yet
                    state.pendingAdmissionData = {
                        id: studentId,
                        admissionNumber,
                        rollNumber: newRollNumber,
                        name: getEl('admission-name').value.trim(),
                        fatherName: getEl('admission-father-name').value.trim(),
                        motherName: getEl('admission-mother-name').value.trim(),
                        guardianName: getEl('admission-guardian-name').value.trim(),
                        guardianContact: getEl('admission-guardian-contact').value.trim(),
                        category: getEl('admission-category').value,
                        dob: getEl('admission-dob').value,
                        gender: getEl('admission-gender').value,
                        email: getEl('admission-email').value.trim(),
                        contact: getEl('admission-contact').value.trim(),
                        password: btoa(getEl('admission-password').value),
                        address: getEl('admission-address').value.trim(),
                        pincode: getEl('admission-pincode').value.trim(),
                        photo: studentPhoto,
                        board: getEl('admission-board').value,
                        className: getEl('admission-class').value,
                        stream: (getEl('admission-class').value === '11' || getEl('admission-class').value === '12') ? getEl('admission-stream').value : null,
                        documents: studentDocs
                    };
                    
                    getEl('loading-overlay').style.display = 'none';
                    showPaymentGatewayModal(100);
                } catch (err) {
                    console.error("Admission Error:", err);
                    getEl('loading-overlay').style.display = 'none';
                    showToast('Admission failed. Please check all fields and try again.', 'error');
                }
            }
            
            function showPaymentGatewayModal(amount) {
                const modalContent = `
                    <div class="payment-gateway-card">
                        <h3>Complete Your Payment</h3>
                        <p>Total Amount to Pay</p>
                        <h2 style="font-size: 2.5rem; color: var(--primary-light); margin: 10px 0;">${amount}</h2>
                        
                        <div class="upi-info">
                            <p>Scan the QR code with any UPI app or pay to the UPI ID below.</p>
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=upi://pay?pa=9455597760-2@ybl%26pn=Rahul%20Patel%26am=${amount}%26cu=INR" alt="UPI QR Code">
                            <p><strong>Name:</strong> Rahul Patel</p>
                            <p><strong>UPI ID:</strong> <span class="upi-id">9455597760-2@ybl</span></p>
                        </div>

                        <p style="color: var(--text-muted); font-size: 0.9em;">After completing the payment, click the button below to confirm your admission.</p>

                        <button class="action-button" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.1rem;" onclick="finalizeAdmission(${amount})">
                            <i class="fas fa-check-circle"></i> I have paid, Finalize Admission
                        </button>
                    </div>
                `;
                showModal("Admission Fee Payment", modalContent, '500px');
            }

            function finalizeAdmission(paidAmount) {
                if (!state.pendingAdmissionData) {
                    showToast("Error: No pending admission data found.", "error");
                    closeModal();
                    return;
                }

                const studentData = state.pendingAdmissionData;
                updateOrAddItem('students', studentData);

                const transaction = {
                    id: Date.now().toString() + 'T',
                    studentId: studentData.id,
                    amount: paidAmount,
                    date: new Date().toISOString().slice(0,10),
                    type: 'Admission Fee'
                };
                updateOrAddItem('transactions', transaction);

                state.pendingAdmissionData = null; // Clear pending data
                
                closeModal();
                showAdmissionReceipt(studentData, paidAmount);
                showToast('Admission Successful!', 'success');
            }

            function showAdmissionReceipt(student, feePaid) {
                const schoolInfo = state.data.siteContent;
                const academicInfo = student.stream ? `Class ${student.className} (${student.stream})` : `Class ${student.className}`;

                const receiptContent = `
                    <div class="printable-area">
                        <div class="receipt-container">
                             <div class="receipt-header">
                                <h2>${schoolInfo.schoolName || 'School Name'}</h2>
                                <p>${schoolInfo.schoolAddress || 'School Address'}</p>
                                <h3>ADMISSION RECEIPT</h3>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px;">
                                <div>
                                    <p><strong>Admission No:</strong> ${student.admissionNumber}</p>
                                    <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                                    <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                                </div>
                                <img src="${student.photo}" alt="Student Photo" class="receipt-student-photo">
                            </div>

                            <dl class="receipt-details-grid">
                                <dt>Student Name:</dt><dd>${student.name}</dd>
                                <dt>Father's Name:</dt><dd>${student.fatherName}</dd>
                                <dt>Board:</dt><dd>${student.board}</dd>
                                <dt>Class:</dt><dd>${academicInfo}</dd>
                                <dt style="color: var(--success-color); font-size: 1.1rem;">Fee Paid:</dt>
                                <dd style="color: var(--success-color); font-size: 1.1rem; font-weight: bold;">${feePaid.toLocaleString()}</dd>
                            </dl>

                            <div class="receipt-footer">
                                <div class="receipt-signature">
                                    <div class="receipt-signature-line"></div>
                                    <p>Authorized Signature</p>
                                </div>
                                <p>This is a computer-generated receipt.</p>
                            </div>
                        </div>
                    </div>
                    <button class="action-button no-print" style="margin-top: 20px;" onclick="printContent('.printable-area')"><i class="fas fa-print"></i> Print Receipt</button>
                `;
                showModal('Admission Receipt', receiptContent, '800px');
            }

            function showFeeReceipt(studentId, transactionId) {
                const schoolInfo = state.data.siteContent;
                const student = findById('students', studentId);
                const transaction = findById('transactions', transactionId);
                if (!student || !transaction) return showToast("Receipt not found", "error");

                const receiptContent = `
                    <div class="printable-area">
                        <div class="receipt-container">
                             <div class="receipt-header">
                                <h2>${schoolInfo.schoolName || 'School Name'}</h2>
                                <p>${schoolInfo.schoolAddress || 'School Address'}</p>
                                <h3>FEE RECEIPT</h3>
                            </div>
                            <div style="margin-bottom: 25px;">
                                <p><strong>Receipt No:</strong> ${transaction.id}</p>
                                <p><strong>Date:</strong> ${new Date(transaction.date).toLocaleDateString()}</p>
                            </div>
                            <dl class="receipt-details-grid">
                                <dt>Admission No:</dt><dd>${student.admissionNumber}</dd>
                                <dt>Roll No:</dt><dd>${student.rollNumber}</dd>
                                <dt>Student Name:</dt><dd>${student.name}</dd>
                                <dt>Amount Paid:</dt><dd style="font-weight: bold; font-size: 1.1rem;">${Number(transaction.amount).toLocaleString()}</dd>
                                <dt>Payment For:</dt><dd>${transaction.type || 'Fee Payment'}</dd>
                            </dl>
                            <div class="receipt-footer">
                                <div class="receipt-signature">
                                    <div class="receipt-signature-line"></div>
                                    <p>Authorized Signature</p>
                                </div>
                                <p>Thank you for your payment.</p>
                            </div>
                        </div>
                    </div>
                    <button class="action-button no-print" style="margin-top: 20px;" onclick="printContent('.printable-area')"><i class="fas fa-print"></i> Print Receipt</button>
                `;
                showModal('Fee Payment Receipt', receiptContent, '800px');
            }


            function renderNoticeBoardPage() {
                const mainContent = getEl('main-content');
                
                const userRole = state.loggedInUser?.role || 'guest';
                const actionsHtml = userRole === 'admin' ? `<button class="action-button inline" onclick="showNoticeForm()"><i class="fas fa-plus"></i> Add Notice</button>` : '';

                mainContent.innerHTML = renderHeader('Notice Board', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="table-container"><table id="notices-table"></table></div></div></div>`;
                renderNoticesTable();
            }

            function renderNoticesTable() {
                const table = getEl('notices-table');
                if(!table) return;
                const userRole = state.loggedInUser?.role || 'guest';
                const { notices } = state.data;
                let html = `<thead><tr><th>Title</th><th>Content</th><th>Date</th>`;
                if(userRole === 'admin') html += `<th>Actions</th>`;
                html += `</tr></thead><tbody>`;

                if (!notices || notices.length === 0) {
                     html += `<tr><td colspan="${userRole === 'admin' ? 4 : 3}" style="text-align:center;">No notices found.</td></tr>`;
                } else { 
                    notices.sort((a,b) => b.id - a.id).forEach(n => { 
                        html += `<tr><td>${n.title}</td><td>${n.content}</td><td>${new Date(n.id).toLocaleString()}</td>`;
                        if(userRole === 'admin') {
                           html += `<td class="action-buttons">
                                        <button class="edit-btn" onclick="showNoticeForm('${n.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn" onclick="deleteItem('notices', '${n.id}', 'Are you sure you want to delete this notice?', renderNoticesTable)" title="Delete"><i class="fas fa-trash"></i></button>
                                    </td>`;
                        }
                        html += `</tr>`;
                    }); 
                }
                html += '</tbody>'; 
                table.innerHTML = html;
            }

            function showNoticeForm(id = null) {
                const notice = id ? findById('notices', id) : {};
                const title = id ? 'Edit Notice' : 'Add New Notice';
                const formContent = `<form id="notice-form"><input type="hidden" id="notice-id" value="${notice.id || ''}"><div class="form-group"><label for="notice-title">Title</label><input type="text" id="notice-title" value="${notice.title || ''}" required></div><div class="form-group"><label for="notice-content">Content</label><textarea id="notice-content" rows="5" required>${notice.content || ''}</textarea></div><button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Notice'}</button></form>`;
                showModal(title, formContent);
                getEl('notice-form').onsubmit = e => { e.preventDefault(); const noticeData = { id: getEl('notice-id').value || Date.now(), title: getEl('notice-title').value, content: getEl('notice-content').value }; updateOrAddItem('notices', noticeData); showToast(`Notice ${id ? 'updated' : 'added'}!`, 'success'); closeModal(); renderNoticesTable(); if (state.currentPage === 'home') renderHomePage(); };
            }

            function renderEventsPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showEventForm()"><i class="fas fa-plus"></i> Add Event</button>`;
                mainContent.innerHTML = renderHeader('School Events', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="table-container"><table id="events-table"></table></div></div></div>`;
                renderEventsTable();
            }

            function renderEventsTable() {
                const table = getEl('events-table');
                if(!table) return;
                const { events } = state.data;
                let html = `<thead><tr><th>Title</th><th>Description</th><th>Event Date</th><th>Actions</th></tr></thead><tbody>`;

                if (!events || events.length === 0) {
                     html += `<tr><td colspan="4" style="text-align:center;">No events found.</td></tr>`;
                } else { 
                    events.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(event => { 
                        html += `<tr>
                                    <td>${event.title}</td>
                                    <td>${event.description}</td>
                                    <td>${new Date(event.date).toLocaleDateString()}</td>
                                    <td class="action-buttons">
                                        <button class="edit-btn" onclick="showEventForm('${event.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn" onclick="deleteItem('events', '${event.id}', 'Are you sure you want to delete this event?', renderEventsTable)" title="Delete"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>`;
                    }); 
                }
                html += '</tbody>'; 
                table.innerHTML = html;
            }

            function showEventForm(id = null) {
                const event = id ? findById('events', id) : {};
                const title = id ? 'Edit Event' : 'Add New Event';
                const formContent = `<form id="event-form">
                    <input type="hidden" id="event-id" value="${event.id || ''}">
                    <div class="form-group"><label for="event-title">Title</label><input type="text" id="event-title" value="${event.title || ''}" required></div>
                    <div class="form-group"><label for="event-description">Description</label><textarea id="event-description" rows="5" required>${event.description || ''}</textarea></div>
                    <div class="form-group"><label for="event-date">Event Date</label><input type="date" id="event-date" value="${event.date || ''}" required></div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Event'}</button>
                </form>`;
                showModal(title, formContent);
                getEl('event-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const eventData = { 
                        id: getEl('event-id').value || Date.now(), 
                        title: getEl('event-title').value, 
                        description: getEl('event-description').value,
                        date: getEl('event-date').value
                    }; 
                    updateOrAddItem('events', eventData); 
                    showToast(`Event ${id ? 'updated' : 'added'}!`, 'success'); 
                    closeModal(); 
                    renderEventsTable(); 
                    if (state.currentPage === 'home') renderHomePage();
                };
            }

            function renderBookListPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showBookForm()"><i class="fas fa-plus"></i> Add Book</button>`;
                mainContent.innerHTML = renderHeader('Library - Book List', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card">
                    <div class="search-box-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="book-search-input" oninput="renderBookTable(this.value)" placeholder="Search by Title, Author, or Book ID..." class="search-input">
                    </div>
                    <div class="table-container"><table id="books-table"></table></div>
                </div></div>`;
                renderBookTable();
            }

            function renderBookTable(searchTerm = '') {
                const table = getEl('books-table');
                if(!table) return;
                const bookList = (state.data.books || []).filter(b => searchTerm ? 
                    (b.title.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (b.author.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (b.bookId.toLowerCase().includes(searchTerm.toLowerCase()))
                    : true);

                let head = `<thead><tr><th>Book ID</th><th>Title</th><th>Author</th><th>Available Copies</th><th>Actions</th></tr></thead>`;
                let body = `<tbody>`;
                if (bookList.length === 0) {
                     body += `<tr><td colspan="5" style="text-align:center;">No books found.</td></tr>`;
                } else {
                     bookList.sort((a, b) => (a.title > b.title) ? 1 : -1).forEach(b => { 
                        const issuedCount = (state.data.issuedBooks || []).filter(ib => ib.bookId === b.id && !ib.returnDate).length;
                        const availableCopies = b.copies - issuedCount;
                        body += `<tr>
                            <td><strong>${b.bookId}</strong></td>
                            <td>${b.title}</td>
                            <td>${b.author}</td>
                            <td>${availableCopies} / ${b.copies}</td>
                            <td class="action-buttons">
                                <button class="edit-btn" onclick="showBookForm('${b.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteItem('books', '${b.id}', 'Are you sure you want to delete this book?', renderBookTable)" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`; 
                    });
                }
                table.innerHTML = head + body + `</tbody>`;
            }
            
            function showBookForm(id = null) {
                const book = id ? findById('books', id) : {};
                const title = id ? 'Edit Book' : 'Add New Book';
                const formContent = `<form id="book-form">
                    <input type="hidden" id="book-id" value="${book.id || ''}">
                    <div class="form-group"><label for="book-title">Title</label><input type="text" id="book-title" value="${book.title || ''}" required></div>
                    <div class="form-group"><label for="book-author">Author</label><input type="text" id="book-author" value="${book.author || ''}" required></div>
                    <div class="form-group"><label for="book-copies">Total Copies</label><input type="number" id="book-copies" value="${book.copies || '1'}" min="1" required></div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Book'}</button>
                </form>`;
                showModal(title, formContent);
                getEl('book-form').onsubmit = e => {
                    e.preventDefault();
                    const bookData = {
                        id: getEl('book-id').value || Date.now().toString(),
                        bookId: book.bookId || `BOOK-${Date.now().toString().slice(-6)}`,
                        title: getEl('book-title').value,
                        author: getEl('book-author').value,
                        copies: parseInt(getEl('book-copies').value),
                    };
                    updateOrAddItem('books', bookData);
                    showToast(`Book ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal();
                    renderBookTable();
                };
            }

            function renderIssueReturnPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Library - Issue & Return');
                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Issue a New Book</h3></div>
                        <form id="issue-book-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="issue-student-id">Student Admission No.</label>
                                    <input type="text" id="issue-student-id" required>
                                </div>
                                <div class="form-group">
                                    <label for="issue-book-id">Book ID</label>
                                    <input type="text" id="issue-book-id" required>
                                </div>
                            </div>
                            <button type="submit" class="action-button">Issue Book</button>
                        </form>
                    </div>

                    <div class="card">
                        <div class="card-header"><h3>Currently Issued Books</h3></div>
                        <div class="table-container"><table id="issued-books-table"></table></div>
                    </div>
                </div>`;
                renderIssuedBooksTable();
                getEl('issue-book-form').onsubmit = handleIssueBook;
            }
            
            function handleIssueBook(e) {
                e.preventDefault();
                const studentAdmNo = getEl('issue-student-id').value;
                const bookIdentifier = getEl('issue-book-id').value;

                const student = (state.data.students || []).find(s => s.admissionNumber === studentAdmNo);
                const book = (state.data.books || []).find(b => b.bookId === bookIdentifier);

                if(!student) return showToast('Student not found with this Admission No.', 'error');
                if(!book) return showToast('Book not found with this Book ID.', 'error');
                
                const issuedCount = (state.data.issuedBooks || []).filter(ib => ib.bookId === book.id && !ib.returnDate).length;
                if(issuedCount >= book.copies) return showToast('All copies of this book are currently issued.', 'error');

                const issueData = {
                    id: Date.now().toString(),
                    studentId: student.id,
                    bookId: book.id,
                    issueDate: new Date().toISOString().slice(0, 10),
                    returnDate: null
                };

                updateOrAddItem('issuedBooks', issueData);
                showToast(`Book "${book.title}" issued to ${student.name}.`, 'success');
                e.target.reset();
                renderIssuedBooksTable();
                renderBookTable();
            }
            
            function renderIssuedBooksTable() {
                const table = getEl('issued-books-table');
                if (!table) return;

                const issuedList = (state.data.issuedBooks || []).filter(ib => !ib.returnDate);
                let html = `<thead><tr><th>Book Title</th><th>Student Name</th><th>Issue Date</th><th>Action</th></tr></thead><tbody>`;

                if(issuedList.length === 0) {
                    html += `<tr><td colspan="4" style="text-align:center;">No books are currently issued.</td></tr>`;
                } else {
                    issuedList.sort((a,b) => new Date(b.issueDate) - new Date(a.issueDate)).forEach(ib => {
                        const book = findById('books', ib.bookId);
                        const student = findById('students', ib.studentId);
                        if(book && student) {
                             html += `<tr>
                                <td>${book.title}</td>
                                <td>${student.name}</td>
                                <td>${new Date(ib.issueDate).toLocaleDateString()}</td>
                                <td><button class="action-button secondary" onclick="handleReturnBook('${ib.id}')">Return</button></td>
                            </tr>`;
                        }
                    });
                }
                html += `</tbody>`;
                table.innerHTML = html;
            }

            function handleReturnBook(issueId) {
                if(confirm('Are you sure this book is being returned?')) {
                    const issuedBook = findById('issuedBooks', issueId);
                    if(issuedBook) {
                        issuedBook.returnDate = new Date().toISOString().slice(0, 10);
                        updateOrAddItem('issuedBooks', issuedBook);
                        showToast('Book marked as returned.', 'success');
                        renderIssuedBooksTable();
                        renderBookTable();
                    }
                }
            }


            function renderTeacherPage() {
                if (state.currentView === 'profile' && state.currentItemId) {
                    renderTeacherProfilePage(state.currentItemId);
                } else {
                    renderTeacherListPage();
                }
            }

            function renderTeacherListPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showTeacherForm()"><i class="fas fa-plus"></i> Add Teacher</button>`;
                mainContent.innerHTML = renderHeader('Teacher Management', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>Teacher List</h3></div>
                             <div class="search-box-container">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" id="teacher-search-input" oninput="renderTeacherTable(this.value)" placeholder="Search by Name, Employee ID..." class="search-input">
                                </div>
                            <div class="table-container"><table id="teachers-table"></table></div></div></div>`;
                renderTeacherTable();
            }

            function renderTeacherTable(searchTerm = '') {
                const table = getEl('teachers-table');
                if (!table) return;
                const teacherList = (state.data.teachers || []).filter(t => searchTerm ? 
                    (t.name && t.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (t.employeeId && t.employeeId.toLowerCase().includes(searchTerm.toLowerCase()))
                    : true);

                let head = `<thead><tr><th>Photo</th><th>Employee ID</th><th>Name</th><th>Role/Subject</th><th>Contact</th><th>Actions</th></tr></thead>`;
                let body = `<tbody>`;
                if (teacherList.length === 0) {
                     body += `<tr><td colspan="6" style="text-align:center;">No teachers found.</td></tr>`;
                } else {
                     teacherList.sort((a, b) => (a.name > b.name) ? 1 : -1).forEach(t => { 
                        body += `<tr>
                            <td><img src="${t.photo || 'https://via.placeholder.com/45?text=T'}" alt="Photo" class="table-photo"></td>
                            <td><strong>${t.employeeId || 'N/A'}</strong></td>
                            <td>${t.name}</td>
                            <td>${t.role}</td>
                            <td>${t.contact}</td>
                            <td class="action-buttons">
                                <button class="view-btn" onclick="navigate('teacherList', 'profile', '${t.id}')" title="View Profile"><i class="fas fa-eye"></i></button>
                                <button class="edit-btn" onclick="showTeacherForm('${t.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteItem('teachers', '${t.id}', 'Are you sure you want to delete this teacher?', renderTeacherTable)" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`; 
                    });
                }
                table.innerHTML = head + body + `</tbody>`;
            }

            async function showTeacherForm(id = null) {
                const teacher = id ? findById('teachers', id) : {};
                const title = id ? 'Edit Teacher' : 'Add New Teacher';
                const formContent = `<form id="teacher-form">
                        <input type="hidden" id="teacher-id" value="${teacher.id || ''}">
                        <div class="form-grid">
                            <div class="form-group"><label for="teacher-name">Full Name</label><input type="text" id="teacher-name" value="${teacher.name || ''}" required></div>
                            <div class="form-group"><label for="teacher-role">Role / Subject Taught</label><input type="text" id="teacher-role" value="${teacher.role || ''}" placeholder="e.g., Maths Teacher" required></div>
                            <div class="form-group"><label for="teacher-email">Email</label><input type="email" id="teacher-email" value="${teacher.email || ''}"></div>
                            <div class="form-group"><label for="teacher-contact">Contact Number</label><input type="tel" id="teacher-contact" value="${teacher.contact || ''}" required></div>
                             <div class="form-group"><label for="teacher-dob">Date of Birth</label><input type="text" id="teacher-dob" placeholder="YYYY-MM-DD" value="${teacher.dob || ''}" required></div>
                            <div class="form-group"><label for="teacher-password">Password</label><input type="password" id="teacher-password" ${id && teacher.password ? 'placeholder="Leave blank to keep unchanged"' : 'required'}></div>
                        </div>
                        <div class="form-group"><label for="teacher-photo">Teacher's Photo</label><input type="file" id="teacher-photo" accept="image/*"><input type="hidden" id="teacher-photo-base64" value="${teacher.photo || ''}"></div>
                        <button type="submit" class="action-button" style="width: 100%; margin-top: 20px;">${id ? 'Save Changes' : 'Add Teacher'}</button>
                    </form>`;
                showModal(title, formContent, '800px');
                getEl('teacher-photo').onchange = async (e) => { if (e.target.files[0]) getEl('teacher-photo-base64').value = await fileToBase64(e.target.files[0]); };
                getEl('teacher-form').onsubmit = (e) => { 
                    e.preventDefault();
                    const newPassword = getEl('teacher-password').value;
                    const teacherData = { 
                        ...teacher,
                        id: getEl('teacher-id').value || Date.now().toString(), 
                        employeeId: teacher.employeeId || `EMP-${Date.now().toString().slice(-6)}`,
                        name: getEl('teacher-name').value, 
                        role: getEl('teacher-role').value,
                        email: getEl('teacher-email').value, 
                        contact: getEl('teacher-contact').value,
                        dob: getEl('teacher-dob').value,
                        photo: getEl('teacher-photo-base64').value,
                        password: newPassword ? btoa(newPassword) : teacher.password
                    };
                    updateOrAddItem('teachers', teacherData);
                    showToast(`Teacher ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal(); 
                    if(state.currentView === 'profile') {
                       renderTeacherProfilePage(teacherData.id);
                    } else {
                       renderTeacherTable();
                    }
                };
            }
            
            function renderTeacherProfilePage(id) {
                const teacher = findById('teachers', id);
                if (!teacher) {
                    showToast('Teacher not found.', 'error');
                    return navigate('teacherList');
                }
                
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Teacher Profile', `<button class="action-button inline" onclick="navigate('teacherList')"><i class="fas fa-arrow-left"></i> Back to List</button>`);
                
                const { present, absent } = calculateAttendance('teachers', id);
                const totalDays = present + absent;
                const attendancePercentage = totalDays > 0 ? ((present / totalDays) * 100).toFixed(1) : '0';

                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="profile-grid">
                            <div class="card profile-card">
                                <img class="profile-photo" src="${teacher.photo || 'https://via.placeholder.com/150?text=No+Photo'}" alt="Teacher Photo">
                                <h2 style="text-align: center;">${teacher.name}</h2>
                                <p style="text-align: center; color: var(--text-muted);">${teacher.role}</p>
                                <ul class="profile-details">
                                    <li><i class="fas fa-id-card"></i> ${teacher.employeeId || 'Not Assigned'}</li>
                                    <li><i class="fas fa-envelope"></i> ${teacher.email || 'N/A'}</li>
                                    <li><i class="fas fa-phone"></i> ${teacher.contact}</li>
                                </ul>
                                 <div class="no-print" style="display: flex; justify-content: center; gap: 10px; margin-top:20px;">
                                    <button onclick="showTeacherForm('${id}')" class="action-button">Edit</button>
                                    <button onclick="showTeacherIdCard('${id}')" class="action-button"><i class="fas fa-id-card"></i> ID Card</button>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-header"><h3>Attendance Summary</h3></div>
                                    <div class="attendance-stats">
                                        <div class="stat-item present"><span class="count">${present}</span><span>Present</span></div>
                                        <div class="stat-item absent"><span class="count">${absent}</span><span>Absent</span></div>
                                    </div>
                                    <div class="attendance-bar-container"><div class="attendance-bar" style="width: ${attendancePercentage}%;"></div></div>
                                    <p class="percentage">${attendancePercentage}% Overall Attendance</p>
                                </div>
                                 <div class="card"><div class="card-header"><h3>Attendance History</h3></div><div id="attendance-history-container" style="max-height: 300px; overflow-y: auto;"></div></div>
                            </div>
                        </div>
                    </div>`;
                renderAttendanceHistory('teachers', id);
            }
            
            function showTeacherIdCard(teacherId) {
                const schoolInfo = state.data.siteContent;
                const teacher = findById('teachers', teacherId);
                if (!teacher) return;
                const modalContent = `
                    <div class="printable-area">
                        <div class="id-card">
                            <div class="id-card-header">
                                <h3>${schoolInfo.schoolName || 'School Name'}</h3>
                                <p style="font-size: 0.9em; margin-top: 5px;">TEACHER ID CARD</p>
                            </div>
                            <div class="id-card-body">
                                <img src="${teacher.photo || 'https://via.placeholder.com/100?text=T'}" alt="Photo" class="id-card-photo">
                                <h4>${teacher.name}</h4>
                                <p><strong>Employee ID:</strong> ${teacher.employeeId || 'N/A'}</p>
                                <p><strong>Role:</strong> ${teacher.role || 'N/A'}</p>
                                <div class="id-card-qr" id="id-card-qr-code"></div>
                            </div>
                        </div>
                    </div>
                     <button class="action-button no-print" style="margin-top: 20px;" onclick="printContent('.printable-area')"><i class="fas fa-print"></i> Print ID Card</button>
                `;
                showModal('Teacher ID Card', modalContent, '400px');
                if (teacher.employeeId) {
                     setTimeout(() => {
                        const qrContainer = getEl('id-card-qr-code');
                        if(qrContainer){
                           qrContainer.innerHTML = '';
                           new QRCode(qrContainer, { text: teacher.employeeId, width: 120, height: 120, colorDark : "#000000", colorLight : "#ffffff" });
                        }
                    }, 200);
                }
            }

            function renderStaffPage() {
                if (state.currentView === 'profile' && state.currentItemId) {
                    renderStaffProfilePage(state.currentItemId);
                } else {
                    renderStaffListPage();
                }
            }

            function renderStaffListPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showStaffForm()"><i class="fas fa-plus"></i> Add Staff</button>`;
                mainContent.innerHTML = renderHeader('Staff Management', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>Staff List</h3></div>
                             <div class="search-box-container">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" id="staff-search-input" oninput="renderStaffTable(this.value)" placeholder="Search by Name, Employee ID..." class="search-input">
                                </div>
                            <div class="table-container"><table id="staff-table"></table></div></div></div>`;
                renderStaffTable();
            }

            function renderStaffTable(searchTerm = '') {
                const table = getEl('staff-table');
                if (!table) return;
                const staffList = (state.data.staff || []).filter(s => searchTerm ? 
                    (s.name && s.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (s.employeeId && s.employeeId.toLowerCase().includes(searchTerm.toLowerCase()))
                    : true);

                let head = `<thead><tr><th>Photo</th><th>Employee ID</th><th>Name</th><th>Role</th><th>Contact</th><th>Actions</th></tr></thead>`;
                let body = `<tbody>`;
                if (staffList.length === 0) {
                     body += `<tr><td colspan="6" style="text-align:center;">No staff members found.</td></tr>`;
                } else {
                     staffList.sort((a, b) => (a.name > b.name) ? 1 : -1).forEach(s => { 
                        body += `<tr>
                            <td><img src="${s.photo || 'https://via.placeholder.com/45?text=S'}" alt="Photo" class="table-photo"></td>
                            <td><strong>${s.employeeId || 'N/A'}</strong></td>
                            <td>${s.name}</td>
                            <td>${s.role}</td>
                            <td>${s.contact}</td>
                            <td class="action-buttons">
                                <button class="view-btn" onclick="navigate('staffList', 'profile', '${s.id}')" title="View Profile"><i class="fas fa-eye"></i></button>
                                <button class="edit-btn" onclick="showStaffForm('${s.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteItem('staff', '${s.id}', 'Are you sure you want to delete this staff member?', renderStaffTable)" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`; 
                    });
                }
                table.innerHTML = head + body + `</tbody>`;
            }

            async function showStaffForm(id = null) {
                const staff = id ? findById('staff', id) : {};
                const title = id ? 'Edit Staff Member' : 'Add New Staff Member';
                const formContent = `<form id="staff-form">
                        <input type="hidden" id="staff-id" value="${staff.id || ''}">
                        <div class="form-grid">
                            <div class="form-group"><label for="staff-name">Full Name</label><input type="text" id="staff-name" value="${staff.name || ''}" required></div>
                            <div class="form-group"><label for="staff-role">Role</label><input type="text" id="staff-role" value="${staff.role || ''}" placeholder="e.g., Accountant, Security" required></div>
                            <div class="form-group"><label for="staff-email">Email</label><input type="email" id="staff-email" value="${staff.email || ''}"></div>
                            <div class="form-group"><label for="staff-contact">Contact Number</label><input type="tel" id="staff-contact" value="${staff.contact || ''}" required></div>
                             <div class="form-group"><label for="staff-dob">Date of Birth</label><input type="text" id="staff-dob" placeholder="YYYY-MM-DD" value="${staff.dob || ''}" required></div>
                        </div>
                        <div class="form-group"><label for="staff-photo">Staff Photo</label><input type="file" id="staff-photo" accept="image/*"><input type="hidden" id="staff-photo-base64" value="${staff.photo || ''}"></div>
                        <button type="submit" class="action-button" style="width: 100%; margin-top: 20px;">${id ? 'Save Changes' : 'Add Staff Member'}</button>
                    </form>`;
                showModal(title, formContent, '800px');
                getEl('staff-photo').onchange = async (e) => { if (e.target.files[0]) getEl('staff-photo-base64').value = await fileToBase64(e.target.files[0]); };
                getEl('staff-form').onsubmit = (e) => { 
                    e.preventDefault();
                    const staffData = { 
                        ...staff,
                        id: getEl('staff-id').value || Date.now().toString(), 
                        employeeId: staff.employeeId || `STF-${Date.now().toString().slice(-6)}`,
                        name: getEl('staff-name').value, 
                        role: getEl('staff-role').value,
                        email: getEl('staff-email').value, 
                        contact: getEl('staff-contact').value,
                        dob: getEl('staff-dob').value,
                        photo: getEl('staff-photo-base64').value,
                    };
                    updateOrAddItem('staff', staffData);
                    showToast(`Staff member ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal(); 
                    if(state.currentView === 'profile') {
                       renderStaffProfilePage(staffData.id);
                    } else {
                       renderStaffTable();
                    }
                };
            }
            
            function renderStaffProfilePage(id) {
                const staffMember = findById('staff', id);
                if (!staffMember) {
                    showToast('Staff member not found.', 'error');
                    return navigate('staffList');
                }
                
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Staff Profile', `<button class="action-button inline" onclick="navigate('staffList')"><i class="fas fa-arrow-left"></i> Back to List</button>`);
                
                const { present, absent } = calculateAttendance('staff', id);
                const totalDays = present + absent;
                const attendancePercentage = totalDays > 0 ? ((present / totalDays) * 100).toFixed(1) : '0';

                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="profile-grid">
                            <div class="card profile-card">
                                <img class="profile-photo" src="${staffMember.photo || 'https://via.placeholder.com/150?text=No+Photo'}" alt="Staff Photo">
                                <h2 style="text-align: center;">${staffMember.name}</h2>
                                <p style="text-align: center; color: var(--text-muted);">${staffMember.role}</p>
                                <ul class="profile-details">
                                    <li><i class="fas fa-id-card"></i> ${staffMember.employeeId || 'Not Assigned'}</li>
                                    <li><i class="fas fa-envelope"></i> ${staffMember.email || 'N/A'}</li>
                                    <li><i class="fas fa-phone"></i> ${staffMember.contact}</li>
                                </ul>
                                 <div class="no-print" style="display: flex; justify-content: center; gap: 10px; margin-top:20px;">
                                    <button onclick="showStaffForm('${id}')" class="action-button">Edit</button>
                                    <button onclick="showStaffIdCard('${id}')" class="action-button"><i class="fas fa-id-card"></i> ID Card</button>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-header"><h3>Attendance Summary</h3></div>
                                    <div class="attendance-stats">
                                        <div class="stat-item present"><span class="count">${present}</span><span>Present</span></div>
                                        <div class="stat-item absent"><span class="count">${absent}</span><span>Absent</span></div>
                                    </div>
                                    <div class="attendance-bar-container"><div class="attendance-bar" style="width: ${attendancePercentage}%;"></div></div>
                                    <p class="percentage">${attendancePercentage}% Overall Attendance</p>
                                </div>
                                 <div class="card"><div class="card-header"><h3>Attendance History</h3></div><div id="attendance-history-container" style="max-height: 300px; overflow-y: auto;"></div></div>
                            </div>
                        </div>
                    </div>`;
                renderAttendanceHistory('staff', id);
            }
            
            function showStaffIdCard(staffId) {
                const schoolInfo = state.data.siteContent;
                const staffMember = findById('staff', staffId);
                if (!staffMember) return;
                const modalContent = `
                    <div class="printable-area">
                        <div class="id-card">
                            <div class="id-card-header">
                                <h3>${schoolInfo.schoolName || 'School Name'}</h3>
                                <p style="font-size: 0.9em; margin-top: 5px;">STAFF ID CARD</p>
                            </div>
                            <div class="id-card-body">
                                <img src="${staffMember.photo || 'https://via.placeholder.com/100?text=S'}" alt="Photo" class="id-card-photo">
                                <h4>${staffMember.name}</h4>
                                <p><strong>Employee ID:</strong> ${staffMember.employeeId || 'N/A'}</p>
                                <p><strong>Role:</strong> ${staffMember.role || 'N/A'}</p>
                                <div class="id-card-qr" id="id-card-qr-code"></div>
                            </div>
                        </div>
                    </div>
                     <button class="action-button no-print" style="margin-top: 20px;" onclick="printContent('.printable-area')"><i class="fas fa-print"></i> Print ID Card</button>
                `;
                showModal('Staff ID Card', modalContent, '400px');
                if (staffMember.employeeId) {
                     setTimeout(() => {
                        const qrContainer = getEl('id-card-qr-code');
                        if(qrContainer){
                           qrContainer.innerHTML = '';
                           new QRCode(qrContainer, { text: staffMember.employeeId, width: 120, height: 120, colorDark : "#000000", colorLight : "#ffffff" });
                        }
                    }, 200);
                }
            }

            function renderStudentPage() {
                 if (state.currentView === 'profile' && state.currentItemId) {
                    renderStudentProfilePage(state.currentItemId);
                } else {
                    renderStudentListPage();
                }
            }

            function renderStudentListPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="navigate('admission')"><i class="fas fa-plus"></i> Add Student</button>`;
                mainContent.innerHTML = renderHeader('Students', actionsHtml);

                const preFilter = state.studentListFilter;
                let filterInfo = '';
                if (preFilter && preFilter.className) {
                    filterInfo = `
                        <div class="card" style="border-left: 4px solid var(--info-color);">
                            Showing students from <strong>Class ${preFilter.className}</strong>. 
                            <a href="#" onclick="event.preventDefault(); navigate('studentList')" style="margin-left: 15px;">Clear Filter</a>
                        </div>`;
                }
                
                mainContent.innerHTML += `<div class="page active">
                            ${filterInfo}
                            <div class="card">
                                <div class="card-header"><h3>Student List</h3></div>
                                <div class="table-controls">
                                    <div class="search-box-container">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" id="student-search-input" oninput="renderStudentTable(this.value)" placeholder="Search by Name, Roll No, Admission No..." class="search-input">
                                    </div>
                                </div>
                                <div class="table-container"><table id="students-table"></table></div>
                            </div>
                        </div>`;

                renderStudentTable();
                
                state.studentListFilter = null;
            }

            function renderStudentTable(searchTerm = '') {
                const table = getEl('students-table');
                if (!table) return;

                let students = state.data.students || [];

                const preFilter = state.studentListFilter;
                if (preFilter && preFilter.className) {
                    students = students.filter(s => s.className === preFilter.className);
                }

                if (searchTerm) {
                    searchTerm = searchTerm.toLowerCase();
                    students = students.filter(s => 
                        (s.name && s.name.toLowerCase().includes(searchTerm)) ||
                        (s.admissionNumber && s.admissionNumber.toLowerCase().includes(searchTerm)) ||
                        (s.rollNumber && s.rollNumber.toLowerCase().includes(searchTerm))
                    );
                }

                let head = `<thead><tr><th>Photo</th><th>Admission No.</th><th>Roll No.</th><th>Name</th><th>Class</th><th>Actions</th></tr></thead>`;
                let body = `<tbody>`;
                if (students.length === 0) {
                    body += `<tr><td colspan="6" style="text-align:center;">No students found.</td></tr>`;
                } else {
                    students.sort((a, b) => b.id - a.id).forEach(s => { 
                        body += `<tr>
                                <td><img src="${s.photo || 'https://via.placeholder.com/45?text=S'}" alt="Photo" class="table-photo"></td>
                                <td><strong>${s.admissionNumber || 'N/A'}</strong></td>
                                <td><strong>${s.rollNumber || 'N/A'}</strong></td>
                                <td>${s.name}</td><td>Class ${s.className || ''} ${s.stream ? `(${s.stream})` : ''}</td>
                                <td class="action-buttons">
                                <button class="view-btn" onclick="navigate('studentList', 'profile', '${s.id}')" title="View Profile"><i class="fas fa-eye"></i></button>
                                <button class="edit-btn" onclick="showStudentForm('${s.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="certificate-btn" onclick="showCertificateGenerationModal('${s.id}')" title="Generate Certificate"><i class="fas fa-certificate"></i></button>
                                <button class="delete-btn" onclick="deleteItem('students', '${s.id}', 'Are you sure you want to delete this student?', () => renderStudentTable(document.getElementById('student-search-input').value))" title="Delete"><i class="fas fa-trash"></i></button>
                                </td></tr>`; 
                    });
                }
                table.innerHTML = head + body + `</tbody>`;
            }

            function showStudentForm(id = null) {
                const student = id ? findById('students', id) : {};
                const title = id ? 'Edit Student' : 'Add New Student';
                const classOptions = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
                    .map(c => `<option value="${c}" ${student.className === c ? 'selected' : ''}>Class ${c}</option>`).join('');

                const formContent = `<form id="student-form"><input type="hidden" id="student-id" value="${student.id || ''}">
                        <div class="form-grid">
                            <div class="form-group"><label for="student-admission">Admission Number</label><input type="text" id="student-admission" value="${student.admissionNumber || ''}" ${id ? '' : 'placeholder="Will be auto-generated"'} ><small>${id ? 'You can change the admission number.' : 'Leave blank to auto-generate.'}</small></div>
                            <div class="form-group"><label for="student-roll">Roll Number</label><input type="text" id="student-roll" value="${student.rollNumber || ''}" ${id ? '' : 'placeholder="Will be auto-generated"'} ><small>${id ? 'You can change the roll number.' : 'Leave blank to auto-generate.'}</small></div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label for="student-name">Full Name</label><input type="text" id="student-name" value="${student.name || ''}" required></div>
                            <div class="form-group"><label for="student-father-name">Father's Name</label><input type="text" id="student-father-name" value="${student.fatherName || ''}" required></div>
                             <div class="form-group"><label for="student-mother-name">Mother's Name</label><input type="text" id="student-mother-name" value="${student.motherName || ''}" required></div>
                            <div class="form-group"><label for="student-guardian-name">Guardian's Name</label><input type="text" id="student-guardian-name" value="${student.guardianName || ''}" required></div>
                             <div class="form-group"><label for="student-dob">Date of Birth</label><input type="text" placeholder="YYYY-MM-DD" id="student-dob" value="${student.dob || ''}" required></div>
                            <div class="form-group"><label for="student-email">Email</label><input type="email" id="student-email" value="${student.email || ''}"></div>
                            <div class="form-group"><label for="student-guardian-contact">Guardian's Contact</label><input type="tel" id="student-guardian-contact" value="${student.guardianContact || ''}" required></div>
                            <div class="form-group"><label for="student-contact">Student's Contact</label><input type="tel" id="student-contact" value="${student.contact || ''}"></div>
                        </div>
                        <div class="form-group"><label for="student-address">Address</label><textarea id="student-address" rows="3">${student.address || ''}</textarea></div>
                        <div class="form-group"><label for="student-pincode">Pin Code</label><input type="text" id="student-pincode" value="${student.pincode || '221107'}" required></div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="student-class">Class</label>
                                <select id="student-class" onchange="toggleStreamSelection(this.value)">${classOptions}</select>
                            </div>
                            <div class="form-group" id="stream-group" style="display:${(student.className === '11' || student.className === '12') ? 'block' : 'none'};">
                                <label for="student-stream">Stream</label>
                                <select id="student-stream">
                                    <option value="Science-Math" ${student.stream === 'Science-Math' ? 'selected' : ''}>Science (Math)</option>
                                    <option value="Science-Bio" ${student.stream === 'Science-Bio' ? 'selected' : ''}>Science (Bio)</option>
                                    <option value="Commerce" ${student.stream === 'Commerce' ? 'selected' : ''}>Commerce</option>
                                    <option value="Arts" ${student.stream === 'Arts' ? 'selected' : ''}>Arts</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group"><label for="student-photo">Student Photo</label><input type="file" id="student-photo" accept="image/*"><input type="hidden" id="student-photo-base64" value="${student.photo || ''}"></div>
                        <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Student'}</button></form>`;
                showModal(title, formContent, '900px');
                getEl('student-photo').onchange = async (e) => { if (e.target.files[0]) getEl('student-photo-base64').value = await fileToBase64(e.target.files[0]); };
                getEl('student-form').onsubmit = (e) => { 
                    e.preventDefault();
                    let admissionNumber = getEl('student-admission').value.trim();
                    let rollNumber = getEl('student-roll').value.trim();
                    if (!getEl('student-id').value) {
                        if (!admissionNumber) admissionNumber = `ADM-${Date.now().toString().slice(-6)}`;
                        if (!rollNumber) {
                             const nextRollNumber = (state.data.students || []).length + 1;
                             rollNumber = `RN${new Date().getFullYear()}${(nextRollNumber).toString().padStart(4, '0')}`;
                        }
                    }
                    const studentData = { ...student, id: getEl('student-id').value || Date.now().toString(), admissionNumber, rollNumber, name: getEl('student-name').value, fatherName: getEl('student-father-name').value, motherName: getEl('student-mother-name').value, guardianName: getEl('student-guardian-name').value, guardianContact: getEl('student-guardian-contact').value, dob: getEl('student-dob').value, email: getEl('student-email').value, contact: getEl('student-contact').value, address: getEl('student-address').value, pincode: getEl('student-pincode').value, photo: getEl('student-photo-base64').value, className: getEl('student-class').value, stream: (getEl('student-class').value === '11' || getEl('student-class').value === '12') ? getEl('student-stream').value : null, documents: student.documents || [], results: student.results || [], fingerprintData: student.fingerprintData || null, password: student.password || '' };
                    updateOrAddItem('students', studentData);
                    showToast(`Student ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal(); 
                    if(state.currentView === 'profile') {
                        renderStudentProfilePage(studentData.id);
                    } else {
                        renderStudentListPage();
                    }
                };
            }

            function renderStudentProfilePage(id) {
                const student = findById('students', id);
                if (!student) {
                    showToast('Student not found.', 'error');
                    return navigate('studentList');
                }
                const studentTransactions = (state.data.transactions || []).filter(t => t.studentId === id);
                const paidFee = studentTransactions.reduce((sum, t) => sum + Number(t.amount), 0);
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Student Profile', `<button class="action-button inline" onclick="navigate('studentList')"><i class="fas fa-arrow-left"></i> Back to List</button>`);
                
                const academicInfo = student.stream ? `Class ${student.className} (${student.stream})` : `Class ${student.className}`;
                const signatureDoc = (student.documents || []).find(doc => doc.name && doc.name.toLowerCase().includes('signature'));

                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="profile-grid" id="student-profile-printable-area">
                            <div class="card profile-card">
                                <img class="profile-photo" src="${student.photo || 'https://via.placeholder.com/150?text=No+Photo'}" alt="Student Photo">
                                ${signatureDoc ? `<img src="${signatureDoc.data}" alt="Signature" style="display:block; margin: -10px auto 15px; height: 40px; max-width: 150px; object-fit: contain;">` : ''}
                                <h2 style="text-align: center;">${student.name}</h2>
                                <p style="text-align: center; color: var(--text-muted);">${student.email || 'No email'}</p>
                                <ul class="profile-details">
                                    <li><i class="fas fa-id-card"></i> Adm No: ${student.admissionNumber || 'N/A'}</li>
                                    <li><i class="fas fa-hashtag"></i> Roll No: ${student.rollNumber || 'N/A'}</li>
                                    <li><i class="fas fa-school"></i> ${academicInfo}</li>
                                     <li><i class="fas fa-user-tie"></i> Father: ${student.fatherName || 'N/A'}</li>
                                     <li><i class="fas fa-female"></i> Mother: ${student.motherName || 'N/A'}</li>
                                    <li><i class="fas fa-user-shield"></i> Guardian: ${student.guardianName || 'N/A'}</li>
                                    <li><i class="fas fa-phone"></i> Student Contact: ${student.contact || 'N/A'}</li>
                                    <li><i class="fas fa-map-marker-alt"></i> ${student.address || 'Not provided'}, ${student.pincode || ''}</li>
                                </ul>
                                <div style="text-align:center;">
                                    <div id="student-qr-code"></div>
                                </div>
                                <div class="no-print" style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top:20px;">
                                    <button onclick="showStudentForm('${id}')" class="action-button">Edit Profile</button>
                                    <button onclick="showIdCard('${id}')" class="action-button"><i class="fas fa-id-card"></i> ID Card</button>
                                    <button onclick="printContent('.profile-grid')" class="action-button"><i class="fas fa-print"></i> Print Profile</button>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-header"><h3>Financial Summary</h3></div>
                                    <p>Total Paid: ${paidFee.toLocaleString()}</p>
                                    <button onclick="showPaymentForm('${id}')" class="action-button inline no-print" style="margin-top: 15px; margin-bottom: 20px;">Add Payment</button>
                                    <h3 style="margin-top:20px;">Payment History</h3>
                                    <ul class="detail-list">
                                        ${studentTransactions.length ? studentTransactions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `<li><span>${new Date(t.date).toLocaleDateString()} - ${t.type}</span><div style="display:flex; align-items:center; gap: 10px;"><span>${Number(t.amount).toLocaleString()}</span><button class="action-button no-print" onclick="showFeeReceipt('${student.id}', '${t.id}')" style="padding: 5px 10px;" title="Print Receipt"><i class="fas fa-print"></i></button></div></li>`).join('') : '<li>No payments made.</li>'}
                                    </ul>
                                </div>
                                <div class="card"><div class="card-header"><h3>Attendance History</h3></div><div id="attendance-history-container" style="max-height: 300px; overflow-y: auto;"></div></div>
                                <div class="card"><div class="card-header"><h3>Student Documents</h3><button class="action-button inline no-print" onclick="showDocumentUploadForm('${id}')"><i class="fas fa-upload"></i> Upload</button></div><ul class="detail-list">${renderDocumentList(student)}</ul></div>
                            </div>
                        </div>
                    </div>`;
                
                if (student.admissionNumber) {
                    const qrContainer = getEl('student-qr-code');
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, { text: student.admissionNumber, width: 128, height: 128 });
                }
                renderAttendanceHistory('students', id);
            }

            function renderStudentProfileView() {
                const user = state.loggedInUser;
                const student = user.role === 'parent' ? findById('students', user.studentId) : user;

                if (!student) {
                    mainContent.innerHTML = renderHeader(`Error`);
                    mainContent.innerHTML += `<div class="page active"><p class="form-feedback error">Could not find linked student data.</p></div>`;
                    return;
                }

                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('My Profile');
                const academicInfo = student.stream ? `Class ${student.className} (${student.stream})` : `Class ${student.className}`;
                mainContent.innerHTML += `<div class="page active">
                    <div class="card profile-card" style="max-width: 500px; margin: auto;">
                        <img class="profile-photo" src="${student.photo || 'https://via.placeholder.com/150?text=No+Photo'}" alt="Student Photo">
                        <h2 style="text-align: center;">${student.name}</h2>
                         <ul class="profile-details">
                            <li><i class="fas fa-id-card"></i> Adm No: ${student.admissionNumber || 'N/A'}</li>
                            <li><i class="fas fa-hashtag"></i> Roll No: ${student.rollNumber || 'N/A'}</li>
                            <li><i class="fas fa-school"></i> ${academicInfo}</li>
                             <li><i class="fas fa-user-tie"></i> Father: ${student.fatherName || 'N/A'}</li>
                             <li><i class="fas fa-female"></i> Mother: ${student.motherName || 'N/A'}</li>
                            <li><i class="fas fa-user-shield"></i> Guardian: ${student.guardianName || 'N/A'}</li>
                            <li><i class="fas fa-mobile-alt"></i> Guardian Contact: ${student.guardianContact || 'N/A'}</li>
                            <li><i class="fas fa-phone"></i> Student Contact: ${student.contact || 'N/A'}</li>
                            <li><i class="fas fa-envelope"></i> ${student.email || 'N/A'}</li>
                            <li><i class="fas fa-map-marker-alt"></i> ${student.address || 'Not provided'}, ${student.pincode || ''}</li>
                        </ul>
                    </div>
                </div>`;
            }

            function renderStudentAttendanceView() {
                const user = state.loggedInUser;
                const student = user.role === 'parent' ? findById('students', user.studentId) : user;
                if (!student) return;

                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('My Attendance');
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>My Monthly Attendance Report</h3></div>
                    <div id="student-attendance-report-container"></div>
                </div></div>`;
                renderStudentMonthlyAttendanceReport(student.id);
            }
            
            function renderStudentMonthlyAttendanceReport(studentId) {
                const container = getEl('student-attendance-report-container');
                if(!container) return;
                const now = new Date();
                const currentYear = now.getFullYear();

                const yearOptions = Array.from({ length: 5 }, (_, i) => currentYear + i)
                    .map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
                
                const monthOptions = Array.from({ length: 12 }, (_, i) => {
                    const monthName = new Date(0, i).toLocaleString('en-US', { month: 'long' });
                    return `<option value="${i}" ${i === now.getMonth() ? 'selected' : ''}>${monthName}</option>`;
                }).join('');

                container.innerHTML = `
                    <div class="no-print" style="display:flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="student-report-month-filter">Select Month</label>
                            <select id="student-report-month-filter" onchange="displayMonthlyAttendanceReport('students', '${studentId}', true)">${monthOptions}</select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="student-report-year-filter">Select Year</label>
                            <select id="student-report-year-filter" onchange="displayMonthlyAttendanceReport('students', '${studentId}', true)">${yearOptions}</select>
                        </div>
                        <button class="action-button inline" onclick="printContent('.printable-area.attendance-report')" style="flex-shrink: 0;"><i class="fas fa-print"></i> Print Report</button>
                    </div>
                    <div id="attendance-report-container" class="printable-area attendance-report"></div>
                `;
                displayMonthlyAttendanceReport('students', studentId, true);
            }

            function renderAttendanceHistory(type, memberId) {
                const container = getEl('attendance-history-container');
                if (!container) return;

                let attendanceRecords;
                if (type === 'students') attendanceRecords = state.data.studentAttendance || {};
                else if (type === 'teachers') attendanceRecords = state.data.teacherAttendance || {};
                else if (type === 'staff') attendanceRecords = state.data.staffAttendance || {};
                else return;

                let history = [];
                for (const date in attendanceRecords) {
                    if (attendanceRecords[date][memberId]) {
                        history.push({ date: date, status: attendanceRecords[date][memberId] });
                    }
                }
                history.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (history.length === 0) {
                    container.innerHTML = `<p>No attendance records found.</p>`;
                    return;
                }
                let tableHtml = `<table class="table-container"><thead><tr><th>Date</th><th>Status</th></tr></thead><tbody>`;
                history.forEach(rec => {
                    const statusClass = rec.status === 'present' ? 'color: var(--success-color)' : 'color: var(--error-color)';
                    tableHtml += `<tr><td>${new Date(rec.date).toLocaleDateString()}</td><td style="${statusClass}; font-weight: bold;">${rec.status.charAt(0).toUpperCase() + rec.status.slice(1)}</td></tr>`;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            }
            
            function showIdCard(studentId) {
                const schoolInfo = state.data.siteContent;
                const student = findById('students', studentId);
                if (!student) return;
                const academicInfo = student.stream ? `Class ${student.className} (${student.stream})` : `Class ${student.className}`;
                const modalContent = `
                    <div class="printable-area">
                        <div class="id-card">
                            <div class="id-card-header">
                                <h3>${schoolInfo.schoolName || 'School Name'}</h3>
                            </div>
                            <div class="id-card-body">
                                <img src="${student.photo || 'https://via.placeholder.com/100?text=S'}" alt="Photo" class="id-card-photo">
                                <h4>${student.name}</h4>
                                <p><strong>Admission No:</strong> ${student.admissionNumber || 'N/A'}</p>
                                <p><strong>Roll No:</strong> ${student.rollNumber || 'N/A'}</p>
                                <p><strong>Class:</strong> ${academicInfo || 'N/A'}</p>
                                <div class="id-card-qr" id="id-card-qr-code"></div>
                            </div>
                        </div>
                    </div>
                     <button class="action-button no-print" style="margin-top: 20px;" onclick="printContent('.printable-area')"><i class="fas fa-print"></i> Print ID Card</button>
                `;
                showModal('Student ID Card', modalContent, '400px');
                if (student.admissionNumber) {
                     setTimeout(() => {
                        const qrContainer = getEl('id-card-qr-code');
                        if(qrContainer){
                           qrContainer.innerHTML = '';
                           new QRCode(qrContainer, { text: student.admissionNumber, width: 120, height: 120, colorDark : "#000000", colorLight : "#ffffff" });
                        }
                    }, 200);
                }
            }


            function renderDocumentList(student) {
                if (!student.documents || student.documents.length === 0) return '<li>No documents uploaded.</li>';
                return student.documents.map((doc, index) => `<li><span><i class="fas fa-file-alt" style="margin-right: 10px;"></i> ${doc.name}</span>
                        <div class="action-buttons no-print"><a href="${doc.data}" download="${doc.filename}" class="view-btn" title="View/Download"><i class="fas fa-download"></i></a>
                        <button class="delete-btn" onclick="deleteDocument('${student.id}', ${index})" title="Delete"><i class="fas fa-trash"></i></button></div></li>`).join('');
            }

            function showDocumentUploadForm(studentId) {
                const title = "Upload Document";
                const formContent = `<form id="document-upload-form"><div class="form-group"><label for="doc-name">Document Name</label><input type="text" id="doc-name" required></div>
                        <div class="form-group"><label for="doc-file">Select File</label><input type="file" id="doc-file" required></div>
                        <button type="submit" class="action-button">Upload Document</button></form>`;
                showModal(title, formContent);
                getEl('document-upload-form').onsubmit = async (e) => { e.preventDefault(); const student = findById('students', studentId); const file = getEl('doc-file').files[0]; const name = getEl('doc-name').value;
                    if (file && name && student) { try { const base64Data = await fileToBase64(file); if (!student.documents) student.documents = []; student.documents.push({ name, data: base64Data, filename: file.name }); updateOrAddItem('students', student); showToast("Document uploaded successfully!", "success"); closeModal(); renderStudentProfilePage(studentId); } catch (err) { showToast("File upload failed.", "error"); } } };
            }

            function deleteDocument(studentId, docIndex) { if (confirm('Are you sure you want to delete this document?')) { const student = findById('students', studentId); if (student && student.documents) { student.documents.splice(docIndex, 1); updateOrAddItem('students', student); showToast("Document deleted.", "success"); renderStudentProfilePage(studentId); } } }
            
            function renderTimetablePage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showTimetableForm()"><i class="fas fa-plus"></i> Add Timetable</button>`;
                mainContent.innerHTML = renderHeader('Class Timetables', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="gallery-grid" id="timetable-grid-container"></div></div></div>`;
                renderTimetableGrid();
            }

            function renderTimetableGrid() {
                const container = getEl('timetable-grid-container');
                if(!container) return;
                const { timetables } = state.data;
                if (!timetables || timetables.length === 0) { container.innerHTML = `<p>No timetables uploaded yet.</p>`; return; }
                container.innerHTML = timetables.sort((a,b) => b.id - a.id).map(item => `<div class="gallery-item card"><h4>${item.title}</h4><img src="${item.image}" alt="${item.title}" style="margin-top:15px;"><div class="gallery-item-footer"><button class="delete-btn" onclick="deleteItem('timetables', '${item.id}', 'Are you sure you want to delete this timetable?', renderTimetableGrid)" title="Delete"><i class="fas fa-trash"></i></button></div></div>`).join('');
            }
            function showTimetableForm() {
                const title = 'Add New Timetable';
                const formContent = `<form id="timetable-form">
                        <div class="form-group"><label for="timetable-title">Title</label><input type="text" id="timetable-title" placeholder="e.g., Class 10 Timetable" required></div>
                        <div class="form-group"><label for="timetable-image">Select Image</label><input type="file" id="timetable-image" accept="image/*" required></div>
                        <button type="submit" class="action-button">Add Timetable</button>
                    </form>`;
                showModal(title, formContent);
                getEl('timetable-form').onsubmit = async e => { 
                    e.preventDefault(); 
                    const imageFile = getEl('timetable-image').files[0]; 
                    if(!imageFile) return; 
                    const timetableData = { id: Date.now(), title: getEl('timetable-title').value, image: await fileToBase64(imageFile) }; 
                    updateOrAddItem('timetables', timetableData); 
                    showToast('Timetable added!', 'success'); 
                    closeModal(); 
                    renderTimetableGrid(); 
                };
            }

            function renderExamsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Examinations', `<button class="action-button inline" onclick="showExamMasterForm()"><i class="fas fa-plus"></i> Add New Exam</button>`);
                
                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Examinations</h3><p>Create main exams like Half-Yearly or Annual.</p></div>
                        <div class="table-container"><table id="exam-masters-table"></table></div>
                    </div>
                    <div id="exam-schedule-section" style="display:none;"></div>
                </div>`;
                renderExamMastersTable();
            }

            function renderExamMastersTable() {
                const table = getEl('exam-masters-table');
                if (!table) return;
                const { examMasters } = state.data;
                let html = `<thead><tr><th>Exam Name</th><th>Category</th><th>Result Declared On</th><th>Actions</th></tr></thead><tbody>`;
                if (!examMasters || examMasters.length === 0) {
                    html += `<tr><td colspan="4" style="text-align:center;">No exams created yet. Click 'Add New Exam'.</td></tr>`;
                } else {
                    examMasters.sort((a,b) => b.id - a.id).forEach(ex => { 
                        html += `<tr>
                            <td><strong>${ex.name}</strong></td>
                            <td>${ex.category || 'N/A'}</td>
                            <td>${ex.declarationDate ? new Date(ex.declarationDate).toLocaleDateString() : 'Not Set'}</td>
                            <td class="action-buttons">
                                <button class="schedule-btn" onclick="renderExamScheduleView('${ex.id}')" title="Manage Schedule"><i class="fas fa-calendar-alt"></i></button>
                                <button class="edit-btn" onclick="showExamMasterForm('${ex.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteExamMaster('${ex.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`; 
                    });
                }
                html += '</tbody>';
                table.innerHTML = html;
            }

            function showExamMasterForm(id = null) {
                const exam = id ? findById('examMasters', id) : {};
                const title = id ? 'Edit Exam' : 'Create New Exam';
                const formContent = `<form id="exam-master-form">
                    <input type="hidden" id="exam-master-id" value="${exam.id || ''}">
                    <div class="form-group"><label for="exam-master-name">Exam Name</label><input type="text" id="exam-master-name" value="${exam.name || ''}" placeholder="e.g., Annual Exam 2025" required></div>
                    <div class="form-group">
                        <label for="exam-master-category">Exam Category</label>
                        <select id="exam-master-category">
                            <option value="Annual Exam" ${exam.category === 'Annual Exam' ? 'selected':''}>Annual Exam</option>
                            <option value="Half-Yearly Exam" ${exam.category === 'Half-Yearly Exam' ? 'selected':''}>Half-Yearly Exam</option>
                            <option value="Unit Test" ${exam.category === 'Unit Test' ? 'selected':''}>Unit Test</option>
                             <option value="Test" ${exam.category === 'Test' ? 'selected':''}>Test</option>
                            <option value="Pre-Board" ${exam.category === 'Pre-Board' ? 'selected':''}>Pre-Board</option>
                            <option value="Other" ${exam.category === 'Other' ? 'selected':''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="exam-declaration-date">Result Declaration Date</label><input type="date" id="exam-declaration-date" value="${exam.declarationDate || ''}"></div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Create Exam'}</button>
                </form>`;
                showModal(title, formContent);
                getEl('exam-master-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const examData = { 
                        id: getEl('exam-master-id').value || Date.now().toString(), 
                        name: getEl('exam-master-name').value.trim(),
                        category: getEl('exam-master-category').value,
                        declarationDate: getEl('exam-declaration-date').value
                    }; 
                    if (!examData.name) {
                        showToast("Exam name cannot be empty.", "error");
                        return;
                    }
                    updateOrAddItem('examMasters', examData); 
                    showToast(`Exam ${id ? 'updated' : 'added'}!`, 'success'); 
                    closeModal(); 
                    renderExamMastersTable(); 
                };
            }
            
            function renderExamScheduleView(examMasterId) {
                const exam = findById('examMasters', examMasterId);
                const scheduleSection = getEl('exam-schedule-section');
                scheduleSection.style.display = 'block';
                scheduleSection.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3>Schedule for: ${exam.name}</h3>
                            <button class="action-button inline" onclick="showExamScheduleForm('${examMasterId}')"><i class="fas fa-plus"></i> Add Subject to Schedule</button>
                        </div>
                        <div class="table-container"><table id="exam-schedule-table"></table></div>
                    </div>
                `;
                renderExamScheduleTable(examMasterId);
                scheduleSection.scrollIntoView({ behavior: 'smooth' });
            }

            function renderExamScheduleTable(examMasterId) {
                const table = getEl('exam-schedule-table');
                if(!table) return;
                const schedules = state.data.examSchedules.filter(s => s.examMasterId === examMasterId);
                
                let html = `<thead><tr><th>Class</th><th>Subject</th><th>Paper Code</th><th>Exam Date</th><th>Start Time</th><th>End Time</th><th>Actions</th></tr></thead><tbody>`;
                 if (schedules.length === 0) {
                    html += `<tr><td colspan="7" style="text-align:center;">No schedule added for this exam yet.</td></tr>`;
                } else {
                    schedules.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(sch => {
                        html += `<tr>
                            <td>${sch.className}</td>
                            <td>${sch.subject}</td>
                            <td>${sch.paperCode || '-'}</td>
                            <td>${new Date(sch.date).toLocaleDateString()}</td>
                            <td>${sch.startTime}</td>
                            <td>${sch.endTime}</td>
                            <td class="action-buttons">
                                <button class="edit-btn" onclick="showExamScheduleForm('${examMasterId}', '${sch.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteItem('examSchedules', '${sch.id}', 'Delete this schedule item?', () => renderExamScheduleTable('${examMasterId}'))" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                }
                html += '</tbody>';
                table.innerHTML = html;
            }

            function showExamScheduleForm(examMasterId, scheduleId = null) {
                const schedule = scheduleId ? findById('examSchedules', scheduleId) : {};
                const title = scheduleId ? 'Edit Exam Schedule' : 'Add to Exam Schedule';
                
                const classOptions = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
                    .map(c => `<option value="Class ${c}" ${schedule.className === `Class ${c}` ? 'selected' : ''}>Class ${c}</option>`).join('');

                const formContent = `<form id="exam-schedule-form">
                    <input type="hidden" id="exam-schedule-id" value="${schedule.id || ''}">
                    <div class="form-group"><label for="exam-schedule-class">Class</label><select id="exam-schedule-class">${classOptions}</select></div>
                    <div class="form-grid">
                        <div class="form-group"><label for="exam-schedule-subject">Subject</label><input type="text" id="exam-schedule-subject" value="${schedule.subject || ''}" required></div>
                        <div class="form-group"><label for="exam-schedule-code">Paper Code</label><input type="text" id="exam-schedule-code" value="${schedule.paperCode || ''}" placeholder="e.g., HIN-101"></div>
                    </div>
                    <div class="form-group"><label for="exam-schedule-date">Exam Date</label><input type="date" id="exam-schedule-date" value="${schedule.date || new Date().toISOString().slice(0,10)}" required></div>
                    <div class="form-grid">
                        <div class="form-group"><label for="exam-schedule-start">Start Time</label><input type="time" id="exam-schedule-start" value="${schedule.startTime || '09:00'}" required></div>
                        <div class="form-group"><label for="exam-schedule-end">End Time</label><input type="time" id="exam-schedule-end" value="${schedule.endTime || '12:00'}" required></div>
                    </div>
                    <button type="submit" class="action-button">${scheduleId ? 'Save Changes' : 'Add to Schedule'}</button>
                </form>`;
                showModal(title, formContent, '700px');
                getEl('exam-schedule-form').onsubmit = e => {
                    e.preventDefault();
                    const scheduleData = {
                        id: getEl('exam-schedule-id').value || Date.now().toString(),
                        examMasterId: examMasterId,
                        className: getEl('exam-schedule-class').value,
                        subject: getEl('exam-schedule-subject').value,
                        paperCode: getEl('exam-schedule-code').value.trim(),
                        date: getEl('exam-schedule-date').value,
                        startTime: getEl('exam-schedule-start').value,
                        endTime: getEl('exam-schedule-end').value,
                    };
                    updateOrAddItem('examSchedules', scheduleData);
                    showToast('Schedule saved!', 'success');
                    closeModal();
                    renderExamScheduleTable(examMasterId);
                }
            }
            
            function deleteExamMaster(id) {
                if (confirm('DANGER! Deleting this exam will also delete all its schedules and any marks entered for it. This cannot be undone. Are you sure?')) {
                    state.data.examSchedules = (state.data.examSchedules || []).filter(sch => sch.examMasterId !== id);
                    if(state.data.marks[id]) {
                        delete state.data.marks[id];
                    }
                    state.data.examMasters = (state.data.examMasters || []).filter(ex => ex.id !== id);
                    saveData();
                    showToast('Exam and all related data deleted.', 'success');
                    renderExamsPage();
                }
            }


            function renderFinancialsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Income / All Transactions');
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>All Transactions</h3></div><div class="table-container"><table id="transactions-table"></table></div></div></div>`;
                renderTransactionsTable();
            }

            function renderTransactionsTable() {
                const table = getEl('transactions-table');
                if (!table) return;
                const transactions = (state.data.transactions || []).sort((a, b) => new Date(b.date) - new Date(a.date));
                let html = `<thead><tr><th>Student Name</th><th>Type</th><th>Amount ()</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
                if (transactions.length === 0) html += `<tr><td colspan="5" style="text-align:center;">No transactions found.</td></tr>`;
                else transactions.forEach(t => { const student = findById('students', t.studentId); html += `<tr><td>${student ? `<a href="#" onclick="event.preventDefault(); navigate('students', 'profile', '${student.id}')">${student.name}</a>` : 'Unknown Student'}</td><td>${t.type || 'Fee'}</td><td>${Number(t.amount).toLocaleString()}</td><td>${new Date(t.date).toLocaleDateString()}</td><td class="action-buttons"><button class="view-btn" onclick="showFeeReceipt('${t.studentId}', '${t.id}')" title="Print Receipt"><i class="fas fa-print"></i></button><button class="delete-btn" onclick="deleteItem('transactions', '${t.id}', 'Are you sure you want to delete this transaction?', renderTransactionsTable)" title="Delete"><i class="fas fa-trash"></i></button></td></tr>`; });
                table.innerHTML = html + `</tbody>`;
            }

            function showPaymentForm(studentId) {
                const student = findById('students', studentId);
                const title = `Add Payment for ${student.name}`;
                const formContent = `<form id="payment-form"><input type="hidden" id="payment-student-id" value="${studentId}">
                        <div class="form-group"><label for="payment-type">Payment Type</label><input type="text" id="payment-type" value="Monthly Fee" required></div>
                        <div class="form-group"><label for="payment-amount">Amount ()</label><input type="number" id="payment-amount" value="300" required></div>
                        <div class="form-group"><label for="payment-date">Date</label><input type="date" id="payment-date" value="${new Date().toISOString().slice(0,10)}" required></div><button type="submit" class="action-button">Record Payment</button></form>`;
                showModal(title, formContent);
                getEl('payment-form').onsubmit = e => { e.preventDefault(); const transaction = { id: Date.now().toString(), studentId: getEl('payment-student-id').value, amount: getEl('payment-amount').value, date: getEl('payment-date').value, type: getEl('payment-type').value }; updateOrAddItem('transactions', transaction); showToast("Payment recorded!", "success"); closeModal(); if(state.currentPage === 'studentList') { renderStudentProfilePage(studentId); } };
            }

            function renderExpensesPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showExpenseForm()"><i class="fas fa-plus"></i> Add Expense</button>`;
                mainContent.innerHTML = renderHeader('Expenses', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="table-container"><table id="expenses-table"></table></div></div></div>`;
                renderExpensesTable();
            }

            function renderExpensesTable() {
                const table = getEl('expenses-table');
                if (!table) return;
                const expenses = (state.data.expenses || []).sort((a,b) => new Date(b.date) - new Date(a.date));
                let html = `<thead><tr><th>
            Title</th><th>Amount ()</th><th>Category</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
                if (expenses.length === 0) html += `<tr><td colspan="5" style="text-align:center;">No expenses found.</td></tr>`;
                else expenses.forEach(e => { html += `<tr><td>${e.title}</td><td>${Number(e.amount).toLocaleString()}</td><td>${e.category}</td><td>${new Date(e.date).toLocaleDateString()}</td><td class="action-buttons"><button class="edit-btn" onclick="showExpenseForm('${e.id}')" title="Edit"><i class="fas fa-edit"></i></button><button class="delete-btn" onclick="deleteItem('expenses', '${e.id}', 'Are you sure you want to delete this expense?', renderExpensesTable)" title="Delete"><i class="fas fa-trash"></i></button></td></tr>`; });
                table.innerHTML = html + `</tbody>`;
            }

            function showExpenseForm(id = null) {
                const expense = id ? findById('expenses', id) : {};
                const title = id ? 'Edit Expense' : 'Add New Expense';
                const formContent = `<form id="expense-form"><input type="hidden" id="expense-id" value="${expense.id || ''}">
                        <div class="form-group"><label for="expense-title">Title (e.g., Electricity Bill)</label><input type="text" id="expense-title" value="${expense.title || ''}" required></div>
                        <div class="form-group"><label for="expense-amount">Amount ()</label><input type="number" id="expense-amount" value="${expense.amount || ''}" required></div>
                        <div class="form-group"><label for="expense-category">Category</label><input type="text" id="expense-category" value="${expense.category || ''}" placeholder="e.g., Utilities, Rent, Supplies" required></div>
                        <div class="form-group"><label for="expense-date">Date</label><input type="date" id="expense-date" value="${expense.date || new Date().toISOString().slice(0,10)}" required></div>
                        <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Expense'}</button></form>`;
                showModal(title, formContent);
                getEl('expense-form').onsubmit = e => { e.preventDefault(); const expenseData = { id: getEl('expense-id').value || Date.now().toString(), title: getEl('expense-title').value, amount: getEl('expense-amount').value, category: getEl('expense-category').value, date: getEl('expense-date').value, }; updateOrAddItem('expenses', expenseData); showToast(`Expense ${id ? 'updated' : 'added'}!`, 'success'); closeModal(); renderExpensesPage(); };
            }
            
            function renderResultPortalPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Result Portal');

                mainContent.innerHTML += `<div class="page active"><div class="card">
                        <div class="card-header"><h3>Find Your Marksheet</h3></div>
                        <p>Enter your Roll Number and Date of Birth (or Password) to view your marksheet.</p>
                        <form id="find-result-form" style="margin-top:20px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="result-roll-number">Roll Number</label>
                                    <input type="text" id="result-roll-number" placeholder="Enter Roll Number" required>
                                </div>
                                <div class="form-group">
                                    <label for="result-dob">Date of Birth</label>
                                    <input type="text" id="result-dob" placeholder="YYYY-MM-DD">
                                </div>
                            </div>
                             <p style="text-align:center; margin-bottom: 15px;">OR</p>
                             <div class="form-group">
                                <label for="result-password">Password</label>
                                <input type="password" id="result-password" placeholder="Enter Password">
                            </div>
                            <button type="submit" class="action-button inline">Find Result</button>
                        </form>
                        <div id="result-display-area" style="margin-top:30px;"></div>
                    </div></div>`;

                getEl('find-result-form').onsubmit = (e) => { 
                    e.preventDefault(); 
                    handleFindResult();
                };
            }

            function handleFindResult() {
                const rollNumber = getEl('result-roll-number').value.trim().toLowerCase();
                const dob = getEl('result-dob').value;
                const password = getEl('result-password').value;
                const resultArea = getEl('result-display-area');
                resultArea.innerHTML = '';

                if (!rollNumber || (!dob && !password)) {
                    resultArea.innerHTML = `<p class="form-feedback error">Please enter a roll number and either a date of birth or a password.</p>`;
                    return;
                }

                const student = (state.data.students || []).find(s => {
                    if (s.rollNumber && s.rollNumber.toLowerCase() === rollNumber) {
                        if (dob && s.dob === dob) return true;
                        if (password && s.password && btoa(password) === s.password) return true;
                    }
                    return false;
                });
                
                if (!student) {
                    resultArea.innerHTML = `<p class="form-feedback error">No student found with these details. Please check your credentials.</p>`;
                    return;
                }
                
                const examOptions = (state.data.examMasters || [])
                    .filter(em => em.declarationDate && new Date(em.declarationDate) <= new Date() && state.data.marks[em.id] && state.data.marks[em.id][student.id])
                    .sort((a,b) => b.id - a.id)
                    .map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');

                if (!examOptions) {
                    resultArea.innerHTML = `<p class="form-feedback error" style="display:block;">Result for this student has not been declared for any exam yet.</p>`;
                    return;
                }

                resultArea.innerHTML = `
                    <div class="form-group">
                        <label for="result-exam-select">Select Exam to View Result</label>
                        <select id="result-exam-select">
                            <option value="">Select Exam</option>
                            ${examOptions}
                        </select>
                    </div>
                    <div id="marksheet-display-container"></div>
                `;

                getEl('result-exam-select').onchange = (e) => {
                    const examMasterId = e.target.value;
                    const container = getEl('marksheet-display-container');
                    if (examMasterId) {
                        showMarksheet(student.id, examMasterId, container);
                    } else {
                        container.innerHTML = '';
                    }
                };
            }
            
            function renderAdmitCardPortalPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Admit Card Portal');

                const classOptions = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
                    .map(c => `<option value="${c}">Class ${c}</option>`).join('');

                const examOptions = (state.data.examMasters || [])
                    .sort((a, b) => b.id - a.id)
                    .map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');

                mainContent.innerHTML += `<div class="page active"><div class="card">
                    <div class="card-header"><h3>Download Your Admit Card</h3></div>
                    <p>Please provide your details below to generate your admit card.</p>
                    <form id="find-admit-card-form" style="margin-top:20px;">
                        <div class="form-group">
                            <label for="admit-card-class-select">1. Select Your Class</label>
                            <select id="admit-card-class-select" required>
                                <option value="">-- Select Class --</option>
                                ${classOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="admit-card-exam-select">2. Select Exam</label>
                            <select id="admit-card-exam-select" required>
                                <option value="">-- Select Exam --</option>
                                ${examOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="admit-card-roll-number">3. Enter Your Roll Number</label>
                            <input type="text" id="admit-card-roll-number" placeholder="Enter your roll number" required>
                        </div>
                        <button type="submit" class="action-button inline">Generate Admit Card</button>
                    </form>
                    <div id="admit-card-display-area" style="margin-top:30px;"></div>
                </div></div>`;

                getEl('find-admit-card-form').onsubmit = (e) => {
                    e.preventDefault();
                    handleFindAdmitCard();
                };
            }
            
            function handleFindAdmitCard() {
                const className = getEl('admit-card-class-select').value;
                const examMasterId = getEl('admit-card-exam-select').value;
                const rollNumber = getEl('admit-card-roll-number').value.trim();
                const displayArea = getEl('admit-card-display-area');

                if (!className || !examMasterId || !rollNumber) {
                    displayArea.innerHTML = `<p class="form-feedback error">Please fill all three fields.</p>`;
                    return;
                }

                const student = (state.data.students || []).find(s => 
                    s.className === className.replace('Class ','') && 
                    s.rollNumber && 
                    s.rollNumber.toLowerCase() === rollNumber.toLowerCase()
                );

                if (student) {
                    showAdmitCard(student, examMasterId, displayArea);
                } else {
                    displayArea.innerHTML = `<p class="form-feedback error">No student found with Roll Number <strong>${rollNumber}</strong> in <strong>${className}</strong>. Please check your details.</p>`;
                }
            }
            
            function showAdmitCard(student, examMasterId, container) {
                const schoolInfo = state.data.siteContent;
                const examMaster = findById('examMasters', examMasterId);
                if(!examMaster) {
                    showToast("Selected exam could not be found.", "error");
                    return;
                }
                const examSchedulesForClass = (state.data.examSchedules || [])
                    .filter(ex => ex.examMasterId === examMasterId && ex.className === `Class ${student.className}`)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const getDayOfWeek = (dateString) => {
                    const date = new Date(dateString);
                    const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                    const correctedDate = new Date(date.getTime() + userTimezoneOffset);
                    return correctedDate.toLocaleDateString('en-US', { weekday: 'long' });
                };

                const examRows = examSchedulesForClass.map(ex => `
                    <tr>
                        <td>${new Date(ex.date).toLocaleDateString('en-GB')}</td>
                        <td>${getDayOfWeek(ex.date)}</td>
                        <td>${ex.subject}</td>
                        <td>${ex.paperCode || '-'}</td>
                        <td>${ex.startTime} - ${ex.endTime}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" style="text-align:center;">No exams scheduled for your class in this examination.</td></tr>';
                
                const signatureDoc = (student.documents || []).find(doc => doc.name && doc.name.toLowerCase().includes('signature'));

                const admitCardHtml = `
                    <div class="printable-area">
                        <div class="admit-card-container" style="width: 100%; max-width: 800px; border: 2px solid var(--primary-color); padding: 25px; margin: auto; background: var(--background-color);">
                            <div class="id-card-header" style="border-bottom-width: 3px;">
                                <h3>${schoolInfo.schoolName || 'School Name'}</h3>
                                <p style="font-size: 1.2em; margin-top: 8px; color: var(--primary-light); font-weight: 600;">ADMIT CARD - ${examMaster.name}</p>
                            </div>
                             <div style="display: flex; justify-content: space-between; align-items: flex-start; margin: 25px 0; padding: 0 10px;">
                                <div style="text-align: left; font-size: 1rem; line-height: 1.6;">
                                    <p><strong>Student Name:</strong> ${student.name}</p>
                                    <p><strong>Father's Name:</strong> ${student.fatherName}</p>
                                    <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                                    <p><strong>Class:</strong> Class ${student.className} ${student.stream ? `(${student.stream})` : ''}</p>
                                </div>
                                <div style="text-align:center;">
                                    <img src="${student.photo || 'https://via.placeholder.com/120?text=S'}" alt="Photo" class="id-card-photo" style="margin:0; width: 120px; height: 140px; border-radius: 8px; object-fit: cover;">
                                    ${signatureDoc ? `<img src="${signatureDoc.data}" alt="Signature" style="height: 40px; max-width: 120px; object-fit: contain; margin-top: 5px;">` : ''}
                                </div>
                            </div>
                            <h4 style="margin: 25px 0 15px 0; text-align:center; font-size: 1.2rem;">Exam Schedule</h4>
                            <div class="table-container" style="padding: 0 10px;">
                                <table style="font-size: 0.95em; width:100%;">
                                    <thead style="background-color: var(--secondary-color);">
                                        <tr>
                                            <th style="text-align: left;">Date</th>
                                            <th style="text-align: left;">Day</th>
                                            <th style="text-align: left;">Subject</th>
                                            <th style="text-align: left;">Paper Code</th>
                                            <th style="text-align: left;">Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>${examRows}</tbody>
                                </table>
                            </div>
                            <div class="receipt-footer" style="margin-top: 30px; padding: 0 10px;">
                                <div class="receipt-signature" style="margin-top: 60px;">
                                    <div class="receipt-signature-line"></div>
                                    <p>Principal's Signature</p>
                                </div>
                                <p style="text-align:left; font-size: 0.85rem;"><strong>Instructions:</strong><br>1. Bring this admit card to the examination hall for every exam.<br>2. No electronic devices (mobiles, smart watches, etc.) are allowed inside the examination hall.<br>3. Reach the examination center at least 15 minutes before the scheduled time.</p>
                            </div>
                        </div>
                    </div>
                    <button class="action-button no-print" style="margin-top: 20px;" onclick="printContent('.printable-area')"><i class="fas fa-print"></i> Print Admit Card</button>
                `;
                
                if (container) {
                    container.innerHTML = admitCardHtml;
                } else {
                    showModal("Admit Card", admitCardHtml, "900px");
                }
            }
            
            function renderCertificatePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Certificate Generation');
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>Generate Certificate</h3></div><p>Select a student to generate a certificate.</p>
                        <div class="search-box-container" style="margin-top: 20px;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" oninput="renderCertificateStudentList(this.value)" placeholder="Search Student..." class="search-input">
                        </div>
                        <div class="table-container"><table id="certificate-student-table"></table></div>
                        </div></div>`;
                renderCertificateStudentList();
            }
            
            function renderCertificateStudentList(searchTerm = '') {
                const table = getEl('certificate-student-table');
                if (!table) return;
                let students = (state.data.students || []).filter(s => searchTerm ? 
                    (s.name && s.name.toLowerCase().includes(searchTerm.toLowerCase())) : true);
                let head = `<thead><tr><th>Admission No.</th><th>Name</th><th>Action</th></tr></thead>`;
                let body = `<tbody>`;
                if (students.length === 0) body += `<tr><td colspan="3" style="text-align:center;">No students found.</td></tr>`;
                else students.sort((a, b) => b.id - a.id).forEach(s => { body += `<tr>
                    <td><strong>${s.admissionNumber || 'N/A'}</strong></td>
                    <td>${s.name}</td>
                    <td><button class="action-button inline" onclick="showCertificateGenerationModal('${s.id}')"><i class="fas fa-certificate"></i> Generate</button></td>
                </tr>`; });
                table.innerHTML = head + body + `</tbody>`;
            }

            function showCertificateGenerationModal(studentId) {
                const student = findById('students', studentId);
                const formContent = `
                    <form id="certificate-gen-form">
                        <p>Generating certificate for <strong>${student.name}</strong>.</p>
                        <div class="form-group">
                            <label for="certificate-title">Certificate For</label>
                            <input type="text" id="certificate-title" value="Passing Class ${student.className}" required>
                        </div>
                        <div class="form-group">
                            <label for="certificate-date">Issue Date</label>
                            <input type="date" id="certificate-date" value="${new Date().toISOString().slice(0,10)}" required>
                        </div>
                        <button type="submit" class="action-button">Preview & Print Certificate</button>
                    </form>
                `;
                showModal('Generate Certificate', formContent);
                getEl('certificate-gen-form').onsubmit = (e) => {
                    e.preventDefault();
                    const certTitle = getEl('certificate-title').value;
                    const issueDate = getEl('certificate-date').value;
                    closeModal();
                    showCertificate(student, certTitle, issueDate);
                };
            }
            
            function showCertificate(student, certTitle, issueDate) {
                 const schoolInfo = state.data.siteContent;
                 const adminProfile = JSON.parse(localStorage.getItem('adminAccount') || '{}');
                 const content = `
                    <div class="printable-area">
                        <div class="certificate-container">
                            <div class="certificate-header">
                                <h1>Certificate of Achievement</h1>
                                <h2>${schoolInfo.schoolName || 'School Name'}</h2>
                            </div>
                            <div class="certificate-body">
                                <img src="${student.photo || 'https://via.placeholder.com/150?text=Photo'}" alt="Student Photo" class="certificate-student-photo">
                                <p>This is to certify that</p>
                                <p class="student-name">${student.name}</p>
                                <p>has successfully completed the requirements for</p>
                                <p><strong class="class-name">${certTitle}</strong></p>
                                <p>on ${new Date(issueDate).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}.</p>
                            </div>
                            <div class="certificate-footer">
                                <div class="signature-block">
                                    <div class="signature-line"></div>
                                    <p><strong>Date</strong></p>
                                </div>
                                <div class="signature-block">
                                     <div class="signature-line"></div>
                                    <p><strong>${adminProfile.name || 'Director'}</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="action-button no-print" style="margin-top: 20px;" onclick="printContent('.printable-area')"><i class="fas fa-print"></i> Print Certificate</button>
                `;
                showModal('Certificate Preview', content, '900px');
            }


            function renderNotesPage() { 
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showNoteForm()"><i class="fas fa-plus"></i> Add Note</button>`;
                mainContent.innerHTML = renderHeader('Admin Personal Notes', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="table-container"><table id="notes-table"></table></div></div></div>`;
                renderNotesTable();
            }

            function renderNotesTable() {
                const table = getEl('notes-table');
                if(!table) return;
                const { adminNotes } = state.data;
                let html = `<thead><tr><th>Title</th><th>Content</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
                 if (!adminNotes || adminNotes.length === 0) html += `<tr><td colspan="4" style="text-align:center;">No personal notes found.</td></tr>`;
                else { adminNotes.sort((a,b) => b.id - a.id).forEach(n => { html += `<tr><td>${n.title}</td><td>${n.content.substring(0, 50)}...</td><td>${new Date(n.id).toLocaleDateString()}</td><td class="action-buttons"><button class="edit-btn" onclick="showNoteForm('${n.id}')" title="Edit"><i class="fas fa-edit"></i></button><button class="delete-btn" onclick="deleteItem('adminNotes', '${n.id}', 'Are you sure you want to delete this note?', renderNotesTable)" title="Delete"><i class="fas fa-trash"></i></button></td></tr>`; }); }
                html += '</tbody>'; table.innerHTML = html;
            }
            function showNoteForm(id = null) { 
                const note = id ? findById('adminNotes', id) : {}; 
                const title = id ? 'Edit Note' : 'Add New Note'; 
                const formContent = `<form id="note-form"><input type="hidden" id="note-id" value="${note.id || ''}"><div class="form-group"><label for="note-title">Title</label><input type="text" id="note-title" value="${note.title || ''}" required></div><div class="form-group"><label for="note-content">Content</label><textarea id="note-content" rows="5" required>${note.content || ''}</textarea></div><button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Note'}</button></form>`; 
                showModal(title, formContent); 
                getEl('note-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const noteData = { id: getEl('note-id').value || Date.now(), title: getEl('note-title').value, content: getEl('note-content').value }; 
                    updateOrAddItem('adminNotes', noteData); 
                    showToast(`Note ${id ? 'updated' : 'added'}!`, 'success'); 
                    closeModal(); 
                    renderNotesTable(); 
                }; 
            }
            
            function renderGalleryPage() { 
                const mainContent = getEl('main-content'); 
                const actionsHtml = (state.loggedInUser?.role === 'admin') ? `<button class="action-button inline" onclick="showGalleryForm()"><i class="fas fa-plus"></i> Add Photo</button>` : ''; 
                mainContent.innerHTML = renderHeader('Photo Gallery', actionsHtml); 
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="gallery-grid" id="gallery-grid-container"></div></div></div>`; 
                renderGalleryGrid(); 
            }

            function renderGalleryGrid() { 
                const container = getEl('gallery-grid-container'); 
                if(!container) return; 
                const { gallery } = state.data; 
                if (!gallery || gallery.length === 0) { 
                    container.innerHTML = `<p>No photos in the gallery yet.</p>`; 
                    return; 
                } 
                container.innerHTML = gallery.sort((a,b) => b.id - a.id).map(item => `
                    <div class="gallery-item card">
                        <img src="${item.photo}" alt="${item.title}">
                        <div class="gallery-item-footer">
                            <span>${item.title}</span>
                            ${state.loggedInUser?.role === 'admin' ? `<button class="delete-btn" onclick="deleteItem('gallery', '${item.id}', 'Are you sure you want to delete this photo?', renderGalleryGrid)" title="Delete"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>`).join(''); 
            }

            function showGalleryForm() { 
                const title = 'Add Photo to Gallery'; 
                const formContent = `<form id="gallery-form"><div class="form-group"><label for="gallery-title">Photo Title</label><input type="text" id="gallery-title" required></div><div class="form-group"><label for="gallery-photo">Select Photo</label><input type="file" id="gallery-photo" accept="image/*" required></div><button type="submit" class="action-button">Add Photo</button></form>`; 
                showModal(title, formContent); 
                getEl('gallery-form').onsubmit = async e => { 
                    e.preventDefault(); 
                    const photoFile = getEl('gallery-photo').files[0]; 
                    if(!photoFile) return; 
                    const photoData = { id: Date.now(), title: getEl('gallery-title').value, photo: await fileToBase64(photoFile) }; 
                    updateOrAddItem('gallery', photoData); 
                    showToast('Photo added to gallery!', 'success'); 
                    closeModal(); 
                    renderGalleryGrid(); 
                }; 
            }
            
            function renderVideosPage() { 
                const mainContent = getEl('main-content'); 
                const actionsHtml = (state.loggedInUser?.role === 'admin') ? `<button class="action-button inline" onclick="showVideoForm()"><i class="fas fa-plus"></i> Add Video</button>` : ''; 
                mainContent.innerHTML = renderHeader('Video Gallery', actionsHtml); 
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="videos-grid" id="videos-grid-container"></div></div></div>`; 
                renderVideosGrid(); 
            }

            function renderVideosGrid() { 
                const container = getEl('videos-grid-container'); 
                if(!container) return; 
                const { videos } = state.data; 
                if (!videos || videos.length === 0) { 
                    container.innerHTML = `<p>No videos in the gallery yet.</p>`; 
                    return; 
                } 
                container.innerHTML = videos.sort((a,b) => b.id - a.id).map(item => `
                    <div class="video-item card">
                        <iframe src="${getYoutubeEmbedUrl(item.url)}" title="${item.title}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                        <div class="video-item-footer">
                            <span>${item.title}</span>
                             ${state.loggedInUser?.role === 'admin' ? `<button class="delete-btn" onclick="deleteItem('videos', '${item.id}', 'Are you sure you want to delete this video?', renderVideosGrid)" title="Delete"><i class="fas fa-trash"></i></button>`: ''}
                        </div>
                    </div>`).join(''); 
            }
            function showVideoForm() { 
                const title = 'Add Video to Gallery'; 
                const formContent = `<form id="video-form"><div class="form-group"><label for="video-title">Video Title</label><input type="text" id="video-title" required></div><div class="form-group"><label for="video-url">YouTube Video URL</label><input type="url" id="video-url" placeholder="https://www.youtube.com/watch?v=..." required></div><button type="submit" class="action-button">Add Video</button></form>`; 
                showModal(title, formContent); 
                getEl('video-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const videoTitle = getEl('video-title').value; 
                    const videoUrl = getEl('video-url').value; 
                    if(videoUrl && videoTitle) { 
                        const videoData = { id: Date.now(), title: videoTitle, url: videoUrl }; 
                        updateOrAddItem('videos', videoData); 
                        showToast('Video added to gallery!', 'success'); 
                        closeModal(); 
                        renderVideosGrid(); 
                    } 
                }; 
            }
            
            function getYoutubeEmbedUrl(url) { 
                try { 
                    const urlObj = new URL(url); 
                    let videoId = urlObj.searchParams.get("v"); 
                    if (!videoId) { 
                        const pathParts = urlObj.pathname.split('/'); 
                        videoId = pathParts[pathParts.length - 1]; 
                    } 
                    return `https://www.youtube.com/embed/${videoId}`; 
                } catch (e) { 
                    console.error("Invalid YouTube URL:", url);
                    return '';
                } 
            }

            function setupAttendancePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Student Attendance');
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card">
                            <div class="card-header" style="flex-direction: column; align-items: flex-start; border-bottom: none; padding-bottom: 0;">
                                <h3>Student Attendance Management</h3>
                                <div class="view-switcher" style="margin-top: 15px;">
                                    <button id="mark-view-btn" class="action-button inline">Manual</button>
                                    <button id="report-view-btn" class="action-button inline">Monthly Report</button>
                                </div>
                            </div>
                            <div id="attendance-content" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;"></div>
                        </div>
                    </div>
                `;
                getEl('mark-view-btn').onclick = () => renderMarkAttendanceView('students');
                getEl('report-view-btn').onclick = () => renderAttendanceReportView('students');
                renderMarkAttendanceView('students');
            }

            function setActiveView(activeBtnId) {
                 [
                    'mark-view-btn', 'report-view-btn',
                    'teacher-mark-view-btn', 'teacher-report-view-btn',
                    'staff-mark-view-btn', 'staff-report-view-btn'
                 ].forEach(id => {
                    const btn = getEl(id);
                    if (btn) btn.classList.remove('active');
                 });
                 if (getEl(activeBtnId)) getEl(activeBtnId).classList.add('active');
            }

            function renderMarkAttendanceView(type = 'students') {
                if(html5QrCode && html5QrCode.isScanning) html5QrCode.stop();
                
                let activeBtnId;
                if(type === 'students') activeBtnId = 'mark-view-btn';
                else if (type === 'teachers') activeBtnId = 'teacher-mark-view-btn';
                else if (type === 'staff') activeBtnId = 'staff-mark-view-btn';
                setActiveView(activeBtnId);
                
                const contentArea = getEl('attendance-content');
                const today = new Date().toISOString().slice(0, 10);


                let filterHtml = '';
                if (type === 'students') {
                     const classOptions = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'].map(c =>
`<option value="${c}">Class ${c}</option>`).join('');
                     filterHtml = `<div class="form-group"><label for="attendance-class-filter">Filter by Class</label><select id="attendance-class-filter" onchange="renderAttendanceSheet('${type}')"><option value="">All Students</option>${classOptions}</select></div>`;
                }
                
                contentArea.innerHTML = `
                    <div class="form-group"><label for="attendance-date">Select Date</label><input type="date" id="attendance-date" value="${today}" onchange="renderAttendanceSheet('${type}')"></div>
                    ${filterHtml}
                    <div class="table-container"><table id="attendance-table"></table></div>
                    <button class="action-button" style="margin-top: 20px;" onclick="saveAttendance('${type}')">Save ${type.charAt(0).toUpperCase() + type.slice(1)} Attendance</button>
                `;
                
                renderAttendanceSheet(type);
            }
            
            function renderAttendanceReportView(type = 'students') {
                if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop();
                
                let activeBtnId;
                if(type === 'students') activeBtnId = 'report-view-btn';
                else if (type === 'teachers') activeBtnId = 'teacher-report-view-btn';
                else if (type === 'staff') activeBtnId = 'staff-report-view-btn';
                setActiveView(activeBtnId);
                
                const contentArea = getEl('attendance-content');

                const now = new Date();
                const currentYear = now.getFullYear();

                const yearOptions = Array.from({ length: 5 }, (_, i) => currentYear - i)
                    .map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
                
                const monthOptions = Array.from({ length: 12 }, (_, i) => {
                    const monthName = new Date(0, i).toLocaleString('en-US', { month: 'long' });
                    return `<option value="${i}" ${i === now.getMonth() ? 'selected' : ''}>${monthName}</option>`;
                }).join('');

                let classFilterHtml = '';
                if (type === 'students') {
                    const classOptions = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'].map(c => `<option value="${c}">Class ${c}</option>`).join('');
                    classFilterHtml = `
                        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="report-class-filter">Filter by Class</label>
                            <select id="report-class-filter" onchange="displayMonthlyAttendanceReport('${type}')"><option value="all">All Students</option>${classOptions}</select>
                        </div>`;
                }

                contentArea.innerHTML = `
                    <div class="no-print" style="display:flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="report-month-filter">Select Month</label>
                            <select id="report-month-filter" onchange="displayMonthlyAttendanceReport('${type}')">${monthOptions}</select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="report-year-filter">Select Year</label>
                            <select id="report-year-filter" onchange="displayMonthlyAttendanceReport('${type}')">${yearOptions}</select>
                        </div>
                        ${classFilterHtml}
                        <button class="action-button inline" onclick="printContent('.printable-area.attendance-report')" style="flex-shrink: 0;"><i class="fas fa-print"></i> Print Report</button>
                    </div>
                    <div id="attendance-report-container" class="printable-area attendance-report"></div>`;
                
                displayMonthlyAttendanceReport(type);
            }
            
            function displayMonthlyAttendanceReport(type = 'students', memberId = null, isReadonly = false) {
                const reportContainer = getEl('attendance-report-container');
                if (!reportContainer) return;
                
                let month, year, filterEl;
                if (state.currentPage === 'studentAttendance') {
                    month = parseInt(getEl('student-report-month-filter').value);
                    year = parseInt(getEl('student-report-year-filter').value);
                } else {
                    month = parseInt(getEl('report-month-filter').value);
                    year = parseInt(getEl('report-year-filter').value);
                    filterEl = getEl('report-class-filter');
                }
                
                const selectedClass = filterEl ? filterEl.value : 'all';

                let memberList;
                if (memberId) {
                    memberList = [findById(type, memberId)];
                } else {
                    memberList = (state.data[type] || []);
                    if (type === 'students' && selectedClass !== 'all') {
                        memberList = memberList.filter(s => s.className === selectedClass);
                    }
                }
                
                if (memberList.length === 0 || (memberId && !memberList[0])) {
                    reportContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No members found for this selection.</p>';
                    return;
                }
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const monthName = new Date(year, month).toLocaleString('default', { month: 'long' });

                let tableHtml = `<h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Attendance Report for ${monthName} ${year}</h3>
                                 <form id="attendance-edit-form">
                                 <div class="table-container"><table class="monthly-attendance-table"><thead><tr><th class="sticky-col">Name</th>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    tableHtml += `<th>${day}</th>`;
                }
                tableHtml += `<th>P</th><th>A</th><th>%</th></tr></thead><tbody>`;

                memberList.forEach(member => {
                    let presentCount = 0;
                    let absentCount = 0;
                    tableHtml += `<tr><td class="sticky-col">${member.name}</td>`;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dateString = date.toISOString().slice(0, 10);
                        const dayOfWeek = date.getDay();
                        
                        let attendanceSource;
                        if (type === 'students') attendanceSource = state.data.studentAttendance;
                        else if (type === 'teachers') attendanceSource = state.data.teacherAttendance;
                        else if (type === 'staff') attendanceSource = state.data.staffAttendance;

                        const attendanceStatus = (attendanceSource[dateString] && attendanceSource[dateString][member.id]) ? attendanceSource[dateString][member.id] : null;

                        let cellClass = '';
                        let cellContent = '-';

                        if (dayOfWeek === 0) { // Sunday
                            cellClass = 'weekend-cell';
                            cellContent = 'S';
                        } else {
                            if (isReadonly) { // Student/Parent view
                                if (attendanceStatus === 'present') {
                                    presentCount++;
                                    cellClass = 'present-cell';
                                    cellContent = 'P';
                                } else if (attendanceStatus === 'absent') {
                                    absentCount++;
                                    cellClass = 'absent-cell';
                                    cellContent = 'A';
                                } else {
                                    cellContent = '-';
                                }
                            } else { // Admin view with editable dropdown
                                cellContent = `
                                    <select name="attendance_${member.id}_${dateString}" class="attendance-select" style="background: transparent; border: none; color: var(--text-color); width: 40px; text-align: center; -moz-appearance: none; -webkit-appearance: none; appearance: none;">
                                        <option value="" ${!attendanceStatus ? 'selected' : ''}>-</option>
                                        <option value="present" ${attendanceStatus === 'present' ? 'selected' : ''} style="color: var(--success-color);">P</option>
                                        <option value="absent" ${attendanceStatus === 'absent' ? 'selected' : ''} style="color: var(--error-color);">A</option>
                                    </select>
                                `;
                                if (attendanceStatus === 'present') {
                                    presentCount++;
                                    cellClass = 'present-cell';
                                } else if (attendanceStatus === 'absent') {
                                    absentCount++;
                                    cellClass = 'absent-cell';
                                }
                            }
                        }
                        
                        tableHtml += `<td class="${cellClass}">${cellContent}</td>`;
                    }
                    
                    const totalMarkedDays = presentCount + absentCount;
                    const percentage = totalMarkedDays > 0 ? ((presentCount / totalMarkedDays) * 100).toFixed(0) : 0;

                    tableHtml += `<td class="present-cell">${presentCount}</td><td class="absent-cell">${absentCount}</td><td>${percentage}%</td></tr>`;
                });

                tableHtml += `</tbody></table></div>`;
                
                if (!isReadonly) {
                    tableHtml += `<button type="submit" class="action-button" style="margin-top: 20px;">Save Changes</button>`;
                }

                tableHtml += `</form>`;
                reportContainer.innerHTML = tableHtml;

                const form = getEl('attendance-edit-form');
                if(form && !isReadonly) {
                    form.onsubmit = (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        let changesMade = false;
                        for(let [key, value] of formData.entries()) {
                             if (!key.startsWith('attendance_')) continue;
                            const [, memberId, dateString] = key.split('_');
                            
                            let attendanceKey;
                            if (type === 'students') attendanceKey = 'studentAttendance';
                            else if (type === 'teachers') attendanceKey = 'teacherAttendance';
                            else if (type === 'staff') attendanceKey = 'staffAttendance';
                            else continue;

                            if (!state.data[attendanceKey][dateString]) {
                                state.data[attendanceKey][dateString] = {};
                            }

                            const originalValue = state.data[attendanceKey][dateString][memberId];

                            if (value) {
                                if(originalValue !== value) {
                                    state.data[attendanceKey][dateString][memberId] = value;
                                    changesMade = true;
                                }
                            } else {
                                if(originalValue) {
                                    delete state.data[attendanceKey][dateString][memberId];
                                    changesMade = true;
                                }
                            }
                        }
                        if(changesMade){
                           saveData();
                           showToast('Attendance updated successfully!', 'success');
                           displayMonthlyAttendanceReport(type, memberId);
                        } else {
                           showToast('No changes to save.', 'info');
                        }
                    };
                }
            }

            function renderTeacherAttendancePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Teacher Attendance');
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card">
                            <div class="card-header" style="flex-direction: column; align-items: flex-start; border-bottom: none; padding-bottom: 0;">
                                <h3>Teacher Attendance Management</h3>
                                <div class="view-switcher" style="margin-top: 15px;">
                                    <button id="teacher-mark-view-btn" class="action-button inline">Manual</button>
                                    <button id="teacher-report-view-btn" class="action-button inline">Monthly Report</button>
                                </div>
                            </div>
                            <div id="attendance-content" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;"></div>
                        </div>
                    </div>`;
                getEl('teacher-mark-view-btn').onclick = () => renderMarkAttendanceView('teachers');
                getEl('teacher-report-view-btn').onclick = () => renderAttendanceReportView('teachers');
                renderMarkAttendanceView('teachers');
            }
            
            function renderStaffAttendancePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Staff Attendance');
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card">
                            <div class="card-header" style="flex-direction: column; align-items: flex-start; border-bottom: none; padding-bottom: 0;">
                                <h3>Staff Attendance Management</h3>
                                <div class="view-switcher" style="margin-top: 15px;">
                                    <button id="staff-mark-view-btn" class="action-button inline">Manual</button>
                                    <button id="staff-report-view-btn" class="action-button inline">Monthly Report</button>
                                </div>
                            </div>
                            <div id="attendance-content" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;"></div>
                        </div>
                    </div>`;
                getEl('staff-mark-view-btn').onclick = () => renderMarkAttendanceView('staff');
                getEl('staff-report-view-btn').onclick = () => renderAttendanceReportView('staff');
                renderMarkAttendanceView('staff');
            }

            function calculateAttendance(type, memberId) {
                let present = 0, absent = 0;
                let attendanceRecords;
                if (type === 'students') attendanceRecords = state.data.studentAttendance || {};
                else if (type === 'teachers') attendanceRecords = state.data.teacherAttendance || {};
                else if (type === 'staff') attendanceRecords = state.data.staffAttendance || {};
                else return { present: 0, absent: 0 };
                
                for (const date in attendanceRecords) {
                    if (attendanceRecords[date][memberId]) {
                        if (attendanceRecords[date][memberId] === 'present') present++;
                        else if (attendanceRecords[date][memberId] === 'absent') absent++;
                    }
                }
                return { present, absent };
            }

            function renderAttendanceSheet(type) { 
                const table = getEl('attendance-table'); 
                if(!table) return; 
                
                let membersToList = [];
                if (type === 'students') {
                    const classFilter = getEl('attendance-class-filter');
                    const className = classFilter ? classFilter.value : '';
                    membersToList = className ? (state.data.students || []).filter(s => s.className === className) : (state.data.students || []);
                } else {
                    membersToList = state.data[type] || [];
                }
                
                const date = getEl('attendance-date').value; 
                let attendanceData;
                if (type === 'students') attendanceData = (state.data.studentAttendance || {})[date] || {};
                else if (type === 'teachers') attendanceData = (state.data.teacherAttendance || {})[date] || {};
                else if (type === 'staff') attendanceData = (state.data.staffAttendance || {})[date] || {};

                let html = `<thead><tr><th>Member Name</th><th>Status</th></tr></thead><tbody>`; 
                if(membersToList.length === 0) {
                    html += `<tr><td colspan="2" style="text-align:center;">No members found for this class.</td></tr>`; 
                } else { 
                    membersToList.forEach(s => { 
                        const status = attendanceData[s.id] || 'absent'; 
                        html += `<tr data-member-id="${s.id}">
                                    <td>${s.name}</td>
                                    <td>
                                        <label style="margin-right:15px;"><input type="radio" name="status_${s.id}" value="present" ${status === 'present' ? 'checked' : ''}> Present</label>
                                        <label><input type="radio" name="status_${s.id}" value="absent" ${status === 'absent' ? 'checked' : ''}> Absent</label>
                                    </td>
                                </tr>`; 
                    }); 
                } 
                html += `</tbody>`; 
                table.innerHTML = html; 
            }
            
            function saveAttendance(type) { 
                const date = getEl('attendance-date').value; 
                let attendanceDataKey;
                if (type === 'students') attendanceDataKey = 'studentAttendance';
                else if (type === 'teachers') attendanceDataKey = 'teacherAttendance';
                else if (type === 'staff') attendanceDataKey = 'staffAttendance';
                else return;

                if(!state.data[attendanceDataKey][date]) state.data[attendanceDataKey][date] = {}; 
                let count = 0; 
                getEl('attendance-table').querySelectorAll('tbody tr').forEach(row => { 
                    const memberId = row.getAttribute('data-member-id');
                    if (memberId) {
                       const statusInput = row.querySelector('input[type="radio"]:checked');
                       if (statusInput) {
                           state.data[attendanceDataKey][date][memberId] = statusInput.value; 
                           count++; 
                       }
                    }
                }); 
                if (count > 0) { 
                    saveData(); 
                    showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} attendance for ${date} saved!`, 'success'); 
                    if(state.currentPage === 'home') renderHomePage(); 
                } else { 
                    showToast(`No one to mark.`, 'info'); 
                } 
            }

            function showUnifiedScanner() {
                const modalContent = `
                    <div id="unified-scanner-container" style="text-align: center;">
                        <div id="qr-scanner-container" style="width: 100%; max-width: 400px; margin: 0 auto;"></div>
                        <div id="unified-scan-result" style="margin-top: 15px; font-size: 1.1rem; padding: 10px; border-radius: 6px;"></div>
                        <div id="last-scanned-info" class="card" style="margin-top: 20px; display: none; padding: 15px;">
                            <img id="last-scanned-photo" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px; border: 3px solid var(--primary-light);">
                            <h4 id="last-scanned-name" style="font-size: 1.2rem;"></h4>
                            <p id="last-scanned-id" style="color: var(--text-muted);"></p>
                        </div>
                    </div>
                `;
                showModal('Unified QR Attendance Scanner', modalContent, '500px');
                
                html5QrCode = new Html5Qrcode("qr-scanner-container");
                const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                    const resultEl = getEl('unified-scan-result');
                    const infoEl = getEl('last-scanned-info');
                    
                    const cleanDecodedText = decodedText.trim();
                    let member = null;
                    let memberType = '';
                    let attendanceKey = '';
                    let idField = '';

                    member = (state.data.students || []).find(s => s.admissionNumber === cleanDecodedText);
                    if (member) {
                        memberType = 'Student';
                        attendanceKey = 'studentAttendance';
                        idField = member.admissionNumber;
                    } else {
                        member = (state.data.teachers || []).find(t => t.employeeId === cleanDecodedText);
                        if (member) {
                            memberType = 'Teacher';
                            attendanceKey = 'teacherAttendance';
                            idField = member.employeeId;
                        } else {
                           member = (state.data.staff || []).find(s => s.employeeId === cleanDecodedText);
                           if (member) {
                                memberType = 'Staff';
                                attendanceKey = 'staffAttendance';
                                idField = member.employeeId;
                           }
                        }
                    }
                    
                    if (member) {
                        const today = new Date().toISOString().slice(0, 10);
                        if (!state.data[attendanceKey][today]) state.data[attendanceKey][today] = {};

                        if (state.data[attendanceKey][today][member.id] === 'present') {
                            resultEl.innerHTML = `<strong style="color: var(--warning-color);">Attendance already marked for ${member.name}.</strong>`;
                        } else {
                            state.data[attendanceKey][today][member.id] = 'present';
                            saveData(); // Save the data immediately
                            resultEl.innerHTML = `<strong style="color: var(--success-color);">Success! Attendance marked for ${member.name} (${memberType}).</strong>`;
                            showToast(`Attendance marked for ${member.name}`, 'success');
                            if(state.currentPage === 'home') renderHomePage(); // Refresh dashboard if on home
                        }
                        
                        getEl('last-scanned-photo').src = member.photo || 'https://via.placeholder.com/100?text=?';
                        getEl('last-scanned-name').textContent = member.name;
                        getEl('last-scanned-id').textContent = idField;
                        infoEl.style.display = 'block';

                    } else {
                        resultEl.innerHTML = `<strong style="color: var(--error-color);">Error! Invalid QR Code. Member not found.</strong>`;
                        infoEl.style.display = 'none';
                    }
                };
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                    .catch(err => {
                        console.error("QR Scanner Error:", err);
                        getEl('unified-scan-result').innerHTML = `<strong>Camera Error!</strong><br>Could not start camera. Check permissions.`;
                    });
            }

            function renderInquiriesPage() { 
                const mainContent = getEl('main-content'); 
                const actionsHtml = (state.loggedInUser?.role === 'admin' || !state.loggedInUser) ? `<button class="action-button inline" onclick="showInquiryForm()"><i class="fas fa-plus"></i> Add Inquiry</button>`: '';
                mainContent.innerHTML = renderHeader('Inquiries', actionsHtml); 
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="table-container"><table id="inquiries-table"></table></div></div></div>`; 
                renderInquiriesTable(); 
            }

            function renderInquiriesTable() { 
                const table = getEl('inquiries-table'); 
                if (!table) return; 
                const { inquiries } = state.data; 
                let html = `<thead><tr><th>Name</th><th>Contact</th><th>Inquiry For</th><th>Status</th><th>Actions</th></tr></thead><tbody>`; 
                if (!inquiries || inquiries.length === 0) {
                    html += `<tr><td colspan="5" style="text-align:center;">No inquiries found.</td></tr>`;
                } else { 
                    inquiries.sort((a,b) => b.id - a.id).forEach(i => { 
                        html += `<tr>
                                    <td>${i.name}</td>
                                    <td>${i.contact}</td>
                                    <td>${i.inquiryFor}</td>
                                    <td>${i.status}</td>
                                    <td class="action-buttons">
                                        <button class="edit-btn" onclick="showInquiryForm('${i.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn" onclick="deleteItem('inquiries', '${i.id}', 'Are you sure you want to delete this inquiry?', renderInquiriesTable)" title="Delete"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>`; 
                    }); 
                } 
                html += '</tbody>'; table.innerHTML = html; 
            }

            function showInquiryForm(id = null) { 
                const inquiry = id ? findById('inquiries', id) : {}; 
                const title = id ? 'Edit Inquiry' : 'Add New Inquiry'; 
                const formContent = `<form id="inquiry-form">
                                        <input type="hidden" id="inquiry-id" value="${inquiry.id || ''}">
                                        <div class="form-group"><label for="inquiry-name">Name</label><input type="text" id="inquiry-name" value="${inquiry.name || ''}" required></div>
                                        <div class="form-group"><label for="inquiry-contact">Contact</label><input type="text" id="inquiry-contact" value="${inquiry.contact || ''}" required></div>
                                        <div class="form-group"><label for="inquiry-for">Inquiry For</label><input type="text" id="inquiry-for" value="${inquiry.inquiryFor || ''}" placeholder="e.g., Admission in Class 5" required></div>
                                        ${state.loggedInUser?.role === 'admin' ? `
                                        <div class="form-group"><label for="inquiry-status">Status</label><select id="inquiry-status"><option value="New" ${inquiry.status === 'New' || !inquiry.status ? 'selected' : ''}>New</option><option value="Followed Up" ${inquiry.status === 'Followed Up' ? 'selected' : ''}>Followed Up</option><option value="Enrolled" ${inquiry.status === 'Enrolled' ? 'selected' : ''}>Enrolled</option><option value="Closed" ${inquiry.status === 'Closed' ? 'selected' : ''}>Closed</option></select></div>
                                        `: `
                                        <input type="hidden" id="inquiry-status-hidden" value="New">
                                        `}
                                        <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Inquiry'}</button>
                                     </form>`; 
                showModal(title, formContent); 
                getEl('inquiry-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const statusEl = getEl('inquiry-status');
                    const status = statusEl ? statusEl.value : getEl('inquiry-status-hidden').value;

                    const inquiryData = { 
                        id: getEl('inquiry-id').value || Date.now(), 
                        name: getEl('inquiry-name').value, 
                        contact: getEl('inquiry-contact').value, 
                        inquiryFor: getEl('inquiry-for').value, 
                        status: status
                    }; 
                    updateOrAddItem('inquiries', inquiryData); 
                    showToast(`Inquiry ${id ? 'updated' : 'added'}!`, 'success'); 
                    closeModal(); 
                    if(state.loggedInUser?.role === 'admin') renderInquiriesTable(); 
                }; 
            }
            
            function renderAccountSettingsPage() { 
                const mainContent = getEl('main-content');
                const adminProfile = state.loggedInUser;
                mainContent.innerHTML = renderHeader('User Account'); 
                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Profile Information</h3></div>
                        <form id="profile-settings-form">
                            <div class="form-group">
                                <label for="admin-name">Admin Name</label>
                                <input type="text" id="admin-name" value="${adminProfile.name || 'Admin'}">
                            </div>
                            <div class="form-group">
                                <label for="admin-photo-file">Admin Photo</label>
                                <input type="file" id="admin-photo-file" accept="image/*">
                                <input type="hidden" id="admin-photo-base64" value="${adminProfile.photo || ''}">
                                ${adminProfile.photo ? `<img src="${adminProfile.photo}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-top: 10px;">` : ''}
                            </div>
                            <button type="submit" class="action-button inline">Save Profile</button>
                        </form>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Change Password</h3></div>
                        <form id="change-password-form">
                            <div class="form-group"><label for="current-password">Current Password</label><input type="password" id="current-password" required></div>
                            <div class="form-group"><label for="new-password">New Password</label><input type="password" id="new-password" minlength="4" required></div>
                            <div class="form-group"><label for="confirm-new-password">Confirm New Password</label><input type="password" id="confirm-new-password" required></div>
                            <button type="submit" class="action-button inline">Change Password</button>
                        </form>
                    </div>
                </div>`; 

                getEl('admin-photo-file').onchange = async (e) => { 
                    if (e.target.files[0]) {
                        getEl('admin-photo-base64').value = await fileToBase64(e.target.files[0]);
                    }
                }; 

                getEl('profile-settings-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const currentAdmin = JSON.parse(localStorage.getItem('adminAccount'));
                    const newProfile = { 
                        ...currentAdmin,
                        name: getEl('admin-name').value, 
                        photo: getEl('admin-photo-base64').value 
                    }; 
                    localStorage.setItem('adminAccount', JSON.stringify(newProfile));
                    state.loggedInUser = {role: 'admin', ...newProfile};
                    localStorage.setItem('loggedInUser', JSON.stringify(state.loggedInUser));
                    showToast('Profile updated!', 'success'); 
                    renderSidebar(); 
                    renderAccountSettingsPage();
                };

                getEl('change-password-form').onsubmit = e => { 
                    e.preventDefault();
                    const currentAdmin = JSON.parse(localStorage.getItem('adminAccount')); 
                    const currentPass = getEl('current-password').value; 
                    const newPass = getEl('new-password').value; 
                    const confirmPass = getEl('confirm-new-password').value; 
                    if (btoa(currentPass) !== currentAdmin.password) { return showToast('Current password incorrect.', 'error'); } 
                    if (newPass.length < 4) { return showToast('New password must be at least 4 characters.', 'error'); } 
                    if (newPass !== confirmPass) { return showToast('New passwords do not match.', 'error'); } 
                    
                    const updatedAdmin = {...currentAdmin, password: btoa(newPass)};
                    localStorage.setItem('adminAccount', JSON.stringify(updatedAdmin));
                    state.loggedInUser = {role: 'admin', ...updatedAdmin};
                    localStorage.setItem('loggedInUser', JSON.stringify(state.loggedInUser));
                    showToast('Password changed successfully!', 'success'); 
                    e.target.reset(); 
                }; 
            }
            
            function renderAppearanceSettingsPage() { 
                const mainContent = getEl('main-content'); 
                const currentTheme = localStorage.getItem('theme') || 'dark'; 
                const currentWeight = localStorage.getItem('fontWeight') || 'normal'; 
                mainContent.innerHTML = renderHeader('Appearance'); 
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header" style="padding-bottom:10px; border:none;"><h3>Background Theme</h3></div><p>Choose between a light or dark background.</p><div class="form-group" style="margin-top: 20px;"><select id="theme-select"><option value="light" ${currentTheme === 'light' ? 'selected' : ''}>Light Mode</option><option value="dark" ${currentTheme === 'dark' ? 'selected' : ''}>Dark Mode</option></select></div></div><div class="card"><div class="card-header" style="padding-bottom:10px; border:none;"><h3>Font Weight</h3></div><p>Change the overall font weight.</p><div class="form-group" style="margin-top: 20px;"><select id="font-weight-select"><option value="light" ${currentWeight === 'light' ? 'selected' : ''}>Light</option><option value="normal" ${currentWeight === 'normal' ? 'selected' : ''}>Normal</option><option value="bold" ${currentWeight === 'bold' ? 'selected' : ''}>Bold</option></select></div></div></div>`; 
                getEl('theme-select').onchange = (e) => changeTheme(e.target.value); 
                getEl('font-weight-select').onchange = changeFontWeight; 
            }
            
             function renderContentSettingsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Site Content Management');
                const { siteContent } = state.data;

                const newsItemsHtml = (siteContent.latestNews || []).sort((a,b) => b.id-a.id).map(item => `
                    <div class="notice-item">
                        <h4>${item.title}</h4>
                        <p>${item.content.substring(0, 100)}...</p>
                        <div class="action-buttons no-print">
                            <button class="edit-btn" onclick="showNewsForm('${item.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" onclick="deleteNewsItem('${item.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('') || '<p>No news items yet.</p>';

                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>From the Principal's Desk</h3></div>
                        <form id="principal-desk-form">
                            <div class="form-group">
                                <textarea id="principal-desk-content" rows="6" required>${siteContent.principalDesk || ''}</textarea>
                            </div>
                            <button type="submit" class="action-button inline">Save Changes</button>
                        </form>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>About Our School</h3></div>
                        <form id="about-school-form">
                            <div class="form-group">
                                <textarea id="about-school-content" rows="6" required>${siteContent.aboutSchool || ''}</textarea>
                            </div>
                            <button type="submit" class="action-button inline">Save Changes</button>
                        </form>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>Latest News</h3>
                            <button class="action-button inline" onclick="showNewsForm()"><i class="fas fa-plus"></i> Add News</button>
                        </div>
                        <div id="news-items-list">${newsItemsHtml}</div>
                    </div>
                </div>`;
                
                getEl('principal-desk-form').onsubmit = e => {
                    e.preventDefault();
                    state.data.siteContent.principalDesk = getEl('principal-desk-content').value;
                    saveData();
                    showToast("Principal's message updated!", 'success');
                };
                getEl('about-school-form').onsubmit = e => {
                    e.preventDefault();
                    state.data.siteContent.aboutSchool = getEl('about-school-content').value;
                    saveData();
                    showToast("About school content updated!", 'success');
                };
            }
            
            function renderSetTopperPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Set School Toppers');
                 mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Set School Toppers Manually</h3></div>
                        <p>Manually select students to display as school toppers on the dashboard. If no students are selected, the system will automatically display the topper based on the latest exam marks.</p>
                        <div class="search-box-container" style="margin-top: 20px;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="topper-lookup-input" oninput="lookupTopperStudent(this.value)" placeholder="Search student by name or admission no..." class="search-input">
                        </div>
                        <div id="topper-lookup-results"></div>
                        <hr style="border-color: var(--border-color); margin: 20px 0;">
                        <div id="current-toppers-display"></div>
                    </div>
                 </div>`;
                 displayCurrentManualToppers();
            }

            function lookupTopperStudent(query) {
                const resultsContainer = getEl('topper-lookup-results');
                if (!resultsContainer) return;
                query = query.trim().toLowerCase();
                
                if (!query) {
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                const existingTopperIds = state.data.siteContent.manualTopperStudentIds || [];
                const results = (state.data.students || [])
                    .filter(s => 
                        !existingTopperIds.includes(s.id) && 
                        ((s.name && s.name.toLowerCase().includes(query)) ||
                         (s.admissionNumber && s.admissionNumber.toLowerCase().includes(query)))
                    ).slice(0, 5);
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No students found or they are already in the topper list.</p>';
                } else {
                    resultsContainer.innerHTML = results.map(s => `
                        <div class="lookup-result-item">
                            <img src="${s.photo || 'https://via.placeholder.com/50?text=S'}" alt="Photo">
                            <div style="flex-grow: 1;">
                                <strong>${s.name}</strong>
                                <p style="font-size: 0.9em; color: var(--text-muted);">Class ${s.className || 'N/A'}</p>
                            </div>
                            <button class="action-button inline" onclick="addManualTopper('${s.id}')">Set as Topper</button>
                        </div>
                    `).join('');
                }
            }

            function addManualTopper(studentId) {
                if (!state.data.siteContent.manualTopperStudentIds.includes(studentId)) {
                    state.data.siteContent.manualTopperStudentIds.push(studentId);
                    saveData();
                    showToast("Student added to toppers list!", "success");
                    getEl('topper-lookup-input').value = '';
                    getEl('topper-lookup-results').innerHTML = '';
                    displayCurrentManualToppers();
                } else {
                     showToast("This student is already a topper.", "info");
                }
            }

            function removeManualTopper(studentId) {
                state.data.siteContent.manualTopperStudentIds = state.data.siteContent.manualTopperStudentIds.filter(id => id !== studentId);
                saveData();
                showToast("Topper removed from the manual list.", "info");
                displayCurrentManualToppers();
            }
            
            function displayCurrentManualToppers() {
                const container = getEl('current-toppers-display');
                if(!container) return;

                const topperIds = state.data.siteContent.manualTopperStudentIds;
                if(topperIds && topperIds.length > 0) {
                    let toppersHtml = '<h4>Current Manual Toppers:</h4>';
                    topperIds.forEach(topperId => {
                         const student = findById('students', topperId);
                         if(student) {
                             toppersHtml += `
                                <div class="lookup-result-item">
                                    <img src="${student.photo || 'https://via.placeholder.com/50?text=S'}" alt="Photo">
                                    <div style="flex-grow: 1;">
                                        <strong>${student.name}</strong>
                                        <p style="font-size: 0.9em; color: var(--text-muted);">Class ${student.className || 'N/A'}</p>
                                    </div>
                                    <button class="action-button secondary" onclick="removeManualTopper('${student.id}')">Remove</button>
                                </div>`;
                         }
                    });
                     container.innerHTML = toppersHtml;
                } else {
                     container.innerHTML = '<p style="color: var(--text-muted);">No manual toppers selected. Auto-selection is active.</p>';
                }
            }

            window.showNewsForm = (id = null) => {
                const newsItem = id ? (state.data.siteContent.latestNews || []).find(n => n.id == id) : {};
                const title = id ? 'Edit News Item' : 'Add New News Item';
                const formContent = `<form id="news-form">
                    <input type="hidden" id="news-id" value="${newsItem.id || ''}">
                    <div class="form-group"><label for="news-title">Title</label><input type="text" id="news-title" value="${newsItem.title || ''}" required></div>
                    <div class="form-group"><label for="news-content">Content</label><textarea id="news-content" rows="5" required>${newsItem.content || ''}</textarea></div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add News'}</button>
                </form>`;
                showModal(title, formContent);
                getEl('news-form').onsubmit = e => {
                    e.preventDefault();
                    const newsId = getEl('news-id').value || Date.now();
                    const newsData = { id: newsId, title: getEl('news-title').value, content: getEl('news-content').value };
                    
                    if (!state.data.siteContent.latestNews) state.data.siteContent.latestNews = [];
                    const index = state.data.siteContent.latestNews.findIndex(n => n.id == newsId);
                    if (index > -1) {
                        state.data.siteContent.latestNews[index] = newsData;
                    } else {
                        state.data.siteContent.latestNews.push(newsData);
                    }
                    saveData();
                    showToast(`News item ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal();
                    renderContentSettingsPage();
                };
            };
            
            window.deleteNewsItem = (id) => {
                if(confirm('Are you sure you want to delete this news item?')) {
                    state.data.siteContent.latestNews = (state.data.siteContent.latestNews || []).filter(item => item.id != id);
                    saveData();
                    showToast('News item deleted.', 'success');
                    renderContentSettingsPage();
                }
            };


            function renderDataSettingsPage() { 
                const mainContent = getEl('main-content'); 
                mainContent.innerHTML = renderHeader('Data Management'); 
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>Export Data</h3></div><p>Download all application data as a single JSON file.</p><button id="export-data-btn" class="action-button inline" style="margin-top:15px;"><i class="fas fa-download"></i> Export Data</button></div><div class="card"><div class="card-header"><h3>Import Data</h3></div><p><strong>Warning:</strong> This will overwrite all current data.</p><input type="file" id="import-data-input" accept=".json" style="margin-top:15px;"><button id="import-data-btn" class="action-button inline"><i class="fas fa-upload"></i> Import Data</button></div><div class="card" style="border: 2px solid var(--error-color);"><div class="card-header"><h3>Reset Application</h3></div><p><strong>DANGER:</strong> This will delete everything.</p><button id="reset-app-btn" class="action-button inline" style="background: var(--error-color); margin-top:15px;"><i class="fas fa-bomb"></i> Reset All Data</button></div></div>`; 
                getEl('export-data-btn').onclick = () => { 
                    const dataStr = JSON.stringify(state.data); 
                    const dataBlob = new Blob([dataStr], {type: "application/json"}); 
                    const url = URL.createObjectURL(dataBlob); 
                    const a = document.createElement('a'); a.href = url; 
                    a.download = `school-backup-${new Date().toISOString().slice(0,10)}.json`; 
                    a.click(); 
                    URL.revokeObjectURL(url); 
                    showToast('Data exported!', 'success'); 
                }; 
                getEl('import-data-btn').onclick = () => { 
                    const fileInput = getEl('import-data-input'); 
                    if (fileInput.files.length === 0) return showToast('Please select a backup file first.', 'info'); 
                    if (confirm('Are you sure you want to import data? This cannot be undone.')) { 
                        const file = fileInput.files[0]; 
                        const reader = new FileReader(); 
                        reader.onload = e => { 
                            try { 
                                const importedData = JSON.parse(e.target.result); 
                                if(importedData.students) { 
                                    state.data = importedData; 
                                    saveData(); 
                                    showToast('Data imported! Reloading...', 'success'); 
                                    setTimeout(() => location.reload(), 1500); 
                                } else { 
                                    showToast('Invalid backup file format.', 'error'); 
                                } 
                            } catch (err) { 
                                showToast('Error reading backup file.', 'error'); 
                            } 
                        }; 
                        reader.readAsText(file); 
                    } 
                }; 
                getEl('reset-app-btn').onclick = () => { 
                    if(confirm('ARE YOU SURE? This will permanently delete all data.')) { 
                        if(prompt('To confirm, type "DELETE" in the box.') === 'DELETE') { 
                            localStorage.clear(); 
                            showToast('Application reset. Reloading...', 'info'); 
                            setTimeout(() => location.reload(), 1500); 
                        } else { 
                            showToast('Reset cancelled.', 'info'); 
                        } 
                    } 
                }; 
            }
            
            function renderPromoteStudentsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Promote Students');
                const classOptions = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'].map(c => `<option value="${c}">Class ${c}</option>`).join('');
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card">
                            <div class="card-header"><h3>Student Promotion Tool</h3></div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="promote-from-class">Promote From Class</label>
                                    <select id="promote-from-class" onchange="renderPromotionStudentList()"><option value="">Select a class</option>${classOptions}</select>
                                </div>
                                <div class="form-group">
                                    <label for="promote-to-class">Promote To Class</label>
                                    <select id="promote-to-class"><option value="">Select a class</option>${classOptions}</select>
                                </div>
                            </div>
                            <div id="promotion-student-list" style="margin-top: 20px;"></div>
                        </div>
                    </div>`;
            }
            function renderPromotionStudentList() {
                const container = getEl('promotion-student-list');
                const fromClass = getEl('promote-from-class').value;
                container.innerHTML = '';
                if (!fromClass) return;
                const studentsInClass = (state.data.students || []).filter(s => s.className === fromClass);
                if (studentsInClass.length === 0) {
                    container.innerHTML = '<p>No students found in this class.</p>';
                    return;
                }

                let listHtml = `
                    <div class="table-container">
                        <table>
                            <thead><tr><th><input type="checkbox" onchange="toggleAllPromotionCheckboxes(this.checked)"></th><th>Name</th><th>Admission No.</th></tr></thead>
                            <tbody>
                                ${studentsInClass.map(s => `<tr><td><input type="checkbox" class="promotion-checkbox" value="${s.id}"></td><td>${s.name}</td><td>${s.admissionNumber}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    <button class="action-button" style="margin-top: 20px;" onclick="handleStudentPromotion()">Promote Selected Students</button>
                `;
                container.innerHTML = listHtml;
            }
            window.toggleAllPromotionCheckboxes = (checked) => {
                document.querySelectorAll('.promotion-checkbox').forEach(cb => cb.checked = checked);
            }
            function handleStudentPromotion() {
                const fromClass = getEl('promote-from-class').value;
                const toClass = getEl('promote-to-class').value;
                if (!fromClass || !toClass) {
                    return showToast('Please select both "From" and "To" classes.', 'error');
                }
                if (fromClass === toClass) {
                    return showToast('"From" and "To" classes cannot be the same.', 'error');
                }

                const selectedStudentIds = Array.from(document.querySelectorAll('.promotion-checkbox:checked')).map(cb => cb.value);
                if (selectedStudentIds.length === 0) {
                    return showToast('Please select at least one student to promote.', 'error');
                }
                
                let promotedCount = 0;
                selectedStudentIds.forEach(id => {
                    const student = findById('students', id);
                    if(student) {
                        student.className = toClass;
                        if (!['11', '12'].includes(toClass)) {
                            student.stream = null;
                        }
                        updateOrAddItem('students', student);
                        promotedCount++;
                    }
                });
                saveData();
                
                if (promotedCount > 0) {
                    showToast(`${promotedCount} student(s) promoted to Class ${toClass} successfully!`, 'success');
                    renderPromotionStudentList();
                }
            }

            function renderMarksheetManagerPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Marksheet Manager');

                const examOptions = (state.data.examMasters || []).sort((a,b) => b.id - a.id).map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');
                const classOptions = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
                    .map(c => `<option value="${c}">Class ${c}</option>`).join('');

                mainContent.innerHTML += `<div class="page active"><div class="card">
                    <div class="card-header"><h3>Enter Student Marks</h3></div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="marks-exam-select">Select Exam</label>
                            <select id="marks-exam-select" onchange="renderMarksEntryTable()">
                                <option value="">Select Exam</option>${examOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="marks-class-select">Select Class</label>
                            <select id="marks-class-select" onchange="renderMarksEntryTable()">
                                <option value="">Select Class</option>${classOptions}
                            </select>
                        </div>
                    </div>
                    <form id="marks-entry-form"><div id="marks-entry-table-container"></div></form>
                </div></div>`;
            }

            function renderMarksEntryTable() {
                const container = getEl('marks-entry-table-container');
                const examMasterId = getEl('marks-exam-select').value;
                const classNameValue = getEl('marks-class-select').value;

                container.innerHTML = '';
                if (!examMasterId || !classNameValue) {
                    container.innerHTML = '<p style="text-align:center; color:var(--text-muted); margin-top:20px;">Please select an exam and a class to enter marks.</p>';
                    return;
                }
                
                const className = classNameValue.replace('Class ','');
                const studentsInClass = (state.data.students || []).filter(s => s.className === className);
                const subjectsForClass = (state.data.examSchedules || []).filter(sch => sch.examMasterId === examMasterId && sch.className === classNameValue).map(sch => sch.subject);

                if (studentsInClass.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:var(--error-color); margin-top:20px;">No students found in the selected class.</p>';
                    return;
                }
                if (subjectsForClass.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:var(--error-color); margin-top:20px;">No subjects scheduled for this class in the selected exam.</p>';
                    return;
                }

                let tableHtml = `<div class="table-container" style="margin-top:20px;"><table id="marks-table"><thead>
                                <tr>
                                    <th rowspan="2">Student Name</th>`;
                subjectsForClass.forEach(sub => {
                    tableHtml += `<th colspan="4" style="text-align:center;">${sub}</th>`;
                });
                tableHtml += `</tr><tr>`;
                 subjectsForClass.forEach(sub => {
                    tableHtml += `<th style="text-align:center;">Th. Max</th><th style="text-align:center;">Th. Obt.</th><th style="text-align:center;">Pr. Max</th><th style="text-align:center;">Pr. Obt.</th>`;
                });
                tableHtml += `</tr></thead><tbody>`;

                const marksForExam = state.data.marks[examMasterId] || {};

                studentsInClass.sort((a,b) => a.rollNumber - b.rollNumber).forEach(student => {
                    const studentMarks = marksForExam[student.id] || [];
                    tableHtml += `<tr><td>${student.name}<br><small>Roll: ${student.rollNumber}</small></td>`;
                    subjectsForClass.forEach(subject => {
                        const mark = studentMarks.find(m => m.subject === subject) || {};
                        tableHtml += `
                            <td><input type="number" class="mark-input" data-student-id="${student.id}" data-subject="${subject}" data-type="theoryMax" placeholder="e.g. 70" value="${mark.theoryMax || '70'}" style="width: 80px;"></td>
                            <td><input type="number" class="mark-input" data-student-id="${student.id}" data-subject="${subject}" data-type="theoryGot" placeholder="e.g. 55" value="${mark.theoryGot || ''}" style="width: 80px;"></td>
                            <td><input type="number" class="mark-input" data-student-id="${student.id}" data-subject="${subject}" data-type="practicalMax" placeholder="e.g. 30" value="${mark.practicalMax || '30'}" style="width: 80px;"></td>
                            <td><input type="number" class="mark-input" data-student-id="${student.id}" data-subject="${subject}" data-type="practicalGot" placeholder="e.g. 25" value="${mark.practicalGot || ''}" style="width: 80px;"></td>
                        `;
                    });
                    tableHtml += `</tr>`;
                });

                tableHtml += `</tbody></table></div><button type="submit" class="action-button" style="margin-top:20px;">Save All Marks</button>`;
                container.innerHTML = tableHtml;
                
                getEl('marks-entry-form').onsubmit = handleSaveMarks;
            }

            function handleSaveMarks(e) {
                e.preventDefault();
                const examMasterId = getEl('marks-exam-select').value;
                if (!examMasterId) return;

                if (!state.data.marks[examMasterId]) {
                    state.data.marks[examMasterId] = {};
                }
                
                const allInputs = document.querySelectorAll('.mark-input');
                const marksByStudent = {};

                allInputs.forEach(input => {
                    const { studentId, subject, type } = input.dataset;
                    const value = input.value;

                    if (!marksByStudent[studentId]) marksByStudent[studentId] = {};
                    if (!marksByStudent[studentId][subject]) marksByStudent[studentId][subject] = { subject };
                    
                    marksByStudent[studentId][subject][type] = value ? parseInt(value) : 0;
                });
                
                for (const studentId in marksByStudent) {
                    state.data.marks[examMasterId][studentId] = Object.values(marksByStudent[studentId]);
                }
                
                saveData();
                showToast('Marks saved successfully!', 'success');
            }

            function showMarksheet(studentId, examMasterId, container) {
                const schoolInfo = state.data.siteContent;
                const student = findById('students', studentId);
                const examMaster = findById('examMasters', examMasterId);
                const marksData = (state.data.marks[examMasterId] || {})[student.id] || [];
                
                if (marksData.length === 0) {
                    container.innerHTML = `<p class="form-feedback error">Marksheet not available for the selected exam.</p>`;
                    return;
                }

                let totalMarksGot = 0;
                let totalMaxMarks = 0;
                let isFail = false;

                const markRows = marksData.map(m => {
                    const theoryMax = m.theoryMax || 0;
                    const practicalMax = m.practicalMax || 0;
                    const theoryGot = m.theoryGot || 0;
                    const practicalGot = m.practicalGot || 0;

                    const subjectTotal = theoryGot + practicalGot;
                    const subjectMax = theoryMax + practicalMax;
                    
                    const passingPercentage = 33;
                    const subjectPercentage = subjectMax > 0 ? (subjectTotal / subjectMax) * 100 : 0;
                    const subjectResult = subjectPercentage >= passingPercentage ? 'PASS' : 'FAIL';
                    if(subjectResult === 'FAIL') isFail = true;

                    totalMarksGot += subjectTotal;
                    totalMaxMarks += subjectMax;
                    
                    const subjectSchedule = (state.data.examSchedules || []).find(sch => sch.examMasterId === examMasterId && sch.className === `Class ${student.className}` && sch.subject === m.subject);
                    const subjectDate = subjectSchedule ? new Date(subjectSchedule.date).toLocaleDateString('en-GB') : '-';

                    return `<tr>
                        <td>${m.subject}</td>
                        <td>${subjectDate}</td>
                        <td>${theoryMax}</td>
                        <td>${theoryGot}</td>
                        <td>${practicalMax}</td>
                        <td>${practicalGot}</td>
                        <td>${subjectMax}</td>
                        <td>${subjectTotal}</td>
                        <td style="font-weight: bold; color: ${subjectResult === 'PASS' ? 'var(--success-color)' : 'var(--error-color)'}">${subjectResult}</td>
                    </tr>`;
                }).join('');

                const overallPercentage = totalMaxMarks > 0 ? (totalMarksGot / totalMaxMarks) * 100 : 0;
                const finalResult = isFail ? 'FAIL' : 'PASS';
                const grade = calculateGrade(overallPercentage);
                const schoolCodeHtml = schoolInfo.schoolCode ? `<p><strong>School Code:</strong> ${schoolInfo.schoolCode}</p>` : '';

                const marksheetHtml = `
                    <div class="printable-area">
                        <div class="marksheet-container">
                            <div class="marksheet-header">
                                <h2>${schoolInfo.schoolName || 'School Name'}</h2>
                                <h3>${schoolInfo.schoolAddress || 'School Address'}</h3>
                                <h4>STATEMENT OF MARKS - ${examMaster.name}</h4>
                            </div>
                            
                            <div class="marksheet-student-info">
                               <div class="marksheet-student-details">
                                    <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                                    ${schoolCodeHtml}
                                    <p><strong>Student Name:</strong> ${student.name}</p>
                                    <p><strong>Mother's Name:</strong> ${student.motherName}</p>
                                    <p><strong>Father's Name:</strong> ${student.fatherName}</p>
                                    <p><strong>Date of Birth:</strong> ${new Date(student.dob).toLocaleDateString('en-GB')}</p>
                                    <p><strong>Class:</strong> Class ${student.className} ${student.stream ? `(${student.stream})`: ''}</p>
                                </div>
                                <img src="${student.photo}" alt="Student Photo" class="marksheet-student-photo">
                            </div>

                            <div class="table-container">
                                <table class="marksheet-table">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">Subject Name</th>
                                            <th rowspan="2">Exam Date</th>
                                            <th colspan="2">Theory Marks</th>
                                            <th colspan="2">Practical Marks</th>
                                            <th rowspan="2">Total Marks</th>
                                            <th rowspan="2">Sub. Total</th>
                                            <th rowspan="2">Result</th>
                                        </tr>
                                        <tr>
                                            <th>Max</th><th>Obt.</th>
                                            <th>Max</th><th>Obt.</th>
                                        </tr>
                                    </thead>
                                    <tbody>${markRows}</tbody>
                                </table>
                            </div>

                             <div class="marksheet-summary-grid">
                                <div class="marksheet-summary-item">
                                    <strong>Grand Total</strong>
                                    <span>${totalMarksGot} / ${totalMaxMarks}</span>
                                </div>
                                <div class="marksheet-summary-item">
                                    <strong>Percentage</strong>
                                    <span>${overallPercentage.toFixed(2)}%</span>
                                </div>
                                <div class="marksheet-summary-item">
                                    <strong>Grade</strong>
                                    <span>${grade}</span>
                                </div>
                                <div class="marksheet-summary-item">
                                    <strong>Final Result</strong>
                                    <span class="${finalResult.toLowerCase()}">${finalResult}</span>
                                </div>
                             </div>
                             <div class="marksheet-footer">
                                <p><strong>Result Declared On:</strong> ${examMaster.declarationDate ? new Date(examMaster.declarationDate).toLocaleDateString('en-GB') : 'Not Declared'}</p>
                                <p><strong>Principal's Signature</strong></p>
                             </div>
                        </div>
                    </div>
                     <button class="action-button no-print" style="margin-top: 20px;" onclick="printContent('.printable-area')"><i class="fas fa-print"></i> Print Marksheet</button>
                `;
                container.innerHTML = marksheetHtml;
            }
            
            function calculateGrade(percentage) {
                if (percentage >= 90) return 'A1';
                if (percentage >= 80) return 'A2';
                if (percentage >= 70) return 'B1';
                if (percentage >= 60) return 'B2';
                if (percentage >= 50) return 'C1';
                if (percentage >= 40) return 'C2';
                if (percentage >= 33) return 'D';
                return 'E';
            }
            
            function renderHomeworkPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showHomeworkForm()"><i class="fas fa-plus"></i> Add Homework</button>`;
                mainContent.innerHTML = renderHeader('Homework Management', actionsHtml);

                const classOptions = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
                    .map(c => `<option value="${c}">Class ${c}</option>`).join('');

                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="form-group">
                            <label for="homework-class-filter">Filter by Class</label>
                            <select id="homework-class-filter" onchange="renderHomeworkTable()">
                                <option value="all">Show All</option>
                                ${classOptions}
                            </select>
                        </div>
                        <div class="table-container"><table id="homework-table"></table></div>
                    </div>
                </div>`;
                renderHomeworkTable();
            }

            function renderHomeworkTable() {
                const table = getEl('homework-table');
                if (!table) return;

                const selectedClass = getEl('homework-class-filter').value;
                let homeworkList = state.data.homework || [];

                if (selectedClass !== 'all') {
                    homeworkList = homeworkList.filter(h => h.className === selectedClass);
                }

                let html = `<thead><tr><th>Class</th><th>Subject</th><th>Title</th><th>Due Date</th><th>Actions</th></tr></thead><tbody>`;
                if (homeworkList.length === 0) {
                    html += `<tr><td colspan="5" style="text-align:center;">No homework found for this class.</td></tr>`;
                } else {
                    homeworkList.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate)).forEach(h => {
                        html += `<tr>
                            <td>Class ${h.className}</td>
                            <td>${h.subject}</td>
                            <td>${h.title}</td>
                            <td>${new Date(h.dueDate).toLocaleDateString()}</td>
                            <td class="action-buttons">
                                <button class="edit-btn" onclick="showHomeworkForm('${h.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteItem('homework', '${h.id}', 'Delete this homework?', renderHomeworkTable)" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                }
                html += `</tbody>`;
                table.innerHTML = html;
            }

            function showHomeworkForm(id = null) {
                const homework = id ? findById('homework', id) : {};
                const title = id ? 'Edit Homework' : 'Add New Homework';

                const classOptions = ['LKG', 'UKG', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
                    .map(c => `<option value="${c}" ${homework.className === c ? 'selected' : ''}>Class ${c}</option>`).join('');

                const formContent = `<form id="homework-form">
                    <input type="hidden" id="homework-id" value="${homework.id || ''}">
                    <div class="form-group">
                        <label for="homework-class">Class</label>
                        <select id="homework-class" required>${classOptions}</select>
                    </div>
                    <div class="form-group">
                        <label for="homework-subject">Subject</label>
                        <input type="text" id="homework-subject" value="${homework.subject || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="homework-title">Title</label>
                        <input type="text" id="homework-title" value="${homework.title || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="homework-description">Description</label>
                        <textarea id="homework-description" rows="4" required>${homework.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="homework-due-date">Due Date</label>
                        <input type="date" id="homework-due-date" value="${homework.dueDate || new Date().toISOString().slice(0, 10)}" required>
                    </div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Homework'}</button>
                </form>`;
                showModal(title, formContent);
                getEl('homework-form').onsubmit = (e) => {
                    e.preventDefault();
                    const homeworkData = {
                        id: getEl('homework-id').value || Date.now().toString(),
                        className: getEl('homework-class').value,
                        subject: getEl('homework-subject').value,
                        title: getEl('homework-title').value,
                        description: getEl('homework-description').value,
                        dueDate: getEl('homework-due-date').value,
                    };
                    updateOrAddItem('homework', homeworkData);
                    showToast(`Homework ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal();
                    renderHomeworkTable();
                };
            }
            
            function renderStudentHomeworkView() {
                const user = state.loggedInUser;
                const student = user.role === 'parent' ? findById('students', user.studentId) : user;
                if (!student) return;

                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('My Homework');

                const homeworkList = (state.data.homework || [])
                    .filter(h => h.className === student.className)
                    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                let homeworkHtml = '';
                if (homeworkList.length === 0) {
                    homeworkHtml = '<div class="card"><p>No homework assigned for your class yet.</p></div>';
                } else {
                    homeworkHtml = homeworkList.map(h => `
                        <div class="card">
                            <div class="card-header">
                                <h3>${h.title}</h3>
                                <span style="color: var(--text-muted);">Due: ${new Date(h.dueDate).toLocaleDateString()}</span>
                            </div>
                            <p><strong>Subject:</strong> ${h.subject}</p>
                            <p style="margin-top: 10px; white-space: pre-wrap;">${h.description}</p>
                        </div>
                    `).join('');
                }

                mainContent.innerHTML += `<div class="page active">${homeworkHtml}</div>`;
            }

            function renderPublicProfileSearchPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Find Profile');

                mainContent.innerHTML += `<div class="page active"><div class="card">
                        <div class="card-header"><h3>Find Member Profile</h3></div>
                        <p>Enter the ID and Date of Birth to view the profile of a student, teacher, or staff member.</p>
                        <form id="find-public-profile-form" style="margin-top:20px;">
                             <div class="form-group">
                                <label for="profile-type">Select Member Type</label>
                                <select id="profile-type" required>
                                    <option value="student">Student</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="staff">Staff</option>
                                </select>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="profile-id-number">Roll No / Employee ID</label>
                                    <input type="text" id="profile-id-number" placeholder="Enter ID" required>
                                </div>
                                <div class="form-group">
                                    <label for="profile-dob">Date of Birth</label>
                                    <input type="text" id="profile-dob" placeholder="YYYY-MM-DD" required>
                                </div>
                            </div>
                            <button type="submit" class="action-button inline">Find Profile</button>
                        </form>
                        <div id="public-profile-display-area" style="margin-top:30px;"></div>
                    </div></div>`;

                getEl('find-public-profile-form').onsubmit = (e) => {
                    e.preventDefault();
                    handleFindPublicProfile();
                };
            }
            
            function handleFindPublicProfile() {
                const memberType = getEl('profile-type').value;
                const idNumber = getEl('profile-id-number').value.trim().toLowerCase();
                const dob = getEl('profile-dob').value;
                const resultArea = getEl('public-profile-display-area');
                resultArea.innerHTML = '';

                let member = null;
                if (memberType === 'student') {
                    member = (state.data.students || []).find(s => s.rollNumber && s.rollNumber.toLowerCase() === idNumber && s.dob === dob);
                } else if (memberType === 'teacher') {
                    member = (state.data.teachers || []).find(t => t.employeeId && t.employeeId.toLowerCase() === idNumber && t.dob === dob);
                } else if (memberType === 'staff') {
                    member = (state.data.staff || []).find(s => s.employeeId && s.employeeId.toLowerCase() === idNumber && s.dob === dob);
                }

                if (member) {
                    resultArea.innerHTML = getPublicProfileHtml(member, memberType);
                } else {
                    resultArea.innerHTML = `<p class="form-feedback error">No member found with these details. Please check the ID and Date of Birth.</p>`;
                }
            }

            function getPublicProfileHtml(member, type) {
                const signatureDoc = (member.documents || []).find(doc => doc.name && doc.name.toLowerCase().includes('signature'));
                let detailsHtml = '';

                if (type === 'student') {
                    const academicInfo = member.stream ? `Class ${member.className} (${member.stream})` : `Class ${member.className}`;
                    detailsHtml = `
                        <li><i class="fas fa-id-card"></i> Adm No: ${member.admissionNumber || 'N/A'}</li>
                        <li><i class="fas fa-hashtag"></i> Roll No: ${member.rollNumber || 'N/A'}</li>
                        <li><i class="fas fa-school"></i> ${academicInfo}</li>
                        <li><i class="fas fa-user-tie"></i> Father: ${member.fatherName || 'N/A'}</li>
                    `;
                } else {
                    detailsHtml = `
                        <li><i class="fas fa-id-card"></i> Employee ID: ${member.employeeId || 'N/A'}</li>
                        <li><i class="fas fa-briefcase"></i> Role: ${member.role || 'N/A'}</li>
                        <li><i class="fas fa-phone"></i> Contact: ${member.contact || 'N/A'}</li>
                    `;
                }

                return `
                    <div class="card profile-card" style="max-width: 500px; margin: auto;">
                        <img class="profile-photo" src="${member.photo || 'https://via.placeholder.com/150?text=?'}" alt="Photo">
                        ${signatureDoc ? `<img src="${signatureDoc.data}" alt="Signature" style="display:block; margin: -10px auto 15px; height: 40px; max-width: 150px; object-fit: contain;">` : ''}
                        <h2 style="text-align: center;">${member.name}</h2>
                        <ul class="profile-details">${detailsHtml}</ul>
                    </div>`;
            }

            function renderSchoolInfoSettingsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('School Information');
                const schoolInfo = state.data.siteContent;

                const states = Object.keys(indianStatesData);
                const stateOptions = states.map(s => `<option value="${s}" ${schoolInfo.schoolState === s ? 'selected' : ''}>${s}</option>`).join('');

                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Update School Information</h3></div>
                        <p>This information will be used on all documents like admit cards, results, and receipts.</p>
                        <form id="school-info-form" style="margin-top:20px;">
                            <div class="form-group">
                                <label for="school-name">School Name</label>
                                <input type="text" id="school-name" value="${schoolInfo.schoolName || ''}" required>
                            </div>
                             <div class="form-group">
                                <label for="school-code">School Code</label>
                                <input type="text" id="school-code" value="${schoolInfo.schoolCode || ''}" placeholder="e.g., 12345">
                            </div>
                            <div class="form-group">
                                <label for="school-address">Full Address</label>
                                <textarea id="school-address" rows="3" required>${schoolInfo.schoolAddress || ''}</textarea>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="school-state">State</label>
                                    <select id="school-state" onchange="populateDistricts()">${stateOptions}</select>
                                </div>
                                <div class="form-group">
                                    <label for="school-district">District</label>
                                    <select id="school-district"></select>
                                </div>
                            </div>
                            <button type="submit" class="action-button inline">Save School Info</button>
                        </form>
                    </div>
                </div>`;
                
                populateDistricts(schoolInfo.schoolDistrict);

                getEl('school-info-form').onsubmit = e => {
                    e.preventDefault();
                    state.data.siteContent.schoolName = getEl('school-name').value;
                    state.data.siteContent.schoolCode = getEl('school-code').value;
                    state.data.siteContent.schoolAddress = getEl('school-address').value;
                    state.data.siteContent.schoolState = getEl('school-state').value;
                    state.data.siteContent.schoolDistrict = getEl('school-district').value;
                    saveData();
                    showToast("School information updated successfully!", "success");
                    renderUI(); // Re-render to update footer etc.
                };
            }

            window.populateDistricts = (selectedDistrict = null) => {
                const stateSelect = getEl('school-state');
                const districtSelect = getEl('school-district');
                const selectedState = stateSelect.value;
                districtSelect.innerHTML = '';
                
                if (indianStatesData[selectedState]) {
                    indianStatesData[selectedState].forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        if (district === selectedDistrict) {
                            option.selected = true;
                        }
                        districtSelect.appendChild(option);
                    });
                }
            };
            
            function renderManageLinksPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showLinkForm()"><i class="fas fa-plus"></i> Add Link</button>`;
                mainContent.innerHTML = renderHeader('Manage External Links', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div id="links-list"></div></div></div>`;
                renderLinksList();
            }

            function renderLinksList() {
                const container = getEl('links-list');
                if(!container) return;
                const links = state.data.externalLinks || [];
                if(links.length === 0) {
                    container.innerHTML = '<p>No external links added yet.</p>';
                    return;
                }
                let html = '<ul class="detail-list">';
                links.forEach(link => {
                    html += `<li><span><strong>${link.title}</strong><br><small>${link.url}</small></span>
                    <div class="action-buttons"><button class="edit-btn" onclick="showLinkForm('${link.id}')"><i class="fas fa-edit"></i></button><button class="delete-btn" onclick="deleteItem('externalLinks', '${link.id}', 'Delete this link?', renderLinksList)"><i class="fas fa-trash"></i></button></div>
                    </li>`;
                });
                html += '</ul>';
                container.innerHTML = html;
            }

            function showLinkForm(id=null){
                 const link = id ? findById('externalLinks', id) : {};
                 const title = id ? 'Edit Link' : 'Add New Link';
                 const formContent = `<form id="link-form">
                    <input type="hidden" id="link-id" value="${link.id || ''}">
                    <div class="form-group"><label for="link-title">Link Title</label><input type="text" id="link-title" value="${link.title || ''}" required></div>
                    <div class="form-group"><label for="link-url">URL</label><input type="url" id="link-url" value="${link.url || ''}" required></div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Link'}</button>
                 </form>`;
                 showModal(title, formContent);
                 getEl('link-form').onsubmit = e => {
                    e.preventDefault();
                    const linkData = {
                        id: getEl('link-id').value || Date.now().toString(),
                        title: getEl('link-title').value,
                        url: getEl('link-url').value
                    };
                    updateOrAddItem('externalLinks', linkData);
                    showToast('Link saved!', 'success');
                    closeModal();
                    renderLinksList();
                    renderSidebar();
                 };
            }

            function renderSchoolPhotosSettingsPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showSchoolPhotoForm()"><i class="fas fa-plus"></i> Add Photo</button>`;
                mainContent.innerHTML = renderHeader('Manage School Photos', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div id="school-photos-list" class="school-photos-container"></div></div></div>`;
                renderSchoolPhotosList();
            }

            function renderSchoolPhotosList() {
                const container = getEl('school-photos-list');
                if (!container) return;
                const photos = state.data.schoolPhotos || [];
                if (photos.length === 0) {
                    container.innerHTML = `<p style="text-align:center; color: var(--text-muted);">No school photos uploaded yet. Click 'Add Photo' to start.</p>`;
                    return;
                }
                container.innerHTML = photos.map(photo => `
                    <div class="school-photo-item card">
                        <img src="${photo.image}" alt="${photo.title}">
                        <div class="gallery-item-footer">
                            <span>${photo.title}</span>
                            <button class="delete-btn" onclick="deleteItem('schoolPhotos', '${photo.id}', 'Delete this photo?', renderSchoolPhotosList)" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            function showSchoolPhotoForm() {
                const title = 'Add School Photo';
                const formContent = `<form id="school-photo-form">
                        <div class="form-group"><label for="school-photo-title">Photo Title</label><input type="text" id="school-photo-title" required></div>
                        <div class="form-group"><label for="school-photo-image">Select Image</label><input type="file" id="school-photo-image" accept="image/*" required></div>
                        <button type="submit" class="action-button">Upload Photo</button>
                    </form>`;
                showModal(title, formContent);
                getEl('school-photo-form').onsubmit = async e => {
                    e.preventDefault();
                    const imageFile = getEl('school-photo-image').files[0];
                    if (!imageFile) return;
                    const photoData = {
                        id: Date.now().toString(),
                        title: getEl('school-photo-title').value,
                        image: await fileToBase64(imageFile)
                    };
                    updateOrAddItem('schoolPhotos', photoData);
                    showToast('School photo added!', 'success');
                    closeModal();
                    renderSchoolPhotosList();
                };
            }

            function renderUploadResultPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Upload Student Result');
                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Find Student to Upload Result</h3></div>
                        <div class="search-box-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="result-student-lookup" oninput="lookupResultStudent(this.value)" placeholder="Search student by Name, Roll No, or Admission No..." class="search-input">
                        </div>
                        <div id="result-student-lookup-results"></div>
                    </div>
                    <div id="result-upload-form-container"></div>
                </div>`;
            }
            
            function lookupResultStudent(query) {
                const resultsContainer = getEl('result-student-lookup-results');
                getEl('result-upload-form-container').innerHTML = ''; // Clear form on new search
                if (!resultsContainer) return;
                query = query.trim().toLowerCase();
                
                if (!query) {
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                const results = (state.data.students || []).filter(s => 
                    (s.name && s.name.toLowerCase().includes(query)) ||
                    (s.rollNumber && s.rollNumber.toLowerCase().includes(query)) ||
                    (s.admissionNumber && s.admissionNumber.toLowerCase().includes(query))
                ).slice(0, 5);
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No students found.</p>';
                } else {
                    resultsContainer.innerHTML = results.map(s => `
                        <div class="lookup-result-item">
                            <img src="${s.photo || 'https://via.placeholder.com/50?text=S'}" alt="Photo">
                            <div style="flex-grow: 1;">
                                <strong>${s.name}</strong>
                                <p style="font-size: 0.9em; color: var(--text-muted);">Class ${s.className || 'N/A'} | Roll: ${s.rollNumber || 'N/A'}</p>
                            </div>
                            <button class="action-button inline" onclick="showResultUploadForm('${s.id}')">Select</button>
                        </div>
                    `).join('');
                }
            }

            function showResultUploadForm(studentId) {
                getEl('result-student-lookup-results').innerHTML = '';
                const student = findById('students', studentId);
                const container = getEl('result-upload-form-container');
                
                const examOptions = (state.data.examMasters || []).sort((a,b) => b.id - a.id).map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');

                container.innerHTML = `<div class="card">
                    <form id="result-upload-form">
                        <h4>Uploading Result for: <strong>${student.name} (Class ${student.className})</strong></h4>
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="result-upload-exam">Select Exam</label>
                            <select id="result-upload-exam" required><option value="">--Select an Exam--</option>${examOptions}</select>
                        </div>
                        <div id="result-upload-subjects-container"></div>
                        <div id="result-upload-summary" style="display:none;"></div>
                        <button type="submit" class="action-button" style="margin-top:20px;">Save Result</button>
                    </form>
                </div>`;

                getEl('result-upload-exam').onchange = () => renderResultSubjects(studentId);

                getEl('result-upload-form').onsubmit = e => {
                    e.preventDefault();
                    handleSaveUploadedResult(studentId);
                };
            }
            
            function renderResultSubjects(studentId) {
                const student = findById('students', studentId);
                const examMasterId = getEl('result-upload-exam').value;
                const container = getEl('result-upload-subjects-container');
                
                if (!examMasterId) {
                    container.innerHTML = '';
                    getEl('result-upload-summary').style.display = 'none';
                    return;
                }

                const subjectsForClass = (state.data.examSchedules || [])
                    .filter(sch => sch.examMasterId === examMasterId && sch.className === `Class ${student.className}`)
                    .map(sch => sch.subject);

                if(subjectsForClass.length === 0) {
                    container.innerHTML = '<p class="form-feedback error">No subjects are scheduled for this class in the selected exam. Please add subjects in the Exams section first.</p>';
                     getEl('result-upload-summary').style.display = 'none';
                    return;
                }
                
                const existingMarks = ((state.data.marks || {})[examMasterId] || {})[studentId] || [];

                container.innerHTML = `
                    <div class="table-container" style="margin-top: 20px;">
                        <table id="result-upload-marks-table">
                            <thead><tr><th>Subject</th><th>Theory Max</th><th>Theory Obt.</th><th>Practical Max</th><th>Practical Obt.</th></tr></thead>
                            <tbody>
                            ${subjectsForClass.map(subject => {
                                const mark = existingMarks.find(m => m.subject === subject) || {};
                                return `<tr>
                                    <td>${subject}</td>
                                    <td><input type="number" data-subject="${subject}" data-type="theoryMax" value="${mark.theoryMax || 70}" oninput="updateResultSummary()"></td>
                                    <td><input type="number" data-subject="${subject}" data-type="theoryGot" value="${mark.theoryGot || ''}" oninput="updateResultSummary()"></td>
                                    <td><input type="number" data-subject="${subject}" data-type="practicalMax" value="${mark.practicalMax || 30}" oninput="updateResultSummary()"></td>
                                    <td><input type="number" data-subject="${subject}" data-type="practicalGot" value="${mark.practicalGot || ''}" oninput="updateResultSummary()"></td>
                                </tr>`;
                            }).join('')}
                            </tbody>
                        </table>
                    </div>`;
                updateResultSummary();
            }

            window.updateResultSummary = () => {
                const summaryContainer = getEl('result-upload-summary');
                const rows = getEl('result-upload-marks-table').querySelectorAll('tbody tr');
                let totalGot = 0, totalMax = 0, isFail = false;

                rows.forEach(row => {
                    const theoryMax = parseInt(row.querySelector('[data-type="theoryMax"]').value) || 0;
                    const theoryGot = parseInt(row.querySelector('[data-type="theoryGot"]').value) || 0;
                    const practicalMax = parseInt(row.querySelector('[data-type="practicalMax"]').value) || 0;
                    const practicalGot = parseInt(row.querySelector('[data-type="practicalGot"]').value) || 0;
                    
                    const subTotal = theoryGot + practicalGot;
                    const subMax = theoryMax + practicalMax;
                    totalGot += subTotal;
                    totalMax += subMax;
                    if (subMax > 0 && (subTotal / subMax) * 100 < 33) {
                        isFail = true;
                    }
                });
                
                const percentage = totalMax > 0 ? (totalGot / totalMax) * 100 : 0;
                const finalResult = isFail ? 'FAIL' : 'PASS';
                const grade = calculateGrade(percentage);

                summaryContainer.innerHTML = `
                    <strong>Total:</strong> ${totalGot} / ${totalMax} | 
                    <strong>Percentage:</strong> ${percentage.toFixed(2)}% | 
                    <strong>Grade:</strong> ${grade} | 
                    <strong>Result:</strong> <span style="font-weight:bold; color: ${isFail ? 'var(--error-color)' : 'var(--success-color)'}">${finalResult}</span>
                `;
                summaryContainer.style.display = 'block';
            }

            function handleSaveUploadedResult(studentId) {
                const examMasterId = getEl('result-upload-exam').value;
                if (!examMasterId) return showToast('Please select an exam.', 'error');
                
                const marksData = [];
                const rows = getEl('result-upload-marks-table').querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const subject = row.cells[0].textContent;
                    const theoryMax = parseInt(row.querySelector('[data-type="theoryMax"]').value) || 0;
                    const theoryGot = parseInt(row.querySelector('[data-type="theoryGot"]').value) || 0;
                    const practicalMax = parseInt(row.querySelector('[data-type="practicalMax"]').value) || 0;
                    const practicalGot = parseInt(row.querySelector('[data-type="practicalGot"]').value) || 0;
                    
                    marksData.push({ subject, theoryMax, theoryGot, practicalMax, practicalGot });
                });

                if (!state.data.marks[examMasterId]) state.data.marks[examMasterId] = {};
                state.data.marks[examMasterId][studentId] = marksData;
                saveData();
                showToast('Result saved successfully!', 'success');
                getEl('result-upload-form-container').innerHTML = `<p class="form-feedback success">Result has been uploaded for the student.</p>`;
            }

            // UTILITY AND EVENT LISTENERS
            window.findById = (key, id) => (state.data[key] || []).find(item => item.id == id);
            window.updateOrAddItem = (key, item) => { const items = state.data[key] || []; const index = items.findIndex(i => i.id == item.id); if (index > -1) items[index] = item; else items.push(item); state.data[key] = items; saveData(); };
            window.deleteItem = (key, id, message, callback) => { if (confirm(message || 'Are you sure?')) { state.data[key] = (state.data[key] || []).filter(item => item.id != id); saveData(); showToast('Item deleted.', 'success'); if (callback) callback(); } };
            window.closeModal = () => { if(html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => {}); } getEl('modal-container').innerHTML = ''; };
            window.showToast = (message, type = 'success') => { const toastContainer = getEl('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'; toast.innerHTML = `<i class="fas ${iconClass}" style="margin-right:10px;"></i> ${message}`; toastContainer.appendChild(toast); setTimeout(() => toast.remove(), 5000); };
            window.fileToBase64 = (file) => new Promise((resolve, reject) => { if(!file) resolve(null); const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
            
            window.printContent = (selector) => {
                const printableElement = document.querySelector(selector);
                if (!printableElement) return;

                const printableContentDiv = document.querySelector('.printable-content');
                
                printableContentDiv.innerHTML = '';
                
                const wasLightTheme = document.body.classList.contains('light-theme');
                document.body.classList.add('light-theme');

                const contentToPrint = printableElement.cloneNode(true);
                
                if (contentToPrint.classList.contains('attendance-report')) {
                    contentToPrint.querySelectorAll('select.attendance-select').forEach(select => {
                        const td = select.parentElement;
                        let text = '-';
                        if (select.value === 'present') text = 'P';
                        else if (select.value === 'absent') text = 'A';
                        td.innerHTML = text;
                    });
                }
                
                printableContentDiv.appendChild(contentToPrint);

                setTimeout(() => {
                    window.print();
                    if (!wasLightTheme) {
                        document.body.classList.remove('light-theme');
                    }
                }, 250);
            };

            window.addEventListener('beforeprint', () => {
                document.body.style.visibility = 'hidden';
                const printableContentDiv = document.querySelector('.printable-content');
                printableContentDiv.style.visibility = 'visible';
            });
            
            window.addEventListener('afterprint', () => {
                document.body.style.visibility = 'visible';
                const printableContentDiv = document.querySelector('.printable-content');
                printableContentDiv.innerHTML = '';
            });

            const toggleSidebar = () => { if (window.innerWidth <= 768) { document.body.classList.toggle('sidebar-open'); } else { const appContainer = getEl('app-container'); appContainer.classList.toggle('sidebar-collapsed'); localStorage.setItem('sidebarCollapsed', appContainer.classList.contains('sidebar-collapsed')); } };
            const initSidebarState = () => { if (window.innerWidth > 768 && localStorage.getItem('sidebarCollapsed') === 'true') getEl('app-container').classList.add('sidebar-collapsed'); };
            document.addEventListener('click', (event) => { if (window.innerWidth <= 768 && document.body.classList.contains('sidebar-open')) { const sidebar = getEl('sidebar'); const menuToggle = document.querySelector('.menu-toggle'); if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) { document.body.classList.remove('sidebar-open'); } } });
            const changeTheme = (theme) => { document.body.classList.remove('light-theme', 'dark-theme'); document.body.classList.add(theme + '-theme'); localStorage.setItem('theme', theme); renderUI(); };
            const initTheme = () => { const savedTheme = localStorage.getItem('theme') || 'dark'; document.body.classList.remove('light-theme', 'dark-theme'); document.body.classList.add(savedTheme + '-theme'); };
            const toggleThemeMode = () => { const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light'; changeTheme(newTheme);};
            const changeFontWeight = (e) => { const weight = e.target.value; document.body.classList.remove('font-weight-light', 'font-weight-normal', 'font-weight-bold'); document.body.classList.add(`font-weight-${weight}`); localStorage.setItem('fontWeight', weight); };
            const initFontWeight = () => { const savedWeight = localStorage.getItem('fontWeight') || 'normal'; document.body.classList.add(`font-weight-${savedWeight}`); };
            const hexToRgb = (hex) => { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; };
            const changeAccentColor = (colorName) => { const colors = config.accentColors[colorName]; if (!colors) return; const root = document.documentElement; root.style.setProperty('--primary-color', colors.primary); root.style.setProperty('--primary-light', colors.light); root.style.setProperty('--primary-gradient', `linear-gradient(45deg, ${colors.primary}, ${colors.light})`); const rgb = hexToRgb(colors.light); if (rgb) { root.style.setProperty('--glow-color', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.4)`); root.style.setProperty('--glow-color-hover', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.6)`); } };
            const cycleAccentColor = () => { const colorKeys = Object.keys(config.accentColors); let currentIndex = parseInt(localStorage.getItem('themeAccentIndex') || '0'); currentIndex = (currentIndex + 1) % colorKeys.length; const newColorName = colorKeys[currentIndex]; changeAccentColor(newColorName); localStorage.setItem('themeAccentIndex', currentIndex.toString()); renderUI(); };
            const initAccentColor = () => { const colorKeys = Object.keys(config.accentColors); const savedIndex = parseInt(localStorage.getItem('themeAccentIndex') || '0'); const validIndex = (savedIndex >= 0 && savedIndex < colorKeys.length) ? savedIndex : 0; const savedColorName = colorKeys[validIndex]; changeAccentColor(savedColorName); };
            const getMonthlyFinancialData = () => { const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]; const incomeByMonth = {}; const expenseByMonth = {}; (state.data.transactions || []).forEach(t => { const month = new Date(t.date).getMonth(); incomeByMonth[month] = (incomeByMonth[month] || 0) + Number(t.amount); }); (state.data.expenses || []).forEach(e => { const month = new Date(e.date).getMonth(); expenseByMonth[month] = (expenseByMonth[month] || 0) + Number(e.amount); }); const labels = [], income = [], expense = []; const currentMonth = new Date().getMonth(); for (let i = 0; i < 12; i++) { labels.push(monthNames[i]); income.push(incomeByMonth[i] || 0); expense.push(expenseByMonth[i] || 0); } let currentMonthIncome = (incomeByMonth[currentMonth] || 0).toLocaleString(); return { labels, income, expense, currentMonthIncome }; };
             const startClock = () => {
                const clockEl = getEl('real-time-clock');
                if(!clockEl) return;
                function updateClock() {
                    const clockEl = getEl('real-time-clock');
                    if (clockEl) {
                        const now = new Date();
                        clockEl.textContent = now.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', second: '2-digit'});
                    }
                }
                updateClock();
                setInterval(updateClock, 1000);
            };
           
            window.navigate = navigate;
            window.renderStudentTable = renderStudentTable;
            window.showStudentForm = showStudentForm;
            window.showNoteForm = showNoteForm;
            window.showPaymentForm = showPaymentForm;
            window.showFeeReceipt = showFeeReceipt;
            window.showDocumentUploadForm = showDocumentUploadForm;
            window.deleteDocument = deleteDocument;
            window.showRegisterModal = showRegisterModal;
            window.showLoginModal = showLoginModal;
            window.cycleAccentColor = cycleAccentColor;
            window.toggleThemeMode = toggleThemeMode;
            window.showGalleryForm = showGalleryForm;
            window.renderGalleryGrid = renderGalleryGrid;
            window.renderAttendanceSheet = renderAttendanceSheet;
            window.saveAttendance = saveAttendance;
            window.showInquiryForm = showInquiryForm;
            window.renderInquiriesTable = renderInquiriesTable;
            window.showExpenseForm = showExpenseForm;
            window.renderExpensesPage = renderExpensesPage;
            window.showNoticeForm = showNoticeForm;
            window.renderNoticesTable = renderNoticesTable;
            window.showTeacherForm = showTeacherForm;
            window.renderTeacherTable = renderTeacherTable;
            window.showStaffForm = showStaffForm;
            window.renderStaffTable = renderStaffTable;
            window.showAdmissionForm = showAdmissionForm;
            window.handleAdmissionSubmit = handleAdmissionSubmit;
            window.finalizeAdmission = finalizeAdmission;
            window.showIdCard = showIdCard;
            window.renderVideosPage = renderVideosPage;
            window.renderVideosGrid = renderVideosGrid;
            window.showVideoForm = showVideoForm;
            window.renderCertificateStudentList = renderCertificateStudentList;
            window.showCertificateGenerationModal = showCertificateGenerationModal;
            window.renderTeacherAttendancePage = renderTeacherAttendancePage;
            window.renderStaffAttendancePage = renderStaffAttendancePage;
            window.showTimetableForm = showTimetableForm;
            window.renderTimetableGrid = renderTimetableGrid;
            window.showExamMasterForm = showExamMasterForm;
            window.renderExamMastersTable = renderExamMastersTable;
            window.showExamScheduleForm = showExamScheduleForm;
            window.renderExamScheduleTable = renderExamScheduleTable;
            window.deleteExamMaster = deleteExamMaster;
            window.renderExamScheduleView = renderExamScheduleView;
            window.showTeacherIdCard = showTeacherIdCard;
            window.showStaffIdCard = showStaffIdCard;
            window.displayMonthlyAttendanceReport = displayMonthlyAttendanceReport;
            window.renderPromotionStudentList = renderPromotionStudentList;
            window.handleStudentPromotion = handleStudentPromotion;
            window.showUnifiedScanner = showUnifiedScanner;
            window.lookupStudent = lookupStudent;
            window.showForgotPasswordModal = showForgotPasswordModal;
            window.showAdmitCard = showAdmitCard;
            window.renderAdmitCardPortalPage = renderAdmitCardPortalPage;
            window.renderMarksheetManagerPage = renderMarksheetManagerPage;
            window.renderMarksEntryTable = renderMarksEntryTable;
            window.handleSaveMarks = handleSaveMarks;
            window.showMarksheet = showMarksheet;
            window.handleFindResult = handleFindResult;
            window.renderHomeworkTable = renderHomeworkTable;
            window.showHomeworkForm = showHomeworkForm;
            window.renderEventsTable = renderEventsTable;
            window.showEventForm = showEventForm;
            window.renderBookTable = renderBookTable;
            window.showBookForm = showBookForm;
            window.renderIssuedBooksTable = renderIssuedBooksTable;
            window.handleIssueBook = handleIssueBook;
            window.handleReturnBook = handleReturnBook;
            window.renderPublicProfileSearchPage = renderPublicProfileSearchPage;
            window.lookupTopperStudent = lookupTopperStudent;
            window.addManualTopper = addManualTopper;
            window.removeManualTopper = removeManualTopper;
            window.showSchoolPhotoForm = showSchoolPhotoForm;
            window.renderSchoolPhotosList = renderSchoolPhotosList;
            window.lookupResultStudent = lookupResultStudent;
            window.showResultUploadForm = showResultUploadForm;
            window.renderResultSubjects = renderResultSubjects;
            window.handleSaveUploadedResult = handleSaveUploadedResult;
            window.showLinkForm = showLinkForm;
            window.renderLinksList = renderLinksList;

            checkAuth();
        });
           
    </script>
</body>
</html>
```